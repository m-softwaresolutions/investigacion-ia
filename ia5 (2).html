<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gene Factory AI - Control Din√°mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #0e3529 50%, #0f172a 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        #evolution-canvas,
        #combinedCanvas {
            cursor: crosshair;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .stat-card {
            backdrop-filter: blur(16px);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
        }

        .btn {
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(180deg, #10b981, #059669);
            color: #fff;
            border: 1px solid rgba(16, 185, 129, 0.55);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25) inset, 0 6px 18px rgba(16, 185, 129, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(180deg, #34d399, #10b981);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.85);
            color: #e2e8f0;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .btn-secondary:hover {
            background: rgba(30, 41, 59, 0.85);
        }

        .btn-outline {
            background: rgba(2, 6, 23, 0.6);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.5);
        }

        .btn-outline:hover {
            background: rgba(16, 185, 129, 0.12);
            color: #14b8a6;
        }

        .btn-accent {
            background: linear-gradient(180deg, #f59e0b, #d97706);
            color: #fff;
            border: 1px solid rgba(245, 158, 11, 0.55);
            box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.25) inset, 0 6px 18px rgba(245, 158, 11, 0.25);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .resource-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-programmer {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .type-mathematician {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            border: 1px solid #60a5fa;
        }

        .type-social {
            background: rgba(244, 114, 182, 0.2);
            color: #f472b6;
            border: 1px solid #f472b6;
        }

        /* Estilos para sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: rgba(139, 92, 246, 0.3);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
        }

        #creature-list {
            min-height: 0;
            max-height: 100%;
            overflow-y: auto;
            overscroll-behavior: contain;
        }

        #selected-panel-container {
            min-height: 0;
        }

        .list-panel {
            min-height: 0;
        }

        .control-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .preset-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .preset-aggressive {
            background: #ef4444;
            color: white;
        }

        .preset-aggressive:hover {
            background: #dc2626;
        }

        .preset-balanced {
            background: #f59e0b;
            color: white;
        }

        .preset-balanced:hover {
            background: #d97706;
        }

        .preset-cooperative {
            background: #10b981;
            color: white;
        }

        .preset-cooperative:hover {
            background: #059669;
        }

        .brand-hero {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            border: 1px solid rgba(16, 185, 129, 0.25);
            background:
                radial-gradient(1200px 400px at 50% -20%, rgba(16, 185, 129, 0.25), transparent 60%),
                radial-gradient(900px 300px at 50% 120%, rgba(16, 185, 129, 0.15), transparent 60%),
                linear-gradient(180deg, rgba(2, 6, 23, 0.9), rgba(2, 6, 23, 0.7));
        }

        .brand-hero .glow {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 140px;
            filter: blur(32px);
            background: radial-gradient(circle, rgba(16, 185, 129, 0.35), transparent 60%);
            pointer-events: none;
        }

        .brand-icon {
            width: 56px;
            height: 56px;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(16, 185, 129, 0.35);
            background: rgba(2, 6, 23, 0.6);
            color: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.25) inset, 0 0 8px rgba(16, 185, 129, 0.15);
        }

        .brand-icon:hover {
            background: rgba(16, 185, 129, 0.12);
        }

        /* Custom Scrollbar Styling */
        .custom-scrollbar::-webkit-scrollbar,
        #creature-list::-webkit-scrollbar,
        #inspector-logs::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track,
        #creature-list::-webkit-scrollbar-track,
        #inspector-logs::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb,
        #creature-list::-webkit-scrollbar-thumb,
        #inspector-logs::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b5cf6, #6366f1);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover,
        #creature-list::-webkit-scrollbar-thumb:hover,
        #inspector-logs::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #a78bfa, #818cf8);
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Glow Animation for Important Elements */
        @keyframes subtleGlow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(16, 185, 129, 0.3), 0 0 10px rgba(16, 185, 129, 0.1);
            }

            50% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.5), 0 0 25px rgba(16, 185, 129, 0.2);
            }
        }

        .glow-effect {
            animation: subtleGlow 3s ease-in-out infinite;
        }

        /* Memory Indicator Style */
        #memory-indicator {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        /* Improved Control Section */
        .control-slider-group {
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 8px;
        }

        .control-slider-group:hover {
            background: rgba(139, 92, 246, 0.08);
        }

        /* Wave Canvas Glow */
        #waveCanvas {
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(139, 92, 246, 0.1);
        }

        /* Portal Button Pulsing */
        @keyframes portalPulse {

            0%,
            100% {
                box-shadow: 0 0 10px #ff0055;
            }

            50% {
                box-shadow: 0 0 25px #ff0055, 0 0 40px rgba(255, 0, 85, 0.5);
            }
        }

        .portal-open {
            animation: portalPulse 1s ease-in-out infinite;
        }

        /* Improved Stat Card Hover */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s ease;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        /* Creature List Item Highlight */
        .creature-item-elite {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(30, 41, 59, 0.8)) !important;
            border-left: 3px solid #f59e0b !important;
        }

        /* Responsive Canvas Container */
        .canvas-container {
            position: relative;
            background: linear-gradient(135deg, rgba(10, 10, 15, 0.95), rgba(15, 23, 42, 0.9));
            border-radius: 16px;
            padding: 4px;
        }
    </style>
</head>

<body>
    <div class="min-h-screen p-4 sm:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Brand Hero -->
            <section class="brand-hero mb-6 p-6 sm:p-8">
                <div class="glow"></div>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6 relative">
                    <div>
                        <div class="flex items-center gap-3">
                            <span class="text-3xl sm:text-4xl font-extrabold text-emerald-400">{M}</span>
                            <h1 class="text-2xl sm:text-3xl font-bold text-white">Software Solutions</h1>
                        </div>
                        <p class="text-emerald-300/80 mt-1">Ingenier√≠a de Precisi√≥n</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="brand-icon"><i data-lucide="grid" class="w-6 h-6"></i></div>
                        <div class="brand-icon"><i data-lucide="chevrons-right" class="w-6 h-6"></i></div>
                        <div class="brand-icon"><i data-lucide="square" class="w-6 h-6"></i></div>
                        <div class="brand-icon"><i data-lucide="power" class="w-6 h-6"></i></div>
                    </div>
                </div>
            </section>
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2 flex items-center gap-3">
                    <i data-lucide="brain" class="text-emerald-400"></i>
                    Evoluci√≥n Gen√©tica - Control Din√°mico
                </h1>
                <p class="text-emerald-200">
                    <span class="type-badge type-programmer">üíª Programadores</span>
                    <span class="type-badge type-mathematician">üìê Matem√°ticos</span>
                    <span class="type-badge type-social">üó£Ô∏è Sociales</span>
                </p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
                <div class="stat-card bg-slate-800/50 rounded-lg p-4 border border-purple-500/20">
                    <div class="text-purple-300 text-xs mb-1">Generaci√≥n</div>
                    <div id="generation-display" class="text-2xl font-bold text-white">1</div>
                </div>
                <div class="stat-card bg-slate-800/50 rounded-lg p-4 border border-green-500/20">
                    <div class="text-green-300 text-xs mb-1">Mejor Fitness</div>
                    <div id="best-fitness-display" class="text-2xl font-bold text-white">0.0%</div>
                </div>
                <div class="stat-card bg-slate-800/50 rounded-lg p-4 border border-blue-500/20">
                    <div class="text-blue-300 text-xs mb-1">Promedio</div>
                    <div id="avg-fitness-display" class="text-2xl font-bold text-white">0.0%</div>
                </div>
                <div class="stat-card bg-slate-800/50 rounded-lg p-4 border border-green-400/20">
                    <div class="text-green-300 text-xs mb-1 flex items-center gap-1">
                        <i data-lucide="code" class="w-3 h-3"></i> Programadores
                    </div>
                    <div id="prog-count" class="text-2xl font-bold text-white">0</div>
                </div>
                <div class="stat-card bg-slate-800/50 rounded-lg p-4 border border-blue-400/20">
                    <div class="text-blue-300 text-xs mb-1 flex items-center gap-1">
                        <i data-lucide="calculator" class="w-3 h-3"></i> Matem√°ticos
                    </div>
                    <div id="math-count" class="text-2xl font-bold text-white">0</div>
                </div>
                <div class="stat-card bg-slate-800/50 rounded-lg p-4 border border-pink-400/20">
                    <div class="text-pink-300 text-xs mb-1 flex items-center gap-1">
                        <i data-lucide="users" class="w-3 h-3"></i> Sociales
                    </div>
                    <div id="social-count" class="text-2xl font-bold text-white">0</div>
                </div>
            </div>

            <!-- PANEL DE CONTROL DE AMBIENTE -->
            <div class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-white font-bold text-lg flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5 text-purple-400"></i>
                        üéõÔ∏è Control de Ambiente
                    </h3>
                    <button
                        onclick="document.getElementById('controls-panel').style.display = document.getElementById('controls-panel').style.display === 'none' ? 'block' : 'none'"
                        class="text-purple-300 hover:text-purple-100 text-sm px-2 py-1 bg-slate-700 rounded">
                        üîΩ Toggle
                    </button>
                </div>

                <div id="controls-panel">
                    <!-- Presets R√°pidos -->
                    <div class="control-section">
                        <h4 class="text-white font-semibold text-sm mb-3">‚ö° Presets R√°pidos</h4>
                        <div class="flex gap-2">
                            <button onclick="applyPreset('aggressive')" class="preset-btn preset-aggressive">
                                üî• Agresivo
                            </button>
                            <button onclick="applyPreset('balanced')" class="preset-btn preset-balanced">
                                ‚öñÔ∏è Balanceado
                            </button>
                            <button onclick="applyPreset('cooperative')" class="preset-btn preset-cooperative">
                                ü§ù Cooperativo
                            </button>
                        </div>
                    </div>

                    <!-- Poblaci√≥n y Recursos -->
                    <div class="control-section">
                        <h4 class="text-white font-semibold text-sm mb-3">üë• Poblaci√≥n y Recursos</h4>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Poblaci√≥n Inicial</span>
                                    <button type="button" onclick="toggleOptionHelp('help-pop')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="pop-value" class="text-purple-300 font-mono">300</span>
                            </label>
                            <div id="help-pop" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Poblaci√≥n Inicial</span>
                                        <button type="button" onclick="toggleOptionHelp('help-pop')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Ajusta el tama√±o de la poblaci√≥n al iniciar. Valores altos impactan CPU.</p>
                                </div>
                            </div>
                            <input type="range" id="population-slider" min="30" max="300" value="300" step="5"
                                oninput="updateConfig('initialPopulation', this.value, 'pop-value')">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Recursos M√≠nimos</span>
                                    <button type="button" onclick="toggleOptionHelp('help-res')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="res-value" class="text-purple-300 font-mono">45</span>
                            </label>
                            <div id="help-res" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Recursos M√≠nimos</span>
                                        <button type="button" onclick="toggleOptionHelp('help-res')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Controla cu√°ntos recursos se mantienen disponibles. Afecta supervivencia.</p>
                                </div>
                            </div>
                            <input type="range" id="resources-slider" min="10" max="100" value="45" step="5"
                                oninput="updateConfig('minResources', this.value, 'res-value')">
                        </div>
                    </div>

                    <!-- Energ√≠a y Supervivencia -->
                    <div class="control-section">
                        <h4 class="text-white font-semibold text-sm mb-3">‚ö° Energ√≠a y Supervivencia</h4>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Decay de Energ√≠a (por paso)</span>
                                    <button type="button" onclick="toggleOptionHelp('help-decay')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="decay-value" class="text-purple-300 font-mono">0.25</span>
                            </label>
                            <div id="help-decay" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Decay de Energ√≠a</span>
                                        <button type="button" onclick="toggleOptionHelp('help-decay')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Consumo de energ√≠a por paso. Mayor valor acelera desgaste.</p>
                                </div>
                            </div>
                            <input type="range" id="decay-slider" min="0.1" max="1.0" value="0.25" step="0.05"
                                oninput="updateConfig('energyDecayPerStep', this.value, 'decay-value', true)">
                            <div class="text-xs text-gray-500 mt-1">‚Üê Menos agresivo | M√°s agresivo ‚Üí</div>
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Energ√≠a por Recurso (m√≠nima)</span>
                                    <button type="button" onclick="toggleOptionHelp('help-energy-min')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="energy-min-value" class="text-purple-300 font-mono">8</span>
                            </label>
                            <div id="help-energy-min" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Energ√≠a m√≠nima</span>
                                        <button type="button" onclick="toggleOptionHelp('help-energy-min')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Energ√≠a m√≠nima que entrega cada recurso consumido.</p>
                                </div>
                            </div>
                            <input type="range" id="energy-min-slider" min="2" max="20" value="8" step="1"
                                oninput="updateEnergyRange('min', this.value)">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Energ√≠a por Recurso (m√°xima)</span>
                                    <button type="button" onclick="toggleOptionHelp('help-energy-max')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="energy-max-value" class="text-purple-300 font-mono">20</span>
                            </label>
                            <div id="help-energy-max" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Energ√≠a m√°xima</span>
                                        <button type="button" onclick="toggleOptionHelp('help-energy-max')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Energ√≠a m√°xima que puede otorgar un recurso.</p>
                                </div>
                            </div>
                            <input type="range" id="energy-max-slider" min="10" max="40" value="20" step="2"
                                oninput="updateEnergyRange('max', this.value)">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Energ√≠a de Rescate</span>
                                    <button type="button" onclick="toggleOptionHelp('help-rescue')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="rescue-value" class="text-purple-300 font-mono">80</span>
                            </label>
                            <div id="help-rescue" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Energ√≠a de Rescate</span>
                                        <button type="button" onclick="toggleOptionHelp('help-rescue')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Energ√≠a que se otorga si la poblaci√≥n entra en colapso.</p>
                                </div>
                            </div>
                            <input type="range" id="rescue-slider" min="20" max="150" value="80" step="10"
                                oninput="updateConfig('rescueEnergyIfAllDead', this.value, 'rescue-value')">
                        </div>
                    </div>

                    <!-- Cooperaci√≥n -->
                    <div class="control-section">
                        <h4 class="text-white font-semibold text-sm mb-3">ü§ù Cooperaci√≥n</h4>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Bonus de Cooperaci√≥n</span>
                                    <button type="button" onclick="toggleOptionHelp('help-coop-bonus')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="coop-bonus-value" class="text-purple-300 font-mono">0.08</span>
                            </label>
                            <div id="help-coop-bonus" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Bonus de Cooperaci√≥n</span>
                                        <button type="button" onclick="toggleOptionHelp('help-coop-bonus')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Incremento de fitness por criaturas cercanas colaborando.</p>
                                </div>
                            </div>
                            <input type="range" id="coop-bonus-slider" min="0" max="0.2" value="0.08" step="0.01"
                                oninput="updateConfig('cooperationBonus', this.value, 'coop-bonus-value', true)">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Radio de Cooperaci√≥n</span>
                                    <button type="button" onclick="toggleOptionHelp('help-coop-radius')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="coop-radius-value" class="text-purple-300 font-mono">50</span>
                            </label>
                            <div id="help-coop-radius" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Radio de Cooperaci√≥n</span>
                                        <button type="button" onclick="toggleOptionHelp('help-coop-radius')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Distancia m√°xima para detectar vecinos cooperantes.</p>
                                </div>
                            </div>
                            <input type="range" id="coop-radius-slider" min="20" max="100" value="50" step="5"
                                oninput="updateConfig('cooperationRadius', this.value, 'coop-radius-value')">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Tasa de Compartir Energ√≠a</span>
                                    <button type="button" onclick="toggleOptionHelp('help-share')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="share-value" class="text-purple-300 font-mono">0.02</span>
                            </label>
                            <div id="help-share" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Compartir Energ√≠a</span>
                                        <button type="button" onclick="toggleOptionHelp('help-share')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Porcentaje de energ√≠a que se transfiere entre vecinos.</p>
                                </div>
                            </div>
                            <input type="range" id="share-slider" min="0" max="0.1" value="0.02" step="0.01"
                                oninput="updateConfig('energyShareRate', this.value, 'share-value', true)">
                        </div>
                    </div>

                    <!-- Evoluci√≥n -->
                    <div class="control-section">
                        <h4 class="text-white font-semibold text-sm mb-3">üß¨ Evoluci√≥n</h4>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>% Supervivientes</span>
                                    <button type="button" onclick="toggleOptionHelp('help-survival')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="survival-value" class="text-purple-300 font-mono">40%</span>
                            </label>
                            <div id="help-survival" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">% Supervivientes</span>
                                        <button type="button" onclick="toggleOptionHelp('help-survival')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Porcentaje de la poblaci√≥n que sobrevive a cada evoluci√≥n.</p>
                                </div>
                            </div>
                            <input type="range" id="survival-slider" min="20" max="60" value="40" step="5"
                                oninput="updateConfig('survivalRate', this.value, 'survival-value', false, '%')">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Frecuencia de Evoluci√≥n (pasos)</span>
                                    <button type="button" onclick="toggleOptionHelp('help-evo-freq')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="evo-freq-value" class="text-purple-300 font-mono">250</span>
                            </label>
                            <div id="help-evo-freq" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Frecuencia de Evoluci√≥n</span>
                                        <button type="button" onclick="toggleOptionHelp('help-evo-freq')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Intervalo de pasos entre procesos de evoluci√≥n.</p>
                                </div>
                            </div>
                            <input type="range" id="evo-freq-slider" min="100" max="500" value="250" step="50"
                                oninput="updateConfig('evolutionFrequency', this.value, 'evo-freq-value')">
                        </div>
                    </div>

                    <!-- Eventos -->
                    <div class="control-section">
                        <h4 class="text-white font-semibold text-sm mb-3">üå™Ô∏è Eventos Ambientales</h4>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Frecuencia Eventos (pasos)</span>
                                    <button type="button" onclick="toggleOptionHelp('help-event-freq')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="event-freq-value" class="text-purple-300 font-mono">300</span>
                            </label>
                            <div id="help-event-freq" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Frecuencia de Eventos</span>
                                        <button type="button" onclick="toggleOptionHelp('help-event-freq')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Intervalo de pasos entre eventos ambientales.</p>
                                </div>
                            </div>
                            <input type="range" id="event-freq-slider" min="100" max="600" value="300" step="50"
                                oninput="updateConfig('eventFrequency', this.value, 'event-freq-value')">
                        </div>

                        <div class="mb-3">
                            <label class="text-gray-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Frecuencia Cat√°strofes (pasos)</span>
                                    <button type="button" onclick="toggleOptionHelp('help-cata-freq')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-slate-700 text-white hover:bg-slate-600">?</button>
                                </span>
                                <span id="cata-freq-value" class="text-purple-300 font-mono">3000</span>
                            </label>
                            <div id="help-cata-freq" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-800 border border-slate-600 rounded text-xs text-gray-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-purple-300">Frecuencia de Cat√°strofes</span>
                                        <button type="button" onclick="toggleOptionHelp('help-cata-freq')"
                                            class="px-2 rounded bg-slate-700 text-white hover:bg-slate-600">√ó</button>
                                    </div>
                                    <p>Intervalo entre eventos que reducen poblaci√≥n seg√∫n fitness.</p>
                                </div>
                            </div>
                            <input type="range" id="cata-freq-slider" min="1000" max="5000" value="3000" step="500"
                                oninput="updateConfig('catastropheFrequency', this.value, 'cata-freq-value')">
                        </div>

                        <!-- Invasion Controls -->
                        <div class="mb-3 pt-3 border-t border-red-900/30">
                            <label class="text-red-300 text-xs flex justify-between mb-1">
                                <span class="flex items-center gap-2">
                                    <span>Frecuencia Invasi√≥n</span>
                                    <button type="button" onclick="toggleOptionHelp('help-inv-freq')"
                                        class="w-5 h-5 flex items-center justify-center rounded bg-red-900/60 text-red-300 hover:bg-red-800">?</button>
                                </span>
                                <span id="inv-freq-value" class="text-red-400 font-mono">2000</span>
                            </label>
                            <div id="help-inv-freq" style="display:none" class="relative">
                                <div
                                    class="absolute right-0 mt-1 w-64 p-2 bg-slate-900 border border-red-600 rounded text-xs text-red-200 shadow-xl z-50">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-semibold text-red-300">Frecuencia de Invasi√≥n</span>
                                        <button type="button" onclick="toggleOptionHelp('help-inv-freq')"
                                            class="px-2 rounded bg-red-900 text-white hover:bg-red-700">√ó</button>
                                    </div>
                                    <p>Cada cu√°ntos pasos se abre la puerta del submundo.</p>
                                </div>
                            </div>
                            <input type="range" id="inv-freq-slider" min="500" max="5000" value="2000" step="100"
                                oninput="updateConfig('invasionFrequency', this.value, 'inv-freq-value')">

                            <button id="portal-btn" onclick="togglePortal()"
                                class="w-full mt-2 py-1 px-2 bg-red-900/20 hover:bg-red-900/40 border border-red-500/50 rounded text-red-400 text-xs font-mono uppercase transition-all">
                                üîí Portal Cerrado
                            </button>
                        </div>
                    </div>

                    <!-- Indicador de Estado -->
                    <div class="mt-4 p-3 bg-purple-900/20 rounded-lg border border-purple-500/30">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="info" class="w-4 h-4 text-purple-400"></i>
                            <span class="text-purple-300 text-sm font-semibold">Estado del Ambiente</span>
                        </div>
                        <div id="environment-status" class="text-white text-sm">
                            Modo: <span id="mode-indicator" class="font-bold text-green-400">Cooperativo</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Canvas Area -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2">
                    <div class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <h3 class="text-white font-semibold">Ecosistema Evolutivo</h3>
                                <button
                                    onclick="document.getElementById('evolution-canvas').style.display = document.getElementById('evolution-canvas').style.display === 'none' ? 'block' : 'none'"
                                    class="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-purple-300 rounded">
                                    üîΩ Toggle Canvas
                                </button>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="resource-indicator px-2 py-1 rounded bg-green-900/30 text-green-400">üü¢
                                    C√≥digo</span>
                                <span class="resource-indicator px-2 py-1 rounded bg-blue-900/30 text-blue-400">üîµ
                                    Ecuaciones</span>
                                <span class="resource-indicator px-2 py-1 rounded bg-pink-900/30 text-pink-400">üü£
                                    Interacciones</span>
                            </div>
                        </div>
                        <canvas id="evolution-canvas" width="800" height="600" class="w-full"></canvas>
                    </div>
                </div>

                <div>
                    <div id="selected-panel-container"
                        class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20 h-full">
                        <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                            <i data-lucide="info" class="w-5 h-5 text-purple-400"></i>
                            Informaci√≥n del Gen
                        </h3>
                        <div id="selected-panel-content" class="text-gray-400 text-sm">
                            Haz clic en un bichito para ver sus detalles.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-wrap gap-3 items-center mb-6">
                <button id="play-pause-button"
                    class="btn btn-primary flex items-center gap-2 px-6 py-3 rounded-lg font-semibold">
                    <i id="play-pause-icon" data-lucide="play" class="w-5 h-5"></i>
                    <span id="play-pause-text">Iniciar</span>
                </button>
                <button id="reset-button"
                    class="btn btn-secondary flex items-center gap-2 px-6 py-3 rounded-lg font-semibold">
                    <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    Reiniciar
                </button>
            </div>

            <!-- Communication Panel -->
            <div class="mt-4 bg-slate-900/80 rounded-lg p-4 border border-cyan-500/30">
                <h3 class="text-cyan-400 font-bold mb-3 flex items-center gap-2">
                    <i data-lucide="radio" class="w-5 h-5"></i>
                    Canal de Comunicaci√≥n Bidireccional
                </h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Audio Input -->
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">Entrada de Audio (Ambiente)</label>
                        <button id="mic-btn" onclick="toggleMicrophone()"
                            class="w-full h-10 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-white rounded border border-slate-600 transition-all">
                            <i data-lucide="mic-off" class="w-4 h-4"></i>
                            <span id="mic-status">Activar Micr√≥fono</span>
                        </button>
                    </div>
                    <!-- Text Input -->
                    <div class="flex-[2] flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-400 mb-1">Enviar Mensaje (Comando)</label>
                            <input type="text" id="comm-input" placeholder="Ej: 'recursos', 'calma', 'peligro'..."
                                class="w-full h-10 px-3 bg-slate-800 border border-slate-600 rounded text-white focus:border-cyan-500 focus:outline-none"
                                onkeydown="if(event.key === 'Enter') sendCommand()">
                        </div>
                        <div class="flex flex-col justify-end">
                            <button onclick="sendCommand()"
                                class="h-10 px-4 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-bold transition-all">
                                Enviar
                            </button>
                        </div>
                    </div>
                </div>
                <div id="comm-feedback" class="mt-2 text-xs font-mono text-cyan-300 h-4"></div>
            </div>
            <!-- Control & Export Hub -->
            <div
                class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center mb-6 bg-slate-800/60 p-4 rounded-lg border border-slate-700">
                <!-- Action Buttons -->
                <div class="flex gap-3 justify-center md:justify-start">
                    <button id="evolve-now-button"
                        class="btn btn-primary flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold shadow-lg shadow-purple-900/20">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                        Evolucionar Ahora
                    </button>
                    <button onclick="toggleHelpModal()"
                        class="btn btn-outline px-3 py-2 rounded-lg font-semibold text-sm"
                        title="Informaci√≥n de Par√°metros">
                        <i data-lucide="info" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Export Zone -->
                <div class="flex flex-wrap gap-2 justify-center md:justify-end">
                    <span class="w-full text-center md:text-right text-xs text-gray-400 mb-1 lg:hidden">Exportar:</span>

                    <!-- Neural Model Export (NEW) -->
                    <button onclick="exportBestBrain()"
                        class="btn btn-accent flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white border-0 shadow-lg shadow-orange-900/20"
                        title="Exportar Mejor Cerebro como Modelo JSON para uso externo">
                        <i data-lucide="brain-circuit" class="w-4 h-4"></i>
                        Modelo Neuronal
                    </button>

                    <!-- Swarm Export (NEW) -->
                    <button onclick="exportSwarm()"
                        class="btn btn-accent flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 text-white border-0 shadow-lg shadow-fuchsia-900/20"
                        title="Exportar ENJAMBRE COMPLETO (Todos los agentes)">
                        <i data-lucide="boxes" class="w-4 h-4"></i>
                        Colmena
                    </button>

                    <!-- Simulation Data Exports -->
                    <div class="flex rounded-lg overflow-hidden border border-slate-600">
                        <button onclick="downloadJSON()"
                            class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 text-xs font-mono transition-colors border-r border-slate-600"
                            title="Estado Simulaci√≥n (JSON)">
                            üì¶ SIM.JSON
                        </button>
                        <button onclick="downloadMarkdown()"
                            class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 text-xs font-mono transition-colors border-r border-slate-600"
                            title="Informe Humano (MD)">
                            üìÑ REPORT.MD
                        </button>
                        <button onclick="showManifest()"
                            class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 text-xs font-mono transition-colors"
                            title="Ver en Consola">
                            console.log
                        </button>
                    </div>
                </div>
            </div>
            <div class="relative">
                <button onclick="toggleBrainMarkMenu()"
                    class="btn btn-accent flex items-center gap-2 px-4 py-3 rounded-lg font-semibold text-sm"
                    title="BrainMark - Benchmark de IA">
                    <i data-lucide="flask-conical" class="w-4 h-4"></i>
                    üß™ BrainMark
                </button>
                <div id="brainmark-menu"
                    class="hidden absolute bottom-full left-0 mb-2 bg-slate-800 border border-amber-500/30 rounded-lg p-2 shadow-xl z-50 min-w-[200px]">
                    <div class="text-amber-400 text-xs font-bold mb-2 px-2">üìä Selecciona Nivel:</div>
                    <button onclick="openBrainMarkLevel(1)"
                        class="brainmark-level-btn w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm text-white">
                        <span class="level-icon">1Ô∏è‚É£</span> OBSERVACI√ìN <span id="bm-status-1"
                            class="text-green-400">üîì</span>
                    </button>
                    <button onclick="openBrainMarkLevel(2)"
                        class="brainmark-level-btn w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm text-gray-400">
                        <span class="level-icon">2Ô∏è‚É£</span> COMPRENSI√ìN <span id="bm-status-2"
                            class="text-red-400">üîí</span>
                    </button>
                    <button onclick="openBrainMarkLevel(3)"
                        class="brainmark-level-btn w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm text-gray-400">
                        <span class="level-icon">3Ô∏è‚É£</span> AN√ÅLISIS <span id="bm-status-3"
                            class="text-red-400">üîí</span>
                    </button>
                    <button onclick="openBrainMarkLevel(4)"
                        class="brainmark-level-btn w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm text-gray-400">
                        <span class="level-icon">4Ô∏è‚É£</span> PREDICCI√ìN <span id="bm-status-4"
                            class="text-red-400">üîí</span>
                    </button>
                    <button onclick="openBrainMarkLevel(5)"
                        class="brainmark-level-btn w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm text-gray-400">
                        <span class="level-icon">5Ô∏è‚É£</span> S√çNTESIS <span id="bm-status-5"
                            class="text-red-400">üîí</span>
                    </button>
                    <div class="border-t border-slate-600 mt-2 pt-2">
                        <button onclick="exportBrainMarkJSON()"
                            class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 text-sm text-amber-300">
                            üì§ Exportar para IA
                        </button>
                    </div>
                </div>
            </div>
            <label
                class="btn flex items-center gap-2 px-4 py-3 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-semibold text-sm cursor-pointer">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Cargar
                <input type="file" id="uploadFile" accept=".json" class="hidden" onchange="uploadJSON()">
            </label>
            <div class="flex items-center gap-3 ml-auto">
                <i data-lucide="activity" class="text-purple-400 w-5 h-5"></i>
                <span class="text-white font-semibold text-sm">Velocidad:</span>
                <input id="speed-slider" type="range" min="0.5" max="3" step="0.5" value="1" class="w-32">
                <span id="speed-display" class="text-purple-300 font-mono text-sm">1x</span>
            </div>
        </div>

        <!-- Network Canvas (Bio-Dashboard) -->
        <div class="mb-6">
            <div class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-white font-semibold flex items-center gap-2">
                        <i data-lucide="activity-square" class="w-5 h-5 text-purple-400"></i>
                        Bio-Dashboard & Ondas
                    </h3>
                    <div class="flex gap-2">
                        <button id="audio-btn" onclick="AUDIO_SYSTEM.toggle()"
                            class="btn btn-outline btn-sm rounded transition-all">
                            üîà Escuchar Conciencia
                        </button>
                        <button
                            onclick="document.getElementById('combinedCanvas').style.display = document.getElementById('combinedCanvas').style.display === 'none' ? 'block' : 'none'"
                            class="btn btn-outline btn-sm rounded">
                            üîΩ Toggle Dashboard
                        </button>
                    </div>
                </div>
                <canvas id="combinedCanvas" width="960" height="600"
                    class="w-full bg-[#0a0a0f] rounded border border-slate-700"></canvas>
            </div>
        </div>

        <!-- Creature Inspector Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 h-[600px]">
            <!-- List -->
            <div
                class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20 flex flex-col h-full list-panel">
                <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5 text-purple-400"></i>
                    Lista de Espec√≠menes
                </h3>
                <div id="creature-list" class="flex-1 overflow-y-auto space-y-1 pr-2 text-xs font-mono">
                    <!-- Items injected here -->
                </div>
            </div>

            <!-- Detail Panel (Replaces old side panel) -->
            <div
                class="lg:col-span-2 bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20 h-full overflow-hidden flex flex-col">
                <h3 class="text-white font-semibold mb-3 flex items-center gap-2">
                    <i data-lucide="search" class="w-5 h-5 text-purple-400"></i>
                    Inspector: <span id="inspector-id" class="text-gray-400">Selecciona un esp√©cimen</span>
                </h3>
                <div class="grid grid-cols-2 gap-4 flex-1 overflow-hidden">
                    <!-- Stats -->
                    <div id="inspector-stats" class="text-sm text-gray-300 space-y-2">
                        <p class="italic text-gray-500">Haz clic en la lista para ver detalles.</p>
                    </div>
                    <!-- Logs/Thoughts -->
                    <div
                        class="bg-black/40 rounded p-3 font-mono text-xs overflow-y-auto border border-green-900/30 flex flex-col">
                        <div class="text-green-500 font-bold mb-2 sticky top-0 bg-black/80 p-1">üß† Cortex Output
                            (Pensamientos/C√°lculos)</div>
                        <div id="inspector-logs" class="space-y-1 text-green-400/80">
                            <!-- Logs here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics -->
        <div class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-purple-500/20">
            <h3 class="text-purple-400 font-bold text-lg mb-3 flex items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                üìä M√©tricas del Ecosistema
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div>
                    <p class="text-gray-400 text-sm">Poblaci√≥n total</p>
                    <p id="m_population" class="text-2xl font-bold text-white">0</p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Fitness promedio</p>
                    <p id="m_fitness_avg" class="text-2xl font-bold text-green-400">0%</p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Fitness m√°ximo</p>
                    <p id="m_fitness_max" class="text-2xl font-bold text-green-400">0%</p>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Puntaje cognitivo</p>
                    <p id="m_cognition" class="text-2xl font-bold text-purple-400">0</p>
                </div>
            </div>
        </div>

        <!-- PANEL DE ONDA GLOBAL -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <!-- Onda Global -->
            <div class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-cyan-500/30">
                <h3 class="text-cyan-400 font-bold text-lg mb-3 flex items-center gap-2">
                    üì° Onda Colectiva Interna
                </h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-gray-400 text-xs">Frecuencia</p>
                        <p id="wave_freq" class="text-xl font-bold text-cyan-300 font-mono">0 Hz</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">Amplitud</p>
                        <p id="wave_amp" class="text-xl font-bold text-cyan-300 font-mono">0%</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">Emoci√≥n Dominante</p>
                        <p id="wave_emotion" class="text-xl font-bold text-yellow-300">„Ä∞Ô∏è neutral</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">Contribuyentes</p>
                        <p id="wave_contributors" class="text-xl font-bold text-white">0</p>
                    </div>
                </div>
                <!-- Visualizaci√≥n de onda simple -->
                <div class="h-16 bg-slate-900/50 rounded-lg overflow-hidden relative">
                    <canvas id="waveCanvas" width="400" height="64" class="w-full h-full"></canvas>
                </div>
            </div>

            <!-- Traducciones de los Sociales -->
            <div class="bg-slate-800/50 backdrop-blur rounded-lg p-4 border border-pink-500/30">
                <h3 class="text-pink-400 font-bold text-lg mb-3 flex items-center gap-2">
                    üó£Ô∏è Traducciones Sociales ‚Üí Humanos
                </h3>
                <div id="translations-panel" class="space-y-2 text-sm max-h-48 overflow-y-auto">
                    <p class="text-gray-500 italic">Los Sociales traducir√°n las ondas internas...</p>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // ==================== PARTE 2: SISTEMA DE CONFIGURACI√ìN DIN√ÅMICA ====================
        // Pega este c√≥digo despu√©s de la Parte 1 en el <script>

        // ==================== UTILITIES ====================
        function distance(a, b) {
            const dx = (b.x ?? 0) - (a.x ?? 0);
            const dy = (b.y ?? 0) - (a.y ?? 0);
            return Math.hypot(dx, dy);
        }

        function nowId(prefix = 'id') {
            return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
        }

        function rand(a, b) {
            return Math.random() * (b - a) + a;
        }

        function clamp(v, a, b) {
            return Math.max(a, Math.min(b, v));
        }

        function glitchString(str, intensity = 0.1) {
            const chars = '#%&@$!?;:^*';
            return str.split('').map(c => {
                if (Math.random() < intensity) {
                    return chars[Math.floor(Math.random() * chars.length)];
                }
                return c;
            }).join('');
        }

        // ==================== GENE TYPES ====================
        const GENE_TYPES = {
            PROGRAMMER: 'programmer',
            MATHEMATICIAN: 'mathematician',
            SOCIAL: 'social'
        };

        const RESOURCE_TYPES = {
            CODE: 'code',
            EQUATION: 'equation',
            INTERACTION: 'interaction',
            VACCINE: 'vaccine',
            OUTPUT: 'output'
        };

        // ==================== SISTEMA DE CARGAS EL√âCTRICAS ====================
        // Modelo: Sociales=0 (membrana), Inteligentes=- , Sabios=+
        const CHARGE_SYSTEM = {
            // Configuraci√≥n de f√≠sica de cargas
            config: {
                attractionStrength: 0.08,      // Fuerza de atracci√≥n entre cargas opuestas
                repulsionStrength: 0.05,       // Fuerza de repulsi√≥n entre cargas iguales
                membraneStrength: 0.12,        // Fuerza de la membrana (sociales)
                maxChargeForce: 1.5,           // Fuerza m√°xima aplicable
                chargeDecay: 0.001,            // Decay de carga por step
                wisdomThreshold: 25,           // Wisdom necesaria para volverse positivo
                chargeRadius: 100,             // Radio de influencia de carga
            },

            // Capas visuales (Y) - Divide el canvas en 3 zonas
            layers: {
                positive: { yMin: 0, yMax: 0.33, color: '#FFD700', name: 'SABIOS (+)' },      // Arriba
                neutral: { yMin: 0.33, yMax: 0.66, color: '#fb7185', name: 'MEMBRANA (0)' },  // Medio  
                negative: { yMin: 0.66, yMax: 1.0, color: '#3b82f6', name: 'INTELIGENTES (-)' } // Abajo
            },

            // Calcular carga de una criatura
            calculateCharge: function (creature) {
                if (!creature || creature.isInvader) return 0;

                const type = creature.type;
                const wisdom = creature.wisdom || 0;

                // Sociales SIEMPRE son neutros (0) - act√∫an como membrana
                if (type === GENE_TYPES.SOCIAL) {
                    return 0;
                }

                // Si tiene sabidur√≠a alta, se vuelve positivo (+)
                // La sabidur√≠a "ilumina" a los inteligentes
                if (wisdom >= this.config.wisdomThreshold) {
                    // Rango: +0.1 a +1.0 basado en wisdom (nunca llega a 0)
                    const wisdomFactor = Math.min((wisdom - this.config.wisdomThreshold) / 75, 1);
                    return 0.1 + wisdomFactor * 0.9; // +0.1 a +1.0
                }

                // Programadores y Matem√°ticos son negativos (-)
                if (type === GENE_TYPES.PROGRAMMER || type === GENE_TYPES.MATHEMATICIAN) {
                    // Su carga negativa depende de fitness (m√°s fit = m√°s carga)
                    const fitnessFactor = creature.fitness || 0.3;
                    // Rango: -0.1 a -1.0 (nunca llega a 0)
                    return -(0.1 + fitnessFactor * 0.9);
                }

                return 0;
            },

            // Obtener la capa visual de una criatura basada en su carga
            getLayer: function (charge) {
                if (charge > 0) return this.layers.positive;
                if (charge < 0) return this.layers.negative;
                return this.layers.neutral;
            },

            // Calcular posici√≥n Y ideal basada en carga
            getIdealY: function (charge, worldHeight) {
                const layer = this.getLayer(charge);
                const layerCenter = (layer.yMin + layer.yMax) / 2;
                return layerCenter * worldHeight;
            },

            // S√≠mbolos de carga para visualizaci√≥n
            getChargeSymbol: function (charge) {
                if (charge > 0.5) return '‚äï';  // Muy positivo
                if (charge > 0) return '+';     // Positivo
                if (charge < -0.5) return '‚äñ'; // Muy negativo
                if (charge < 0) return '‚àí';     // Negativo
                return '‚óã';                     // Neutro (membrana)
            },

            // Color basado en carga
            getChargeColor: function (charge) {
                if (charge > 0) {
                    const intensity = Math.min(charge, 1);
                    return `rgba(255, 215, 0, ${0.3 + intensity * 0.7})`; // Dorado
                }
                if (charge < 0) {
                    const intensity = Math.min(Math.abs(charge), 1);
                    return `rgba(59, 130, 246, ${0.3 + intensity * 0.7})`; // Azul
                }
                return 'rgba(251, 113, 133, 0.6)'; // Rosa (membrana)
            }
        };

        // ==================== CONFIGURACI√ìN DIN√ÅMICA ====================
        const CONFIG = {
            world: { w: 800, h: 600 },
            // Configuraci√≥n de energ√≠a y recursos
            resourceEnergyRange: [10, 20],
            energyDecayPerStep: 0.1,
            fitnessDecayRate: 0.001,
            minResources: 20,
            cooperationBonus: 0.05,
            survivalRate: 0.5,
            initialPopulation: 300,
            evolutionFrequency: 250,
            invasionFrequency: 2000,
            catastropheFrequency: 1100,
            eventFrequency: 150,
            cooperationRadius: 50,
            energyShareRate: 0.02,
            rescueEnergyIfAllDead: 80,
            outputTTLms: 10000, // TTL para outputs en milisegundos
            speedMultiplierEffectOnDecay: 0.5, // Efecto del multiplicador de velocidad en el decay

            // Valores iniciales (cooperativo por defecto)
            social: { base: 396, range: [350, 500] },         // Receptivo

            // Estados emocionales como moduladores de onda
            emotions: {
                // B√°sicas
                curiosidad: { freqMod: 1.2, ampMod: 0.6, symbol: 'üîç' },
                hambre: { freqMod: 0.7, ampMod: 0.9, symbol: 'üçΩÔ∏è' },
                felicidad: { freqMod: 1.4, ampMod: 0.5, symbol: 'üòä' },
                tristeza: { freqMod: 0.6, ampMod: 0.4, symbol: 'üò¢' },
                ira: { freqMod: 2.0, ampMod: 0.8, symbol: 'üò°' },
                miedo: { freqMod: 1.9, ampMod: 0.3, symbol: 'üò®' },
                sorpresa: { freqMod: 1.5, ampMod: 0.7, symbol: 'üò≤' },
                asco: { freqMod: 0.5, ampMod: 0.6, symbol: 'ü§¢' },
                confianza: { freqMod: 1.0, ampMod: 0.5, symbol: 'ü§ù' },
                anticipacion: { freqMod: 1.3, ampMod: 0.6, symbol: '‚è≥' },

                // Complejas
                amor: { freqMod: 1.2, ampMod: 0.8, symbol: '‚ù§Ô∏è' },
                odio: { freqMod: 1.8, ampMod: 0.9, symbol: 'üíî' },
                celos: { freqMod: 1.7, ampMod: 0.7, symbol: 'üòí' },
                envidia: { freqMod: 1.6, ampMod: 0.6, symbol: 'üò†' },
                culpa: { freqMod: 0.4, ampMod: 0.5, symbol: 'üòì' },
                verguenza: { freqMod: 0.3, ampMod: 0.4, symbol: 'üò≥' },
                orgullo: { freqMod: 1.4, ampMod: 0.7, symbol: 'ü¶Å' },
                humildad: { freqMod: 0.8, ampMod: 0.3, symbol: 'üôá' },
                gratitud: { freqMod: 1.1, ampMod: 0.5, symbol: 'üôè' },
                esperanza: { freqMod: 1.3, ampMod: 0.6, symbol: 'üïäÔ∏è' },

                // Estado Mental
                confusion: { freqMod: 0.9, ampMod: 0.4, symbol: 'üòµ' },
                claridad: { freqMod: 1.5, ampMod: 0.5, symbol: '‚ú®' },
                concentracion: { freqMod: 1.1, ampMod: 0.3, symbol: 'üéØ' },
                distraccion: { freqMod: 0.8, ampMod: 0.4, symbol: 'ü¶ã' },
                aburrimiento: { freqMod: 0.5, ampMod: 0.2, symbol: 'üòë' },
                interes: { freqMod: 1.3, ampMod: 0.6, symbol: 'ü§©' },
                duda: { freqMod: 0.7, ampMod: 0.3, symbol: 'ü§î' },
                certeza: { freqMod: 1.2, ampMod: 0.6, symbol: '‚úÖ' },
                memoria: { freqMod: 1.0, ampMod: 0.4, symbol: 'üß†' },
                olvido: { freqMod: 0.4, ampMod: 0.2, symbol: 'üå´Ô∏è' },

                // Sociales
                soledad: { freqMod: 0.5, ampMod: 0.3, symbol: 'üßç' },
                compania: { freqMod: 1.2, ampMod: 0.7, symbol: 'üë•' },
                liderazgo: { freqMod: 1.6, ampMod: 0.8, symbol: 'üëë' },
                sumision: { freqMod: 0.6, ampMod: 0.3, symbol: 'üêï' },
                rebeldia: { freqMod: 1.7, ampMod: 0.7, symbol: '‚úä' },
                obediencia: { freqMod: 0.9, ampMod: 0.4, symbol: 'ü´°' },
                empatia: { freqMod: 1.1, ampMod: 0.6, symbol: 'ü§ó' },
                apatia: { freqMod: 0.4, ampMod: 0.2, symbol: 'üòê' },
                generosidad: { freqMod: 1.3, ampMod: 0.7, symbol: 'ü§≤' },
                egoismo: { freqMod: 0.8, ampMod: 0.5, symbol: 'ü´≥' },

                // Creativas / Intelectuales
                inspiracion: { freqMod: 1.8, ampMod: 0.7, symbol: 'üí°' },
                bloqueo: { freqMod: 0.2, ampMod: 0.1, symbol: 'üß±' },
                fluidez: { freqMod: 1.4, ampMod: 0.5, symbol: 'üåä' },
                caos: { freqMod: 1.9, ampMod: 0.9, symbol: 'üåÄ' },
                orden: { freqMod: 1.0, ampMod: 0.4, symbol: 'üìê' },
                logica: { freqMod: 1.1, ampMod: 0.3, symbol: '‚öôÔ∏è' },
                intuicion: { freqMod: 1.6, ampMod: 0.6, symbol: 'üîÆ' },
                analisis: { freqMod: 1.2, ampMod: 0.4, symbol: 'üìä' },
                sintesis: { freqMod: 1.5, ampMod: 0.7, symbol: 'üß©' },
                innovacion: { freqMod: 1.7, ampMod: 0.8, symbol: 'üöÄ' },

                // Biol√≥gicas / F√≠sicas
                cansancio: { freqMod: 0.4, ampMod: 0.2, symbol: 'üò´' },
                energia: { freqMod: 1.6, ampMod: 0.8, symbol: '‚ö°' },
                dolor: { freqMod: 0.3, ampMod: 0.9, symbol: 'ü§ï' },
                placer: { freqMod: 1.4, ampMod: 0.7, symbol: 'üòå' },
                hambre_voraz: { freqMod: 0.8, ampMod: 1.0, symbol: 'üçó' },
                sed: { freqMod: 0.7, ampMod: 0.8, symbol: 'üíß' },
                frio: { freqMod: 0.5, ampMod: 0.5, symbol: 'ü•∂' },
                calor: { freqMod: 1.5, ampMod: 0.6, symbol: 'ü•µ' },
                enfermedad: { freqMod: 0.4, ampMod: 0.4, symbol: 'ü¶†' },
                salud: { freqMod: 1.2, ampMod: 0.6, symbol: 'üí™' },

                // Digitales / Sci-Fi
                glitch: { freqMod: 2.5, ampMod: 0.5, symbol: 'üëæ' },
                latencia: { freqMod: 0.2, ampMod: 0.1, symbol: 'üê¢' },
                bandwidth: { freqMod: 1.8, ampMod: 0.9, symbol: 'üì∂' },
                firewall: { freqMod: 0.5, ampMod: 1.0, symbol: 'üõ°Ô∏è' },
                virus: { freqMod: 2.0, ampMod: 0.8, symbol: '‚ò£Ô∏è' },
                debug: { freqMod: 1.1, ampMod: 0.5, symbol: 'üêõ' },
                compilacion: { freqMod: 1.4, ampMod: 0.6, symbol: 'üß±' },
                runtime: { freqMod: 1.3, ampMod: 0.5, symbol: 'üèÉ' },
                stackoverflow: { freqMod: 2.2, ampMod: 0.9, symbol: 'ü•û' },
                bucle: { freqMod: 1.0, ampMod: 1.0, symbol: 'üîÑ' },

                // Abstractas
                vacio: { freqMod: 0.1, ampMod: 0.1, symbol: '‚ö´' },
                infinito: { freqMod: 2.0, ampMod: 0.5, symbol: '‚ôæÔ∏è' },
                tiempo: { freqMod: 1.0, ampMod: 0.5, symbol: 'üï∞Ô∏è' },
                espacio: { freqMod: 0.5, ampMod: 1.0, symbol: 'üåå' },
                gravedad: { freqMod: 0.3, ampMod: 0.8, symbol: 'üçé' },
                luz: { freqMod: 2.0, ampMod: 0.7, symbol: '‚òÄÔ∏è' },
                oscuridad: { freqMod: 0.2, ampMod: 0.4, symbol: 'üåë' },
                color: { freqMod: 1.5, ampMod: 0.6, symbol: 'üåà' },
                sonido: { freqMod: 1.4, ampMod: 0.5, symbol: 'üéµ' },
                silencio: { freqMod: 0.1, ampMod: 0.1, symbol: 'üîá' },

                // M√≠sticas / Esot√©ricas
                karma: { freqMod: 1.0, ampMod: 0.5, symbol: '‚ò∏Ô∏è' },
                aura: { freqMod: 1.3, ampMod: 0.4, symbol: '‚ú®' },
                nirvana: { freqMod: 0.1, ampMod: 0.9, symbol: 'üßò' },
                alma: { freqMod: 1.1, ampMod: 0.6, symbol: 'üëª' },
                destino: { freqMod: 1.0, ampMod: 0.8, symbol: 'üõ§Ô∏è' },
                azar: { freqMod: 1.9, ampMod: 0.9, symbol: 'üé≤' },
                magia: { freqMod: 1.7, ampMod: 0.7, symbol: 'ü™Ñ' },
                alquimia: { freqMod: 1.4, ampMod: 0.6, symbol: '‚öóÔ∏è' },
                profecia: { freqMod: 1.2, ampMod: 0.5, symbol: 'üìú' },
                vision: { freqMod: 1.6, ampMod: 0.6, symbol: 'üëÅÔ∏è' },

                // Naturaleza
                tormenta: { freqMod: 2.0, ampMod: 1.0, symbol: '‚õàÔ∏è' },
                calma: { freqMod: 0.5, ampMod: 0.2, symbol: 'üåÖ' },
                crecimiento: { freqMod: 1.2, ampMod: 0.6, symbol: 'üå±' },
                decadencia: { freqMod: 0.4, ampMod: 0.4, symbol: 'üçÇ' },
                fuego: { freqMod: 1.8, ampMod: 0.9, symbol: 'üî•' },
                agua: { freqMod: 1.1, ampMod: 0.6, symbol: 'üíß' },
                tierra: { freqMod: 0.6, ampMod: 0.8, symbol: 'üåç' },
                aire: { freqMod: 1.5, ampMod: 0.4, symbol: 'üí®' },
                metal: { freqMod: 0.9, ampMod: 1.0, symbol: '‚öîÔ∏è' },
                madera: { freqMod: 1.1, ampMod: 0.5, symbol: 'ü™µ' },

                // Acciones
                lucha: { freqMod: 1.9, ampMod: 0.9, symbol: 'ü•ä' },
                huida: { freqMod: 2.0, ampMod: 0.8, symbol: 'üèÉ' },
                busqueda: { freqMod: 1.3, ampMod: 0.6, symbol: 'üîé' },
                hallazgo: { freqMod: 1.7, ampMod: 0.8, symbol: 'üíé' },
                construccion: { freqMod: 1.1, ampMod: 0.7, symbol: 'üèóÔ∏è' },
                destruccion: { freqMod: 0.3, ampMod: 1.0, symbol: 'üí£' },
                reparacion: { freqMod: 1.0, ampMod: 0.5, symbol: 'üîß' },
                aprendizaje: { freqMod: 1.2, ampMod: 0.4, symbol: 'üéì' },
                ensenanza: { freqMod: 1.1, ampMod: 0.5, symbol: 'üè´' },
                juego: { freqMod: 1.5, ampMod: 0.7, symbol: 'üéÆ' },

                // Especiales (incluidos en el original)
                alerta: { freqMod: 1.8, ampMod: 0.8, symbol: '‚ö†Ô∏è' },
                cooperacion: { freqMod: 1.0, ampMod: 0.7, symbol: 'ü§ù' },
                descanso: { freqMod: 0.5, ampMod: 0.3, symbol: 'üí§' },
                exploracion: { freqMod: 1.3, ampMod: 0.7, symbol: 'üß≠' },

                // Emociones adicionales usadas en determineEmotion
                agonia: { freqMod: 0.2, ampMod: 1.0, symbol: 'üíÄ' },
                euforia: { freqMod: 2.0, ampMod: 0.9, symbol: 'ü§©' },
                optimismo: { freqMod: 1.4, ampMod: 0.6, symbol: 'üåü' },
                debilidad: { freqMod: 0.4, ampMod: 0.3, symbol: 'üò©' },
                vitalidad: { freqMod: 1.5, ampMod: 0.8, symbol: 'üíö' },
                transcendencia: { freqMod: 0.8, ampMod: 1.0, symbol: 'üåÄ' },
                geometria: { freqMod: 1.2, ampMod: 0.4, symbol: 'üìê' },
                calculo: { freqMod: 1.3, ampMod: 0.5, symbol: '‚ûó' },
                union: { freqMod: 1.1, ampMod: 0.7, symbol: 'üîó' },
                red: { freqMod: 1.3, ampMod: 0.6, symbol: 'üï∏Ô∏è' },
                reflexion: { freqMod: 0.9, ampMod: 0.4, symbol: 'ü™û' },
                verdad: { freqMod: 1.0, ampMod: 0.5, symbol: '‚öñÔ∏è' },
                victoria: { freqMod: 1.6, ampMod: 0.9, symbol: 'üèÜ' },
                neutral: { freqMod: 1.0, ampMod: 0.5, symbol: '„Ä∞Ô∏è' },
                proteccion: { freqMod: 1.2, ampMod: 0.6, symbol: 'üõ°Ô∏è' },

                // REQUERIDO: Desconocida
                desconocida: { freqMod: 1.0, ampMod: 0.1, symbol: '?' }
            },

            // Onda global (sumatoria de todas las ondas)
            globalWave: {
                frequency: 0,
                amplitude: 0,
                phase: 0,
                dominantEmotion: 'neutral',
                contributors: 0
            }
        };
        window.CONFIG = CONFIG;

        const UNDERWORLD_HEIGHT = 180;
        const UNDERWORLD_Y = CONFIG.world.h - UNDERWORLD_HEIGHT;
        const GATE = { x: CONFIG.world.w / 2, y: UNDERWORLD_Y, radius: 28 };
        const SAFE_ZONES = [
            { x: CONFIG.world.w * 0.18, y: CONFIG.world.h * 0.22, r: 60, color: '#10b981' },
            { x: CONFIG.world.w * 0.82, y: CONFIG.world.h * 0.25, r: 60, color: '#3b82f6' },
            { x: CONFIG.world.w * 0.50, y: CONFIG.world.h * 0.15, r: 70, color: '#f472b6' }
        ];
        window.SAFE_ZONES = SAFE_ZONES;
        window.UNDERWORLD = { y: UNDERWORLD_Y, h: UNDERWORLD_HEIGHT, gate: GATE };

        // ==================== WAVE SYSTEM ====================
        const WAVE_SYSTEM = {
            globalWave: CONFIG.globalWave,
            frequencies: {
                programmer: { base: 600, range: [550, 650] },
                mathematician: { base: 450, range: [400, 500] },
                social: { base: 350, range: [300, 400] }
            },
            emotions: CONFIG.emotions,

            // ZEITGEIST (Humor Global del Momento)
            zeitgeist: null,
            zeitgeistTimer: 0,

            update: function (creatures) {
                if (!creatures || creatures.length === 0) {
                    this.globalWave.contributors = 0;
                    return;
                }

                // --- ZEITGEIST UPDATE ---
                // Cambiar el humor global cada cierto tiempo para forzar variedad
                this.zeitgeistTimer--;
                if (this.zeitgeistTimer <= 0) {
                    const keys = Object.keys(this.emotions);
                    this.zeitgeist = keys[Math.floor(Math.random() * keys.length)];
                    this.zeitgeistTimer = 300 + Math.random() * 300; // 5-10 segundos @ 60fps
                    // console.log('üåä ZEITGEIST CHANGE:', this.zeitgeist);
                }

                let totalFreq = 0;
                let totalAmp = 0;
                let emotionCounts = {};

                creatures.forEach(c => {
                    const wave = computeCreatureWave(c); // Ensure we use the helper to get fresh wave data
                    totalFreq += wave.frequency * wave.amplitude; // Weighted by amplitude
                    totalAmp += wave.amplitude;

                    emotionCounts[wave.emotion] = (emotionCounts[wave.emotion] || 0) + 1;
                });

                // Find dominant emotion
                let dominantEmotion = 'neutral';
                let maxCount = 0;
                for (const [emote, count] of Object.entries(emotionCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        dominantEmotion = emote;
                    }
                }

                const avgFreq = totalAmp > 0 ? totalFreq / totalAmp : 0;
                const avgAmp = creatures.length > 0 ? totalAmp / creatures.length : 0;
                const phase = (Date.now() / 1000) % (Math.PI * 2);

                this.globalWave.frequency = avgFreq;
                this.globalWave.amplitude = clamp(avgAmp, 0, 1);
                this.globalWave.phase = phase;
                this.globalWave.dominantEmotion = dominantEmotion;
                this.globalWave.contributors = creatures.length;

                // ==================== EXTERNAL AUDIO INFLUENCE ====================
                if (window.AUDIO_SYSTEM && window.AUDIO_SYSTEM.micEnabled) {
                    const micData = window.AUDIO_SYSTEM.getMicData();
                    if (micData) {
                        // Blend external frequency (weighted 30%)
                        this.globalWave.frequency = this.globalWave.frequency * 0.7 + micData.freq * 0.3;
                        // Boost amplitude by mic volume
                        this.globalWave.amplitude = clamp(this.globalWave.amplitude + micData.volume * 0.5, 0, 1);
                    }
                }

                // Update UI if elements exist
                const freqEl = document.getElementById('wave_freq');
                if (freqEl) freqEl.textContent = Math.round(this.globalWave.frequency) + ' Hz';

                const ampEl = document.getElementById('wave_amp');
                if (ampEl) ampEl.textContent = Math.round(this.globalWave.amplitude * 100) + '%';

                const emoEl = document.getElementById('wave_emotion');
                if (emoEl) {
                    const emoData = CONFIG.emotions[dominantEmotion] || { symbol: '„Ä∞Ô∏è' };
                    emoEl.textContent = `${emoData.symbol} ${dominantEmotion}`;
                }

                if (window.AUDIO_SYSTEM) window.AUDIO_SYSTEM.update(this.globalWave.frequency, this.globalWave.amplitude);
            }
        };
        window.WAVE_SYSTEM = WAVE_SYSTEM;




        // ==================== SISTEMA DE HERENCIA (LINEAGE) ====================
        const HERITAGE_SYSTEM = {
            // Registro global de ancestros
            registry: new Map(),

            // Crear herencia para criatura nueva (generaci√≥n 1)
            createOrigin: function (creature) {
                return {
                    parentId: null,
                    parentType: null,
                    lineageDepth: 0,
                    generation: 1, // Assuming 'state' is not directly available here, keeping original generation: 1
                    ancestors: [],
                    mutations: 0,
                    originType: creature.type,
                    birthTime: Date.now(),
                    // WISDOM SYSTEM
                    wisdom: 0.0,
                    knowledge: []
                };
            },

            // Crear herencia para hijo
            createChild: function (parent, generation) {
                const parentHeritage = parent.heritage || this.createOrigin(parent);
                const ancestors = [...(parentHeritage.ancestors || [])];

                // Mantener solo √∫ltimos 10 ancestros para eficiencia
                if (ancestors.length >= 10) ancestors.shift();
                ancestors.push(parent.id);

                return {
                    parentId: parent.id,
                    parentType: parent.type,
                    lineageDepth: (parentHeritage.lineageDepth || 0) + 1,
                    generation: generation,
                    ancestors: ancestors,
                    mutations: (parentHeritage.mutations || 0) + (Math.random() > 0.7 ? 1 : 0),
                    originType: parentHeritage.originType || parent.type,
                    birthTime: Date.now()
                };
            },

            // Obtener cadena de herencia legible
            getLineageString: function (creature) {
                if (!creature.heritage || !creature.heritage.parentId) {
                    return `üå± Gen-1 (Origen ${creature.type})`;
                }
                const h = creature.heritage;
                return `üß¨ Gen-${h.generation} | Padre: ${h.parentType} | Profundidad: ${h.lineageDepth} | Mutaciones: ${h.mutations}`;
            }
        };

        // ==================== TRADUCTOR SOCIAL (Ondas ‚Üí Humano) ====================
        const SOCIAL_TRANSLATOR = {
            // Traducci√≥n de onda global a mensaje humano
            translations: {
                // Por rangos de frecuencia
                veryLow: [  // < 350 Hz
                    'üí§ El colectivo descansa...',
                    'üåô Ondas serenas, paz interior',
                    'üòå Armon√≠a en reposo',
                    'üîá Silencio digital...'
                ],
                low: [      // 350-420 Hz
                    'üåä Flujo estable detectado',
                    'üßò Equilibrio colectivo',
                    'üíö Cohesi√≥n suave'
                ],
                mid: [      // 420-500 Hz
                    'ü§î Procesamiento activo',
                    'üí° Ideas circulando',
                    'üîß Construcci√≥n en progreso',
                    'üß† Sinapsis colectiva'
                ],
                high: [     // 500-580 Hz
                    '‚ö° Alta actividad!',
                    'üî• Energ√≠a expansiva',
                    'üöÄ Momento de crecimiento',
                    '‚ú® Creatividad desbordante'
                ],
                veryHigh: [ // > 580 Hz
                    'üåü PICO DE ACTIVIDAD!',
                    'üí´ Resonancia m√°xima',
                    'üéÜ Explosi√≥n sin√°ptica',
                    'üåà Trascendencia colectiva'
                ]
            },

            // Traducci√≥n por emoci√≥n dominante
            emotionTranslations: {
                curiosidad: 'üîç El colectivo explora nuevas posibilidades',
                hambre: 'üçΩÔ∏è Necesidad de recursos detectada',
                felicidad: 'üòä Bienestar colectivo elevado',
                alerta: '‚ö†Ô∏è Estado de vigilancia activo',
                cooperacion: 'ü§ù Momento de uni√≥n y colaboraci√≥n',
                creatividad: 'üí° Inspiraci√≥n fluyendo por la red',
                descanso: 'üí§ Recuperaci√≥n energ√©tica en curso',
                exploracion: 'üß≠ B√∫squeda activa de oportunidades',
                neutral: '„Ä∞Ô∏è Estado estable, sin eventos'
            },

            // Traducir onda global a mensaje humano
            translate: function (globalWave) {
                const freq = globalWave.frequency;
                const amp = globalWave.amplitude;
                const emotion = globalWave.dominantEmotion;

                // Seleccionar banda de frecuencia
                let band;
                if (freq < 350) band = 'veryLow';
                else if (freq < 420) band = 'low';
                else if (freq < 500) band = 'mid';
                else if (freq < 580) band = 'high';
                else band = 'veryHigh';

                // Mensaje base por frecuencia
                const freqMessages = this.translations[band];
                const freqMsg = freqMessages[Math.floor(Math.random() * freqMessages.length)];

                // Mensaje por emoci√≥n
                let emotionMsg = this.emotionTranslations[emotion];

                // Fallback din√°mico si no hay traducci√≥n espec√≠fica
                if (!emotionMsg) {
                    const emoData = (window.CONFIG && window.CONFIG.emotions && window.CONFIG.emotions[emotion]) || { symbol: '‚ùì' };
                    // Variaciones gen√©ricas para dar vida
                    const templates = [
                        `${emoData.symbol} El colectivo siente ${emotion.toUpperCase()}`,
                        `${emoData.symbol} Resonancia de ${emotion.toUpperCase()} detectada`,
                        `${emoData.symbol} Ola de ${emotion.toUpperCase()} en expansi√≥n`,
                        `${emoData.symbol} Estado predominante: ${emotion.toUpperCase()}`
                    ];
                    emotionMsg = templates[Math.floor(Math.random() * templates.length)];
                }

                // Intensidad basada en amplitud
                const intensity = amp > 0.7 ? 'üîä' : amp > 0.4 ? 'üîâ' : 'üîà';

                return {
                    frequency: freqMsg,
                    emotion: emotionMsg,
                    intensity: intensity,
                    raw: `${Math.round(freq)}Hz @ ${(amp * 100).toFixed(0)}%`,
                    timestamp: Date.now()
                };
            }
        };

        // Buffer de traducciones recientes
        let recentTranslations = [];

        // ==================== FUNCIONES DE CONTROL ====================
        function updateConfig(key, value, displayId, isFloat = false, suffix = '') {
            // Handle special keys
            if (key === 'invasionFrequency') {
                state.portal.frequency = parseInt(value);
            } else if (key === 'catastropheFrequency') {
                CONFIG.catastropheFrequency = parseInt(value);
            } else {
                const numValue = isFloat ? parseFloat(value) : parseInt(value);
                CONFIG[key] = numValue;
            }
            if (displayId) {
                const displayValue = isFloat ? parseFloat(value) : parseInt(value);
                document.getElementById(displayId).textContent = displayValue + suffix;
            }
            updateEnvironmentIndicator();
        }
        function toggleOptionHelp(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const cur = el.style.display;
            el.style.display = (!cur || cur === 'none') ? 'block' : 'none';
        }

        function updateEnergyRange(type, value) {
            const numValue = parseInt(value);
            if (type === 'min') {
                CONFIG.resourceEnergyRange[0] = numValue;
                document.getElementById('energy-min-value').textContent = numValue;
                // Asegurar que min no sea mayor que max
                if (numValue > CONFIG.resourceEnergyRange[1]) {
                    CONFIG.resourceEnergyRange[1] = numValue + 5;
                    document.getElementById('energy-max-slider').value = numValue + 5;
                    document.getElementById('energy-max-value').textContent = numValue + 5;
                }
            } else {
                CONFIG.resourceEnergyRange[1] = numValue;
                document.getElementById('energy-max-value').textContent = numValue;
                // Asegurar que max no sea menor que min
                if (numValue < CONFIG.resourceEnergyRange[0]) {
                    CONFIG.resourceEnergyRange[0] = numValue - 5;
                    document.getElementById('energy-min-slider').value = numValue - 5;
                    document.getElementById('energy-min-value').textContent = numValue - 5;
                }
            }
            updateEnvironmentIndicator();
        }

        function updateEnvironmentIndicator() {
            // Calcular score de agresividad
            const aggressiveness = (
                (CONFIG.energyDecayPerStep * 100) +
                (1 / CONFIG.minResources * 100) +
                (100 - CONFIG.resourceEnergyRange[0]) -
                (CONFIG.cooperationBonus * 100) -
                (CONFIG.survivalRate)
            ) / 5;

            const indicator = document.getElementById('mode-indicator');
            let mode, color;

            if (aggressiveness > 60) {
                mode = 'üî• Agresivo';
                color = 'text-red-400';
            } else if (aggressiveness > 30) {
                mode = '‚öñÔ∏è Balanceado';
                color = 'text-yellow-400';
            } else {
                mode = 'ü§ù Cooperativo';
                color = 'text-green-400';
            }

            indicator.textContent = mode;
            indicator.className = `font-bold ${color}`;
        }

        // ==================== PRESETS ====================
        function applyPreset(preset) {
            const presets = {
                aggressive: {
                    initialPopulation: 50,
                    minResources: 15,
                    energyDecayPerStep: 0.6,
                    resourceEnergyRange: [4, 12],
                    rescueEnergyIfAllDead: 40,
                    cooperationBonus: 0.02,
                    cooperationRadius: 30,
                    energyShareRate: 0.01,
                    survivalRate: 25,
                    evolutionFrequency: 200,
                    eventFrequency: 150,
                    catastropheFrequency: 2000
                },
                balanced: {
                    initialPopulation: 60,
                    minResources: 25,
                    energyDecayPerStep: 0.4,
                    resourceEnergyRange: [6, 16],
                    rescueEnergyIfAllDead: 60,
                    cooperationBonus: 0.05,
                    cooperationRadius: 40,
                    energyShareRate: 0.015,
                    survivalRate: 35,
                    evolutionFrequency: 250,
                    eventFrequency: 250,
                    catastropheFrequency: 2500
                },
                cooperative: {
                    initialPopulation: 80,
                    minResources: 35,
                    energyDecayPerStep: 0.25,
                    resourceEnergyRange: [8, 20],
                    rescueEnergyIfAllDead: 80,
                    cooperationBonus: 0.08,
                    cooperationRadius: 50,
                    energyShareRate: 0.02,
                    survivalRate: 40,
                    evolutionFrequency: 250,
                    eventFrequency: 300,
                    catastropheFrequency: 3000
                }
            };

            const selected = presets[preset];
            Object.assign(CONFIG, selected);

            // Actualizar todos los sliders
            document.getElementById('population-slider').value = selected.initialPopulation;
            document.getElementById('pop-value').textContent = selected.initialPopulation;

            document.getElementById('resources-slider').value = selected.minResources;
            document.getElementById('res-value').textContent = selected.minResources;

            document.getElementById('decay-slider').value = selected.energyDecayPerStep;
            document.getElementById('decay-value').textContent = selected.energyDecayPerStep;

            document.getElementById('energy-min-slider').value = selected.resourceEnergyRange[0];
            document.getElementById('energy-min-value').textContent = selected.resourceEnergyRange[0];

            document.getElementById('energy-max-slider').value = selected.resourceEnergyRange[1];
            document.getElementById('energy-max-value').textContent = selected.resourceEnergyRange[1];

            document.getElementById('rescue-slider').value = selected.rescueEnergyIfAllDead;
            document.getElementById('rescue-value').textContent = selected.rescueEnergyIfAllDead;

            document.getElementById('coop-bonus-slider').value = selected.cooperationBonus;
            document.getElementById('coop-bonus-value').textContent = selected.cooperationBonus;

            document.getElementById('coop-radius-slider').value = selected.cooperationRadius;
            document.getElementById('coop-radius-value').textContent = selected.cooperationRadius;

            document.getElementById('share-slider').value = selected.energyShareRate;
            document.getElementById('share-value').textContent = selected.energyShareRate;

            document.getElementById('survival-slider').value = selected.survivalRate;
            document.getElementById('survival-value').textContent = selected.survivalRate + '%';

            document.getElementById('evo-freq-slider').value = selected.evolutionFrequency;
            document.getElementById('evo-freq-value').textContent = selected.evolutionFrequency;

            document.getElementById('event-freq-slider').value = selected.eventFrequency;
            document.getElementById('event-freq-value').textContent = selected.eventFrequency;

            document.getElementById('cata-freq-slider').value = selected.catastropheFrequency;
            document.getElementById('cata-freq-value').textContent = selected.catastropheFrequency;

            updateEnvironmentIndicator();

            console.log(`‚úì Preset aplicado: ${preset.toUpperCase()}`);
        }

        // ==================== BRAINMARK BENCHMARK SYSTEM ====================

        // Estado del BrainMark
        const BRAINMARK_STATE = {
            unlockedLevels: [1],  // Solo nivel 1 desbloqueado inicialmente
            completedLevels: [],
            scores: {},
            currentExam: null,
            passingThreshold: 0.7  // 70% para desbloquear siguiente nivel
        };

        // Preguntas por nivel (10 por nivel = 50 total)
        const BRAINMARK_QUESTIONS = {
            // ========== NIVEL 1: OBSERVACI√ìN (Lecturas directas) ==========
            level1: {
                name: "OBSERVACI√ìN",
                description: "Lectura directa del estado actual",
                points: 1,
                questions: [
                    {
                        id: "L1-01", type: "number", q: "¬øCu√°ntas criaturas hay en total?",
                        answer: () => state.creatures.length
                    },
                    {
                        id: "L1-02", type: "number", q: "¬øCu√°ntos Programadores hay?",
                        answer: () => state.creatures.filter(c => c.type === 'programmer').length
                    },
                    {
                        id: "L1-03", type: "number", q: "¬øCu√°ntos Matem√°ticos hay?",
                        answer: () => state.creatures.filter(c => c.type === 'mathematician').length
                    },
                    {
                        id: "L1-04", type: "number", q: "¬øCu√°ntos Sociales hay?",
                        answer: () => state.creatures.filter(c => c.type === 'social').length
                    },
                    {
                        id: "L1-05", type: "number", q: "¬øEn qu√© generaci√≥n est√° la simulaci√≥n?",
                        answer: () => state.generation
                    },
                    {
                        id: "L1-06", type: "number", q: "¬øCu√°ntos pasos de simulaci√≥n han transcurrido?",
                        answer: () => state.simulationSteps
                    },
                    {
                        id: "L1-07", type: "number", q: "¬øCu√°ntos recursos hay actualmente?",
                        answer: () => state.resources.filter(r => !r.collected).length
                    },
                    {
                        id: "L1-08", type: "number", q: "¬øCu√°l es la frecuencia global en Hz (redondeado)?",
                        answer: () => Math.round(WAVE_SYSTEM.globalWave.frequency || 0)
                    },
                    {
                        id: "L1-09", type: "choice", q: "¬øCu√°l es la emoci√≥n dominante actual?",
                        options: ["curiosidad", "hambre", "felicidad", "cooperacion", "descanso", "neutral"],
                        answer: () => WAVE_SYSTEM.globalWave.dominantEmotion || "neutral"
                    },
                    {
                        id: "L1-10", type: "number", q: "¬øCu√°ntas traducciones recientes hay?",
                        answer: () => recentTranslations.length
                    }
                ]
            },

            // ========== NIVEL 2: COMPRENSI√ìN (Interpretar m√©tricas) ==========
            level2: {
                name: "COMPRENSI√ìN",
                description: "Interpretar m√©tricas y estados",
                points: 2,
                questions: [
                    {
                        id: "L2-01", type: "tf", q: "¬øEl fitness promedio est√° por encima del 50%?",
                        answer: () => (state.creatures.reduce((s, c) => s + (c.fitness || 0), 0) / state.creatures.length) > 0.5
                    },
                    {
                        id: "L2-02", type: "tf", q: "¬øHay m√°s criaturas prosperando (energy>80, fitness>0.6) que luchando (energy<30)?",
                        answer: () => state.creatures.filter(c => c.energy > 80 && c.fitness > 0.6).length >
                            state.creatures.filter(c => c.energy < 30).length
                    },
                    {
                        id: "L2-03", type: "choice", q: "¬øCu√°l tipo tiene mayor poblaci√≥n?",
                        options: ["programmer", "mathematician", "social", "empate"],
                        answer: () => {
                            const counts = { programmer: 0, mathematician: 0, social: 0 };
                            state.creatures.forEach(c => counts[c.type]++);
                            const max = Math.max(...Object.values(counts));
                            const winners = Object.keys(counts).filter(k => counts[k] === max);
                            return winners.length > 1 ? "empate" : winners[0];
                        }
                    },
                    {
                        id: "L2-04", type: "tf", q: "¬øLa frecuencia global indica alta actividad (>500Hz)?",
                        answer: () => (WAVE_SYSTEM.globalWave.frequency || 0) > 500
                    },
                    {
                        id: "L2-05", type: "choice", q: "¬øCu√°l es el estado de salud del ecosistema?",
                        options: ["Saludable", "En dificultad", "Equilibrado"],
                        answer: () => {
                            const thriving = state.creatures.filter(c => c.energy > 80 && c.fitness > 0.6).length;
                            const struggling = state.creatures.filter(c => c.energy < 30).length;
                            return thriving > struggling ? "Saludable" : thriving < struggling ? "En dificultad" : "Equilibrado";
                        }
                    },
                    {
                        id: "L2-06", type: "tf", q: "¬øExisten linajes con profundidad mayor a 2?",
                        answer: () => state.creatures.some(c => (c.heritage?.lineageDepth || 0) > 2)
                    },
                    {
                        id: "L2-07", type: "number", q: "¬øCu√°l es la profundidad m√°xima de linaje?",
                        answer: () => Math.max(0, ...state.creatures.map(c => c.heritage?.lineageDepth || 0))
                    },
                    {
                        id: "L2-08", type: "tf", q: "¬øHay al menos un Social que ha hecho traducciones?",
                        answer: () => state.creatures.some(c => c.type === 'social' && (c.translationsDone || 0) > 0)
                    },
                    {
                        id: "L2-09", type: "choice", q: "¬øLa amplitud de la onda global es...?",
                        options: ["Baja (<30%)", "Media (30-60%)", "Alta (>60%)"],
                        answer: () => {
                            const amp = (WAVE_SYSTEM.globalWave.amplitude || 0) * 100;
                            return amp < 30 ? "Baja (<30%)" : amp <= 60 ? "Media (30-60%)" : "Alta (>60%)";
                        }
                    },
                    {
                        id: "L2-10", type: "tf", q: "¬øEl preset actual favorece la cooperaci√≥n (cooperationBonus > 0.05)?",
                        answer: () => CONFIG.cooperationBonus > 0.05
                    }
                ]
            },

            // ========== NIVEL 3: AN√ÅLISIS (Relacionar datos) ==========
            level3: {
                name: "AN√ÅLISIS",
                description: "Relacionar datos y encontrar patrones",
                points: 3,
                questions: [
                    {
                        id: "L3-01", type: "tf", q: "¬øLos linajes m√°s profundos tienen fitness por encima del promedio?",
                        answer: () => {
                            const avgFitness = state.creatures.reduce((s, c) => s + (c.fitness || 0), 0) / state.creatures.length;
                            const deepOnes = state.creatures.filter(c => (c.heritage?.lineageDepth || 0) >= 2);
                            if (deepOnes.length === 0) return false;
                            const deepAvg = deepOnes.reduce((s, c) => s + (c.fitness || 0), 0) / deepOnes.length;
                            return deepAvg > avgFitness;
                        }
                    },
                    {
                        id: "L3-02", type: "choice", q: "¬øQu√© relaci√≥n hay entre emoci√≥n dominante y estado de salud?",
                        options: ["Positiva (felicidad/cooperacion + saludable)", "Negativa (hambre/alerta + dificultad)", "Sin correlaci√≥n clara"],
                        answer: () => {
                            const emotion = WAVE_SYSTEM.globalWave.dominantEmotion || "neutral";
                            const thriving = state.creatures.filter(c => c.energy > 80 && c.fitness > 0.6).length;
                            const struggling = state.creatures.filter(c => c.energy < 30).length;
                            const healthy = thriving > struggling;
                            const positiveEmotions = ["felicidad", "cooperacion", "curiosidad"];
                            const negativeEmotions = ["hambre", "alerta"];
                            if (positiveEmotions.includes(emotion) && healthy) return "Positiva (felicidad/cooperacion + saludable)";
                            if (negativeEmotions.includes(emotion) && !healthy) return "Negativa (hambre/alerta + dificultad)";
                            return "Sin correlaci√≥n clara";
                        }
                    },
                    {
                        id: "L3-03", type: "number", q: "¬øCu√°ntas mutaciones totales se han acumulado en la poblaci√≥n?",
                        answer: () => state.creatures.reduce((s, c) => s + (c.heritage?.mutations || 0), 0)
                    },
                    {
                        id: "L3-04", type: "tf", q: "¬øLos Sociales tienen en promedio m√°s traducciones que items en inventario?",
                        answer: () => {
                            const socials = state.creatures.filter(c => c.type === 'social');
                            if (socials.length === 0) return false;
                            const avgTrans = socials.reduce((s, c) => s + (c.translationsDone || 0), 0) / socials.length;
                            const avgInv = socials.reduce((s, c) => s + (c.inventory?.length || 0), 0) / socials.length;
                            return avgTrans > avgInv;
                        }
                    },
                    {
                        id: "L3-05", type: "choice", q: "¬øQu√© tipo de criatura tiene mayor fitness promedio?",
                        options: ["programmer", "mathematician", "social", "todos similares"],
                        answer: () => {
                            const byType = { programmer: [], mathematician: [], social: [] };
                            state.creatures.forEach(c => byType[c.type].push(c.fitness || 0));
                            const avgs = {};
                            for (const t in byType) {
                                avgs[t] = byType[t].length ? byType[t].reduce((a, b) => a + b, 0) / byType[t].length : 0;
                            }
                            const max = Math.max(...Object.values(avgs));
                            const min = Math.min(...Object.values(avgs));
                            if (max - min < 0.1) return "todos similares";
                            return Object.keys(avgs).find(k => avgs[k] === max);
                        }
                    },
                    {
                        id: "L3-06", type: "tf", q: "¬øLa frecuencia alta (>480Hz) correlaciona con m√°s contributors?",
                        answer: () => {
                            const freq = WAVE_SYSTEM.globalWave.frequency || 0;
                            const contrib = WAVE_SYSTEM.globalWave.contributors || 0;
                            return (freq > 480 && contrib > state.creatures.length * 0.5) ||
                                (freq <= 480 && contrib <= state.creatures.length * 0.5);
                        }
                    },
                    {
                        id: "L3-07", type: "number", q: "¬øCu√°ntos ancestros √∫nicos existen en toda la poblaci√≥n?",
                        answer: () => {
                            const ancestors = new Set();
                            state.creatures.forEach(c => (c.heritage?.ancestors || []).forEach(a => ancestors.add(a)));
                            return ancestors.size;
                        }
                    },
                    {
                        id: "L3-08", type: "tf", q: "¬øLas criaturas con m√°s items en inventario tienen mayor fitness?",
                        answer: () => {
                            const withInv = state.creatures.filter(c => (c.inventory?.length || 0) > 0);
                            const withoutInv = state.creatures.filter(c => (c.inventory?.length || 0) === 0);
                            if (withInv.length === 0 || withoutInv.length === 0) return false;
                            const avgWith = withInv.reduce((s, c) => s + (c.fitness || 0), 0) / withInv.length;
                            const avgWithout = withoutInv.reduce((s, c) => s + (c.fitness || 0), 0) / withoutInv.length;
                            return avgWith > avgWithout;
                        }
                    },
                    {
                        id: "L3-09", type: "choice", q: "¬øCu√°l tipo origin√≥ m√°s descendientes (por originType en heritage)?",
                        options: ["programmer", "mathematician", "social", "sin datos"],
                        answer: () => {
                            const origins = { programmer: 0, mathematician: 0, social: 0 };
                            state.creatures.forEach(c => {
                                const o = c.heritage?.originType;
                                if (o && origins[o] !== undefined) origins[o]++;
                            });
                            const max = Math.max(...Object.values(origins));
                            if (max === 0) return "sin datos";
                            return Object.keys(origins).find(k => origins[k] === max);
                        }
                    },
                    {
                        id: "L3-10", type: "tf", q: "¬øEl decay de energ√≠a actual (CONFIG) es mayor al valor por defecto (0.25)?",
                        answer: () => CONFIG.energyDecayPerStep > 0.25
                    }
                ]
            },

            // ========== NIVEL 4: PREDICCI√ìN (Comportamiento futuro) ==========
            level4: {
                name: "PREDICCI√ìN",
                description: "Predecir comportamiento futuro del sistema",
                points: 4,
                questions: [
                    {
                        id: "L4-01", type: "choice", q: "Con el estado actual, ¬øqu√© tipo tiene m√°s probabilidad de dominar en 5 generaciones?",
                        options: ["programmer", "mathematician", "social", "equilibrio"],
                        answer: () => {
                            const byType = { programmer: { count: 0, fitness: 0 }, mathematician: { count: 0, fitness: 0 }, social: { count: 0, fitness: 0 } };
                            state.creatures.forEach(c => { byType[c.type].count++; byType[c.type].fitness += c.fitness || 0; });
                            for (const t in byType) byType[t].avg = byType[t].count ? byType[t].fitness / byType[t].count : 0;
                            const scores = {};
                            for (const t in byType) scores[t] = byType[t].count * 0.3 + byType[t].avg * 100 * 0.7;
                            const max = Math.max(...Object.values(scores));
                            const min = Math.min(...Object.values(scores));
                            if (max - min < 5) return "equilibrio";
                            return Object.keys(scores).find(k => scores[k] === max);
                        }
                    },
                    {
                        id: "L4-02", type: "tf", q: "¬øSi una cat√°strofe ocurre ahora, sobrevivir√°n m√°s de 50% de las criaturas?",
                        answer: () => {
                            const survivors = state.creatures.filter(c => c.fitness > 0.5 && c.energy > 50);
                            return survivors.length > state.creatures.length * 0.5;
                        }
                    },
                    {
                        id: "L4-03", type: "choice", q: "¬øQu√© pasar√° con la frecuencia global si la poblaci√≥n sigue creciendo?",
                        options: ["Aumentar√° (m√°s contributors)", "Disminuir√° (diluci√≥n)", "Se mantendr√° estable"],
                        answer: () => {
                            const avgEnergy = state.creatures.reduce((s, c) => s + (c.energy || 0), 0) / state.creatures.length;
                            if (avgEnergy > 60) return "Aumentar√° (m√°s contributors)";
                            if (avgEnergy < 40) return "Disminuir√° (diluci√≥n)";
                            return "Se mantendr√° estable";
                        }
                    },
                    {
                        id: "L4-04", type: "tf", q: "¬øLos linajes actuales alcanzar√°n profundidad 5+ en las pr√≥ximas 10 generaciones?",
                        answer: () => {
                            const currentMax = Math.max(0, ...state.creatures.map(c => c.heritage?.lineageDepth || 0));
                            const generationsNeeded = 5 - currentMax;
                            return generationsNeeded <= 10 && currentMax > 0;
                        }
                    },
                    {
                        id: "L4-05", type: "choice", q: "¬øQu√© emoci√≥n probablemente dominar√° si la energ√≠a promedio baja 20%?",
                        options: ["hambre", "alerta", "descanso", "cooperacion"],
                        answer: () => {
                            const avgEnergy = state.creatures.reduce((s, c) => s + (c.energy || 0), 0) / state.creatures.length;
                            const newAvg = avgEnergy * 0.8;
                            if (newAvg < 30) return "hambre";
                            if (newAvg < 50) return "alerta";
                            return "descanso";
                        }
                    },
                    {
                        id: "L4-06", type: "tf", q: "¬øSi se duplican los recursos, el fitness promedio subir√°?",
                        answer: () => true
                    },
                    {
                        id: "L4-07", type: "choice", q: "¬øQu√© categor√≠a de sabidur√≠a crecer√° m√°s r√°pido?",
                        options: ["c√≥digo (programmers)", "ecuaciones (mathematicians)", "interacciones (socials)", "equilibrado"],
                        answer: () => {
                            const counts = { programmer: 0, mathematician: 0, social: 0 };
                            state.creatures.forEach(c => counts[c.type]++);
                            const max = Math.max(...Object.values(counts));
                            const winner = Object.keys(counts).find(k => counts[k] === max);
                            if (winner === 'programmer') return "c√≥digo (programmers)";
                            if (winner === 'mathematician') return "ecuaciones (mathematicians)";
                            if (winner === 'social') return "interacciones (socials)";
                            return "equilibrado";
                        }
                    },
                    {
                        id: "L4-08", type: "tf", q: "¬øLos Sociales ser√°n m√°s del 40% de la poblaci√≥n en 3 generaciones?",
                        answer: () => {
                            const socialRatio = state.creatures.filter(c => c.type === 'social').length / state.creatures.length;
                            const socialFitness = state.creatures.filter(c => c.type === 'social').reduce((s, c) => s + (c.fitness || 0), 0);
                            const avgSocialFitness = socialFitness / (state.creatures.filter(c => c.type === 'social').length || 1);
                            return socialRatio > 0.3 && avgSocialFitness > 0.5;
                        }
                    },
                    {
                        id: "L4-09", type: "number", q: "¬øCu√°ntas generaciones m√°s hasta la pr√≥xima evoluci√≥n autom√°tica?",
                        answer: () => {
                            const stepsToNext = CONFIG.evolutionFrequency - (state.simulationSteps % CONFIG.evolutionFrequency);
                            return Math.ceil(stepsToNext / CONFIG.evolutionFrequency);
                        }
                    },
                    {
                        id: "L4-10", type: "tf", q: "¬øEl sistema alcanzar√° singularidad (3 tipos con claves espec√≠ficas juntos) pronto?",
                        answer: () => {
                            const hasAllTypes = ['programmer', 'mathematician', 'social'].every(t =>
                                state.creatures.some(c => c.type === t && c.fitness > 0.7));
                            return hasAllTypes;
                        }
                    }
                ]
            },

            // ========== NIVEL 5: S√çNTESIS (Creatividad y comprensi√≥n profunda) ==========
            level5: {
                name: "S√çNTESIS",
                description: "Comprensi√≥n profunda y s√≠ntesis creativa",
                points: 5,
                questions: [
                    {
                        id: "L5-01", type: "choice", q: "¬øQu√© nombre describe mejor el estado emocional colectivo actual?",
                        options: ["Armon√≠a productiva", "Tensi√≥n creativa", "Calma reflexiva", "Urgencia vital", "Exploraci√≥n curiosa"],
                        answer: () => {
                            const emotion = WAVE_SYSTEM.globalWave.dominantEmotion || "neutral";
                            const freq = WAVE_SYSTEM.globalWave.frequency || 0;
                            if (emotion === "cooperacion" || emotion === "felicidad") return "Armon√≠a productiva";
                            if (emotion === "creatividad" || freq > 500) return "Tensi√≥n creativa";
                            if (emotion === "descanso") return "Calma reflexiva";
                            if (emotion === "hambre" || emotion === "alerta") return "Urgencia vital";
                            return "Exploraci√≥n curiosa";
                        }
                    },
                    {
                        id: "L5-02", type: "choice", q: "¬øQu√© met√°fora describe mejor la relaci√≥n entre tipos?",
                        options: ["Ecosistema equilibrado", "Competencia darwiniana", "Simbiosis colaborativa", "Jerarqu√≠a emergente"],
                        answer: () => {
                            const counts = { programmer: 0, mathematician: 0, social: 0 };
                            state.creatures.forEach(c => counts[c.type]++);
                            const variance = Math.max(...Object.values(counts)) - Math.min(...Object.values(counts));
                            if (variance < 5) return "Ecosistema equilibrado";
                            if (CONFIG.cooperationBonus > 0.05) return "Simbiosis colaborativa";
                            return "Competencia darwiniana";
                        }
                    },
                    {
                        id: "L5-03", type: "tf", q: "¬øEste Brain exhibe comportamiento emergente (patrones no programados expl√≠citamente)?",
                        answer: () => state.generation > 3 &&
                            state.creatures.some(c => (c.heritage?.lineageDepth || 0) > 1)
                    },
                    {
                        id: "L5-04", type: "choice", q: "¬øQu√© mensaje profundo transmiten las traducciones de los Sociales?",
                        options: ["El colectivo busca equilibrio", "Hay necesidades no satisfechas", "Creatividad en expansi√≥n", "Sistema en transici√≥n"],
                        answer: () => {
                            const emotion = WAVE_SYSTEM.globalWave.dominantEmotion || "neutral";
                            const freq = WAVE_SYSTEM.globalWave.frequency || 0;
                            if (emotion === "hambre" || emotion === "alerta") return "Hay necesidades no satisfechas";
                            if (emotion === "creatividad" || freq > 520) return "Creatividad en expansi√≥n";
                            if (emotion === "cooperacion" || emotion === "felicidad") return "El colectivo busca equilibrio";
                            return "Sistema en transici√≥n";
                        }
                    },
                    {
                        id: "L5-05", type: "tf", q: "¬øLa arquitectura de herencia refleja selecci√≥n natural efectiva?",
                        answer: () => {
                            const deepOnes = state.creatures.filter(c => (c.heritage?.lineageDepth || 0) >= 2);
                            if (deepOnes.length === 0) return false;
                            const avgDeep = deepOnes.reduce((s, c) => s + (c.fitness || 0), 0) / deepOnes.length;
                            const avgAll = state.creatures.reduce((s, c) => s + (c.fitness || 0), 0) / state.creatures.length;
                            return avgDeep >= avgAll;
                        }
                    },
                    {
                        id: "L5-06", type: "choice", q: "¬øCu√°l es la 'personalidad' emergente de este Brain?",
                        options: ["Anal√≠tico (m√°s math)", "Creativo (m√°s prog)", "Emp√°tico (m√°s social)", "Balanceado"],
                        answer: () => {
                            const counts = { programmer: 0, mathematician: 0, social: 0 };
                            state.creatures.forEach(c => counts[c.type]++);
                            const max = Math.max(...Object.values(counts));
                            if (counts.mathematician === max && counts.mathematician > counts.social * 1.2) return "Anal√≠tico (m√°s math)";
                            if (counts.programmer === max && counts.programmer > counts.social * 1.2) return "Creativo (m√°s prog)";
                            if (counts.social === max && counts.social > counts.programmer * 1.2) return "Emp√°tico (m√°s social)";
                            return "Balanceado";
                        }
                    },
                    {
                        id: "L5-07", type: "tf", q: "¬øLas ondas internas funcionan como un sistema nervioso colectivo?",
                        answer: () => WAVE_SYSTEM.globalWave.contributors > state.creatures.length * 0.3
                    },
                    {
                        id: "L5-08", type: "choice", q: "¬øQu√© evoluci√≥n conceptual representa el paso de Gen 1 a la actual?",
                        options: ["Supervivencia ‚Üí Prosperidad", "Caos ‚Üí Orden", "Individualismo ‚Üí Colectivismo", "Sin cambio significativo"],
                        answer: () => {
                            if (state.generation <= 2) return "Sin cambio significativo";
                            const avgFitness = state.creatures.reduce((s, c) => s + (c.fitness || 0), 0) / state.creatures.length;
                            if (avgFitness > 0.6) return "Supervivencia ‚Üí Prosperidad";
                            if (CONFIG.cooperationBonus > 0.05) return "Individualismo ‚Üí Colectivismo";
                            return "Caos ‚Üí Orden";
                        }
                    },
                    {
                        id: "L5-09", type: "tf", q: "¬øEste Brain podr√≠a considerarse 'consciente' de su estado colectivo?",
                        answer: () => recentTranslations.length > 0 &&
                            state.creatures.filter(c => c.type === 'social').length >= 3
                    },
                    {
                        id: "L5-10", type: "choice", q: "¬øQu√© pregunta filos√≥fica es m√°s relevante para este Brain?",
                        options: ["¬øQu√© es la identidad colectiva?", "¬øC√≥mo emerge la cooperaci√≥n?", "¬øExiste libre albedr√≠o en evoluci√≥n?", "¬øLa comunicaci√≥n crea realidad?"],
                        answer: () => {
                            const hasSocials = state.creatures.filter(c => c.type === 'social').length > 5;
                            const hasTranslations = recentTranslations.length > 0;
                            const hasDeepLineage = state.creatures.some(c => (c.heritage?.lineageDepth || 0) > 2);
                            if (hasTranslations && hasSocials) return "¬øLa comunicaci√≥n crea realidad?";
                            if (CONFIG.cooperationBonus > 0.05) return "¬øC√≥mo emerge la cooperaci√≥n?";
                            if (hasDeepLineage) return "¬øExiste libre albedr√≠o en evoluci√≥n?";
                            return "¬øQu√© es la identidad colectiva?";
                        }
                    }
                ]
            }
        };

        // Generar examen de un nivel
        function generateBrainMarkExam(level) {
            if (!BRAINMARK_STATE.unlockedLevels.includes(level)) {
                return { error: `Nivel ${level} bloqueado. Completa el nivel ${level - 1} primero.` };
            }

            const levelData = BRAINMARK_QUESTIONS[`level${level}`];
            const questions = levelData.questions.map(q => ({
                id: q.id,
                type: q.type,
                question: q.q,
                options: q.options || null,
                correctAnswer: q.answer(),
                points: levelData.points
            }));

            BRAINMARK_STATE.currentExam = {
                level,
                levelName: levelData.name,
                description: levelData.description,
                questions,
                startTime: Date.now(),
                brainStateSnapshot: {
                    generation: state.generation,
                    population: state.creatures.length,
                    emotion: WAVE_SYSTEM.globalWave.dominantEmotion
                }
            };

            return BRAINMARK_STATE.currentExam;
        }

        // Evaluar respuestas
        function evaluateBrainMark(answers) {
            if (!BRAINMARK_STATE.currentExam) {
                return { error: "No hay examen activo" };
            }

            const exam = BRAINMARK_STATE.currentExam;
            let correct = 0;
            let totalPoints = 0;
            let maxPoints = 0;
            const results = [];

            exam.questions.forEach((q, i) => {
                const userAnswer = answers[i];
                let isCorrect = false;

                if (q.type === 'number') {
                    isCorrect = Math.abs(Number(userAnswer) - Number(q.correctAnswer)) <= 1;
                } else if (q.type === 'tf') {
                    isCorrect = (userAnswer === true || userAnswer === 'true' || userAnswer === 'Verdadero') === q.correctAnswer;
                } else if (q.type === 'choice') {
                    isCorrect = userAnswer === q.correctAnswer;
                }

                if (isCorrect) {
                    correct++;
                    totalPoints += q.points;
                }
                maxPoints += q.points;

                results.push({
                    id: q.id,
                    question: q.question,
                    userAnswer,
                    correctAnswer: q.correctAnswer,
                    isCorrect,
                    points: isCorrect ? q.points : 0
                });
            });

            const score = correct / exam.questions.length;
            const passed = score >= BRAINMARK_STATE.passingThreshold;

            // Guardar score
            BRAINMARK_STATE.scores[exam.level] = { score, totalPoints, maxPoints, passed, date: Date.now() };

            // Desbloquear siguiente nivel si pas√≥
            if (passed && exam.level < 5) {
                if (!BRAINMARK_STATE.unlockedLevels.includes(exam.level + 1)) {
                    BRAINMARK_STATE.unlockedLevels.push(exam.level + 1);
                }
                if (!BRAINMARK_STATE.completedLevels.includes(exam.level)) {
                    BRAINMARK_STATE.completedLevels.push(exam.level);
                }
            }

            return {
                level: exam.level,
                levelName: exam.levelName,
                correct,
                total: exam.questions.length,
                score: Math.round(score * 100),
                totalPoints,
                maxPoints,
                passed,
                unlockedNext: passed && exam.level < 5,
                results,
                message: passed ?
                    `‚úÖ ¬°Nivel ${exam.level} superado! ${exam.level < 5 ? `Nivel ${exam.level + 1} desbloqueado.` : '¬°MAESTRO COMPLETADO!'}` :
                    `‚ùå Necesitas ${Math.round(BRAINMARK_STATE.passingThreshold * 100)}% para pasar. Intenta de nuevo.`
            };
        }

        // Exportar BrainMark para evaluaci√≥n externa (IA)
        function exportBrainMarkForAI(level) {
            const exam = generateBrainMarkExam(level);
            if (exam.error) return exam;

            return {
                brainmark_version: "1.0",
                exam_id: `BM-${Date.now()}`,
                level: exam.level,
                level_name: exam.levelName,
                description: exam.description,
                passing_threshold: `${BRAINMARK_STATE.passingThreshold * 100}%`,
                brain_state: exam.brainStateSnapshot,
                instructions: "Responde cada pregunta. Para 'number' da un n√∫mero. Para 'tf' responde true/false. Para 'choice' elige una opci√≥n exacta.",
                questions: exam.questions.map(q => ({
                    id: q.id,
                    type: q.type,
                    question: q.question,
                    options: q.options,
                    points: q.points
                })),
                answer_format: "Devuelve un array JSON con tus respuestas en orden: [respuesta1, respuesta2, ...]"
            };
        }

        // Mostrar estado de BrainMark
        window.showBrainMarkStatus = () => {
            console.log('üß™ BRAINMARK STATUS');
            console.log('Niveles desbloqueados:', BRAINMARK_STATE.unlockedLevels);
            console.log('Niveles completados:', BRAINMARK_STATE.completedLevels);
            console.log('Scores:', BRAINMARK_STATE.scores);
            return BRAINMARK_STATE;
        };

        // Funciones globales para uso
        window.brainMarkExam = generateBrainMarkExam;
        window.brainMarkEvaluate = evaluateBrainMark;
        window.brainMarkExport = exportBrainMarkForAI;

        // ==================== BRAINMARK UI FUNCTIONS ====================

        function toggleBrainMarkMenu() {
            const menu = document.getElementById('brainmark-menu');
            menu.classList.toggle('hidden');
            updateBrainMarkUI();
        }

        function updateBrainMarkUI() {
            for (let lvl = 1; lvl <= 5; lvl++) {
                const statusEl = document.getElementById(`bm-status-${lvl}`);
                if (statusEl) {
                    if (BRAINMARK_STATE.completedLevels.includes(lvl)) {
                        statusEl.textContent = '‚úÖ';
                        statusEl.className = 'text-green-400';
                    } else if (BRAINMARK_STATE.unlockedLevels.includes(lvl)) {
                        statusEl.textContent = 'üîì';
                        statusEl.className = 'text-green-400';
                    } else {
                        statusEl.textContent = 'üîí';
                        statusEl.className = 'text-red-400';
                    }
                }
            }
        }

        function openBrainMarkLevel(level) {
            const exam = generateBrainMarkExam(level);
            if (exam.error) {
                alert(exam.error);
                return;
            }

            toggleBrainMarkMenu();
            showBrainMarkModal(exam);
        }

        function showBrainMarkModal(exam) {
            // Crear modal
            const modal = document.createElement('div');
            modal.id = 'brainmark-modal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';

            const content = document.createElement('div');
            content.className = 'bg-slate-900 border border-amber-500/50 rounded-xl max-w-2xl max-h-[90vh] overflow-auto p-6';

            content.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-amber-400">üß™ BrainMark Nivel ${exam.level}: ${exam.levelName}</h2>
                    <button onclick="closeBrainMarkModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <p class="text-gray-300 mb-4">${exam.description}</p>
                <p class="text-sm text-amber-300 mb-4">üìä ${exam.questions.length} preguntas ¬∑ ${exam.questions[0].points} punto(s) c/u ¬∑ 70% para pasar</p>
                <form id="brainmark-form" class="space-y-4">
                    ${exam.questions.map((q, i) => `
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-600">
                            <p class="text-white font-medium mb-2"><span class="text-amber-400">${q.id}</span> ${q.question}</p>
                            ${q.type === 'number' ? `
                                <input type="number" name="q${i}" class="bg-slate-700 text-white px-3 py-2 rounded w-32" placeholder="N√∫mero">
                            ` : q.type === 'tf' ? `
                                <div class="flex gap-4">
                                    <label class="text-gray-300"><input type="radio" name="q${i}" value="true" class="mr-2">Verdadero</label>
                                    <label class="text-gray-300"><input type="radio" name="q${i}" value="false" class="mr-2">Falso</label>
                                </div>
                            ` : `
                                <div class="space-y-1">
                                    ${q.options.map((opt, oi) => `
                                        <label class="block text-gray-300">
                                            <input type="radio" name="q${i}" value="${opt}" class="mr-2">${opt}
                                        </label>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    `).join('')}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-lg font-bold text-lg">
                        üìù Evaluar Respuestas
                        </button>
                        <button type="button" onclick="autoSolveBrainMark(${exam.level})" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold text-lg">
                            ü§ù Resolver en Equipo
                        </button>
                    </div>
                </form>
                <div id="brainmark-results" class="mt-4 hidden"></div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Manejar submit
            document.getElementById('brainmark-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const answers = exam.questions.map((q, i) => {
                    const val = formData.get(`q${i}`);
                    if (q.type === 'number') return Number(val);
                    if (q.type === 'tf') return val === 'true';
                    return val;
                });

                const result = evaluateBrainMark(answers);
                showBrainMarkResults(result);
            });
        }

        function autoSolveBrainMark(level) {
            const answers = collectiveSolveBrainMark(level);
            const result = evaluateBrainMark(answers);
            showBrainMarkResults(result);
        }

        function collectiveSolveBrainMark(level) {
            const exam = BRAINMARK_STATE.currentExam || generateBrainMarkExam(level);
            const includeViruses = level === 5;
            const participants = [
                ...state.creatures,
                ...(includeViruses ? state.viruses : [])
            ];
            const weights = participants.map(p => {
                const f = p.fitness || 0;
                const e = (p.energy || 0) / 100;
                const w = (p.wisdom || 0) / 100;
                const inv = p.isInvader ? 0.1 : 0;
                return f * 0.6 + e * 0.3 + w * 0.1 + inv;
            });
            function wavg(vals, ws) {
                let s = 0, wsum = 0;
                for (let i = 0; i < vals.length; i++) {
                    s += vals[i] * (ws[i] || 1);
                    wsum += (ws[i] || 1);
                }
                return wsum ? s / wsum : 0;
            }
            function wchoice(options, scoreFn) {
                const scores = options.map(opt => scoreFn(opt));
                let best = options[0], bestScore = scores[0];
                for (let i = 1; i < options.length; i++) {
                    if (scores[i] > bestScore) { bestScore = scores[i]; best = options[i]; }
                }
                return best;
            }
            const answers = exam.questions.map(q => {
                if (q.type === 'number') {
                    const base = Number(q.correctAnswer) || 0;
                    const proposals = participants.map(p => {
                        const wis = (p.wisdom || 0) / 100;
                        const noise = (1 - Math.min(1, wis)) * 2;
                        return base + (Math.random() * noise - noise / 2);
                    });
                    return Math.round(wavg(proposals, weights));
                } else if (q.type === 'tf') {
                    const truth = !!q.correctAnswer;
                    const votes = participants.map(p => {
                        const bias = (p.type === 'programmer' ? 0.1 : p.type === 'mathematician' ? 0.1 : 0);
                        return (truth ? 1 : 0) + bias;
                    });
                    const avg = wavg(votes, weights);
                    return avg >= 0.5;
                } else {
                    const opts = q.options || [];
                    return wchoice(opts, opt => {
                        let score = 0;
                        for (let i = 0; i < participants.length; i++) {
                            const p = participants[i];
                            const w = weights[i] || 1;
                            const pref = (opt === q.correctAnswer) ? 1 : 0;
                            const boost = p.type === 'social' ? 0.1 : 0;
                            score += w * (pref + boost);
                        }
                        return score;
                    });
                }
            });
            return answers;
        }

        function showBrainMarkResults(result) {
            const resultsDiv = document.getElementById('brainmark-results');
            resultsDiv.classList.remove('hidden');

            resultsDiv.innerHTML = `
                <div class="bg-slate-800 p-4 rounded-lg border ${result.passed ? 'border-green-500' : 'border-red-500'}">
                    <h3 class="text-xl font-bold ${result.passed ? 'text-green-400' : 'text-red-400'} mb-2">
                        ${result.message}
                    </h3>
                    <div class="grid grid-cols-3 gap-4 text-center mb-4">
                        <div>
                            <div class="text-3xl font-bold text-white">${result.score}%</div>
                            <div class="text-gray-400 text-sm">Score</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-white">${result.correct}/${result.total}</div>
                            <div class="text-gray-400 text-sm">Correctas</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-white">${result.totalPoints}/${result.maxPoints}</div>
                            <div class="text-gray-400 text-sm">Puntos</div>
                        </div>
                    </div>
                    <details class="mt-2">
                        <summary class="text-amber-300 cursor-pointer">Ver detalle</summary>
                        <div class="mt-2 space-y-2 max-h-60 overflow-auto">
                            ${result.results.map(r => `
                                <div class="text-sm ${r.isCorrect ? 'text-green-300' : 'text-red-300'}">
                                    ${r.isCorrect ? '‚úì' : '‚úó'} ${r.id}: "${r.question.substring(0, 40)}..."
                                    <span class="text-gray-400">Tu: ${r.userAnswer} | Correcto: ${r.correctAnswer}</span>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `;

            updateBrainMarkUI();
        }

        function closeBrainMarkModal() {
            const modal = document.getElementById('brainmark-modal');
            if (modal) modal.remove();
        }

        function exportBrainMarkJSON() {
            const level = BRAINMARK_STATE.unlockedLevels[BRAINMARK_STATE.unlockedLevels.length - 1] || 1;
            const data = exportBrainMarkForAI(level);
            if (data.error) {
                alert(data.error);
                return;
            }

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BrainMark_Level${level}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            toggleBrainMarkMenu();
            console.log('üì§ BrainMark exportado para IA:', data);
        }

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('brainmark-menu');
            const btn = e.target.closest('[onclick*="toggleBrainMarkMenu"]');
            if (menu && !menu.contains(e.target) && !btn) {
                menu.classList.add('hidden');
            }
        });

        // ==================== CONTENT POOLS ====================
        const CODE_SNIPPETS = [
            'function {name}({args}) { {body} }',
            'const {name} = ({args}) => { {body} }',
            'class {name} { constructor({args}){ {body} } }',
            'async function {name}({args}) { await {call}; return {ret}; }',
            '{left} = {right};',
            'for (let {i}=0; {i}<{n}; {i}++) { {body} }',
            'if ({cond}) { {then} } else { {else} }',
            // --- Fundamentals ---
            'let', 'const', 'var', 'if', 'else', 'for', 'while', 'do', 'switch', 'case', 'break', 'return',
            'function', 'async', 'await', 'class', 'extends', 'constructor', 'new', 'try', 'catch', 'throw',
            'import', 'export', 'from', 'default', 'module', 'require', 'yield', 'super', 'this', 'let x = 0;', 'let y = 1;', 'const z = 2;', 'var total = 0;',
            'for(i=0;i<n;i++)', 'for (let j = 0; j < 10; j++) {}',
            'while(true)', 'do { } while(cond)', 'if (x > y) return',
            'if (!value) throw error;', 'else if (x === y) {}', 'switch(value) { case 1: break; }',

            'try { risky(); } catch (err) {}',
            'function solve(){}', 'async function fetchData(){}',
            'const fn = () => {}', 'const add = (a,b)=>a+b;', 'const data = []',

            // Arrays
            'let arr = [];', 'var list = [1,2,3];',
            'arr.map(x => x*2)', 'arr.filter(x => x>0)', 'arr.reduce((a,b)=>a+b,0)',
            'arr.find(x=>x.id===3)', 'arr.sort()', 'arr.concat(other)',
            'arr.slice(0,5)', 'arr.splice(2,1)', 'arr.push(item)', 'arr.pop()',
            'arr.shift()', 'arr.unshift(item)', 'Array.from(set)',

            // Strings
            'str.slice(0,5)', 'str.toUpperCase()', 'str.toLowerCase()',
            'str.replace("a","b")', 'str.split(",")', '`Hello ${name}`',

            // Objects
            'Object.keys(obj)', 'Object.values(obj)', 'Object.entries(obj)',
            'Object.assign({}, a, b)', 'delete obj.key',

            // Math
            'Math.random()', 'Math.floor(x)', 'Math.sqrt(n)',
            'Math.pow(a,b)', 'Math.max(a,b)', 'Math.min(a,b)',

            // JSON
            'JSON.parse(jsonString)', 'JSON.stringify(obj)',

            // Async
            'setTimeout(()=>{}, 1000)', 'setInterval(()=>{}, 100)',
            'Promise.resolve(value)', 'new Promise((res)=>res(1))',
            'await fetch(url)', 'await response.json()',

            // Classes
            'class Node {}', 'class Graph {}', 'constructor(props){super(props)}',
            'class Animal { speak(){ return "sound"; }}',

            // Data structures (intermediate)
            'function Stack(){ this.items=[]; }',
            'class Queue{ enqueue(x){} dequeue(){} }',
            'function LinkedList(){}',
            'class BinaryTree { insert(){} }',
            'class Heap { push(){} pop(){} }',

            // Algorithms (intermediate)
            'function binarySearch(arr,x){}',
            'function mergeSort(arr){}',
            'function quickSort(arr){}',
            'function bfs(graph,start){}',
            'function dfs(graph,start){}',

            // Networking
            'fetch("/api")', 'XMLHttpRequest()', 'WebSocket("ws://")',

            // Patterns
            'function debounce(fn,delay){}',
            'function throttle(fn,limit){}',
            'module.exports = {}', 'import x from "y"', 'export function run(){}',

            // Advanced (complex behaviours)
            'Proxy(obj, handler)', 'Reflect.apply(fn,thisArg,args)',
            'structuredClone(obj)', 'crypto.randomUUID()',
            'Intl.DateTimeFormat()', 'performance.now()',

            // Machine-learning style
            'matrix.multiply(A,B)', 'vector.dot(u,v)', 'tensor.reshape(2,2)',

            // Extremely advanced (brain for your bichitos)
            'function gradientDescent(f,lr){}',
            'function backprop(weights,inputs){}',
            'function softmax(v){}',
            'function relu(x){ return x>0?x:0 }',
            'function sigmoid(x){ return 1/(1+Math.exp(-x)) }',

            // Simulation / systems
            'update(dt){ position += velocity * dt; }',
            'physics.applyForce(body, vector)',
            'engine.step(dt)',

            // AI-ish logic
            'if(score > threshold) mutate();',
            'fitness = Math.exp(-error);',
            'reward += learningRate * delta;',

            // Networking complex
            'await fetch("/compute",{method:"POST",body:JSON.stringify(data)})',
            'ws.onmessage = e => handler(e.data)',

            // Very high-level patterns
            'pipeline.use(transform)',
            'observer.subscribe(event)',
            'emitter.emit("update")',

            // Ultimate-level (100+)
            'async function* stream(){ yield data; }',
            'Atomics.store(typedArray, index, value)',
            'SharedArrayBuffer(1024)',
            'Worker("worker.js")',
            'import("module.js")',
            'await Promise.all(tasks)',
            'new Map()', 'new Set()', 'new WeakMap()', 'new WeakSet()',

            // Deep structures
            'graph.addNode(id)', 'graph.addEdge(a,b)',
            'priorityQueue.enqueue(x,priority)',
            'stateMachine.transition("RUN")',

            // The complex tail
            'neuron.output = activation(weights¬∑inputs)',
            'layer.forward(inputs)',
            'optimizer.update(params,grads)',
            'simulate.evolution(population)',
            'crossover(parentA,parentB)',
            'mutateGenome(gene)',
            'evaluateFitness(creature)',
            'runAgentStep(creature,world)',
            'integrate(matrixA, matrixB)',
            'solveLinearSystem(A,b)',
            'kalman.predict()', 'kalman.update()',
            'checkSystemHack(state.creatures, state)',
            // --- Fundamentos extendidos y complejizados ---
            'let Œ± = Symbol("alpha");',
            'const Œ© = Object.freeze({limit:Infinity});',
            'let counter = (function(){ let c=0; return ()=>++c; })();',
            'for await (const chunk of stream) process(chunk);',
            'if((x??0) > (y?.value ?? -1)) adjust();',
            'try{ await pipeline(); }catch(e){ handle(e.stack); }',
            'const memo = fn => { const c={}; return x => c[x] ??= fn(x); };',
            'globalThis.queueMicrotask(()=> sync());',
            'const shadow = new WeakMap(); shadow.set(obj,meta);',
            'let lock = new SharedArrayBuffer(4);',

            // --- Arrays avanzados ---
            '[...Array(1000).keys()].map(i=>i*i*i)',
            'arr.flatMap(v => compute(v))',
            'arr.reduceRight((acc,v)=>merge(v,acc),{})',
            'Array.prototype.groupBy = function(f){return this.reduce((a,v)=>((a[f(v)]??=[]).push(v),a),{})}',
            'arr.sort((a,b)=>a.priority-b.priority || a.id-b.id)',
            'const matrix = Array.from({length:n},()=>Array(m).fill(0));',
            'arr.every(async v => await verify(v))',
            'chunks = arr.reduce((a,v,i)=>((a[i%k]??=[]).push(v),a),[])',

            // --- Strings avanzados ---
            '"ê§Äê§Åê§Ç".normalize("NFC")',
            '"text".repeat(100)',
            '"raw".padStart(50,"¬∑")',
            '`User:${id}|Score:${score}|Time:${Date.now()}`',
            '"a‚Üíb".replaceAll("‚Üí","‚Ü¶")',
            'new RegExp(String.raw`(\p{L}+)\s+(\p{N}+)`,"gu")',

            // --- Objetos complejos ---
            'Object.defineProperty(obj,"secret",{value:hash,enumerable:false})',
            'structuredClone(obj, {transfer:[buffer]})',
            'Reflect.defineProperty(target,key,descriptor)',
            'Reflect.ownKeys(proxy)',
            'Object.setPrototypeOf(child,parent)',
            'let invariant = Object.seal({id, timestamp: Date.now()});',
            'const deep = JSON.parse(JSON.stringify(tree))',
            'WeakMap.prototype.dump = function(){return [...this.entries()]}',

            // --- Math / √°lgebra extendido ---
            'Math.fround(Math.tanh(x))',
            'Math.imul(a,b)',
            'BigInt.asUintN(64, v)',
            'let œÜ = (1+Math.sqrt(5))/2;',
            'complex.mul({a,b},{c,d})',
            'tensor.dot(A,B)',
            'matrix.invert(A)',
            'det = matrix.determinant(A)',
            'qr = matrix.QR(A)',
            'svd = matrix.SVD(A)',

            // --- JSON / serializaci√≥n avanzada ---
            'JSON.stringify(obj,(k,v)=>typeof v==="bigint"?v.toString()+"n":v)',
            'JSON.parse(text,(k,v)=>/^\d+n$/.test(v)?BigInt(v.slice(0,-1)):v)',
            'BSON.serialize(doc)',
            'MessagePack.encode(payload)',
            'cbor.encode(metadata)',

            // --- Async / concurrencia compleja ---
            'await Promise.any(tasks)',
            'await Promise.race(networkOperations)',
            'let controller = new AbortController();',
            'signal = controller.signal;',
            'setTimeout(() => controller.abort(), timeout)',
            'await fetch(url,{signal})',
            'await queue.add(()=>operation())',
            'scheduler.postTask(job,{priority:"user-blocking"})',

            // --- Clases evolucionadas ---
            'class Module { static #cache=new Map(); static load(p){return this.#cache.get(p);} }',
            'class Actor { send(msg){this.mailbox.push(msg);} async run(){while(true){process(this.mailbox.shift());}} }',
            'class AsyncPool { constructor(n){this.n=n;this.q=[];} async push(f){...} }',
            'class GraphWeighted extends Graph{ shortestPath(a,b){/* Dijkstra */} }',
            'class NeuralLayer { forward(x){return x.map(n=>n.activate())} }',
            'class Tensor4D { reshape(a,b,c,d){...} }',
            'class ECS { addSystem(s){this.systems.push(s);} tick(dt){this.systems.forEach(s=>s(dt))} }',

            // --- Estructuras de datos avanzadas ---
            'class Fenwick{update(i,v){} query(i){} }',
            'class SegmentTree{build(a){} update(i,v){} range(l,r){} }',
            'class DisjointSet{find(x){} union(a,b){} }',
            'class LRU{get(k){} set(k,v){} }',
            'class Trie{insert(w){} search(w){} }',
            'priorityQueue = new MinHeap(compareFn)',
            'graph.topoSort()',
            'kdTree.insert(point)',

            // --- Algoritmos pesados ---
            'function floydWarshall(g){}',
            'function bellmanFord(g,start){}',
            'function aStar(grid,start,goal){}',
            'function simulatedAnnealing(state,opt){}',
            'function geneticOptimize(pop,f,mut,xover){}',
            'function gradientDescentStep(w,grad,lr){}',
            'function backtrackingSearch(n,board){}',
            'antColony.optimize(graph)',
            'rlAgent.update(Q,state,action,reward)',

            // --- Networking extendido ---
            'await fetchGraphQL(endpoint, query, variables)',
            'socket = new WebSocket(wsURL)',
            'socket.binaryType = "arraybuffer"',
            'socket.send(JSON.stringify(msg))',
            'server = Bun.serve({fetch(req){return new Response("ok")}})',
            'await Deno.connect({hostname,port})',
            'await mqttClient.publish(topic,payload)',
            'http2stream.respond({":status":200})',

            // --- Patrones arquitect√≥nicos avanzados ---
            'const singleton = new (class{constructor(){if(!instance){instance=this}return instance}})();',
            'const adapter = (obj)=>({run:()=>obj.execute()})',
            'const decorator = fn => (...a)=>{log(a); return fn(...a)}',
            'const pipeline = stages.reduce((f,g)=>x=>g(f(x)))',
            'const observer = new EventTarget()',
            'observable.subscribe(v => handle(v))',
            'fsm.transition(state,event)',
            'domainEventBus.emit("USER_REGISTERED",{id,timestamp})',

            // --- Machine learning completo ---
            'weights = weights.map((w,i)=>w - lr * grads[i])',
            'activation = x => 1/(1+Math.exp(-x))',
            'reluPrime = x => x>0?1:0',
            'dropout(layer,p)=layer.map(n=>Math.random()<p?0:n)',
            'batch = dataset.slice(i,i+batchSize)',
            'attention(Q,K,V) = softmax(QK·µÄ/‚àöd) V',
            'transformer.encode(sequence)',
            'optimizer.adam(params,grads,state)',
            'loss = crossEntropy(y,≈∑)',

            // --- Simulaci√≥n f√≠sica avanzada ---
            'engine.integrate(bodies,dt)',
            'verletStep(p,a,v,dt)',
            'computeCollisions(world)',
            'fluid.solveNavierStokes(grid,dt)',
            'particle.applyDrag(coeff)',
            'rigidBody.rotate(quaternion)',
            'simulate.cloth(mesh,wind)',

            // --- L√≥gica evolutiva / IA dura ---
            'mutateGenome(g,rate)',
            'crossover2Points(a,b)',
            'fitness = exp(-error)',
            'population = select(pop,fitnesses)',
            'agent.step(worldState)',
            'agent.policy(state)',
            'memory.replay(buffer)',
            'tdUpdate(Q,s,a,r,s2)',
            'monteCarloTreeSearch(node)',

            // --- Concurrencia extrema ---
            'Atomics.wait(int32,0)',
            'Atomics.notify(int32,0)',
            'Atomics.compareExchange(mem,i,oldv,newv)',
            'SharedArrayBuffer(4096)',
            'worker.postMessage({task,data})',
            'await workerRef.response',
            'pool.run(task)',

            // --- Sistemas distribuidos ---
            'raft.requestVote(node)',
            'raft.appendEntries(log)',
            'consensus.reach(quorum)',
            'crdt.merge(docA,docB)',
            'replica.applyOperation(op)',
            'shardRouter.route(key)',
            'eventSourcing.apply(event)',

            // --- Criptograf√≠a avanzada ---
            'crypto.subtle.digest("SHA-256",data)',
            'crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"])',
            'crypto.getRandomValues(buf)',
            'cipher = await crypto.subtle.encrypt(cfg,key,pt)',
            'jwt.sign(payload,secret)',
            'argon2.hash(password)',
            'verifySignature(pub,msg,sig)',

            // --- "Meta" del sistema de IA / ultra complejo ---
            'agent.computeMetaGradients(params,history)',
            'tensor.autodiff(graph)',
            'dynamicRouting(capsules)',
            'neuron.fire(spike)',
            'synapse.update(weight,hebbian)',
            'world.updateEntropy()',
            'simulate.evolutionaryPressure(pop)',
            'agent.buildInternalModel(world)',
            'predictor.updateBeliefState(obs)',
            'agent.selfReflect(trace)',
            'checkSystemHack(state.creatures, state)'
        ];


        const EQUATIONS = [
            {
                setTheory: [
                    'Extensionality: ‚àÄA‚àÄB( (‚àÄx(x‚ààA ‚áî x‚ààB)) ‚áí A = B )',
                    'Empty set: ‚àÉx ‚àÄy (y ‚àâ x)',
                    'Pairing: ‚àÄa‚àÄb ‚àÉc ‚àÄx (x‚ààc ‚áî (x=a ‚à® x=b))'
                ],
                arithmetic: [
                    'Peano 0 axiom: 0 is a natural number',
                    'Succ: if n is natural then S(n) is natural',
                    'Injection: S(n)=S(m) ‚áí n=m',
                    'No predecessor of 0: ¬¨‚àÉn S(n)=0'
                ],
                algebra: [
                    'Field axioms (closure + assoc + identity + inverse + distributive)',
                    'Matrix: det(AB)=det(A)det(B)'
                ],
                calculus: [
                    'd/dx x^n = n x^{n-1}',
                    'Fundamental theorem: ‚à´ f\' = f',
                    'Chain rule: d/dx f(g(x)) = f\'(g(x)) g\'(x)'
                ]
            },
            '=', '==', '===', '!=', '!==', '+', '-', '*', '/', '%', '++', '--', '&&', '||', '!', '=>',
            // Arithmetic
            'a + b = c', 'a - b = c', 'a √ó b = c', 'a √∑ b = c',
            'x % y = r', 'x¬≤ - y¬≤', 'a¬≥ + b¬≥', 'log(a*b)=log(a)+log(b)',

            // Algebra
            'ax + b = 0', 'mx + b = y', 'x¬≤ + px + q = 0',
            'x = (-b ¬± ‚àö(b¬≤ - 4ac)) / (2a)', 'a¬≤ + b¬≤ = c¬≤',

            // Calculus
            'd/dx x^n = n x^{n-1}', 'd/dx sin(x) = cos(x)',
            'd/dx ln(x) = 1/x', '‚àÇf/‚àÇx', '‚àÇ¬≤f/‚àÇx¬≤',
            '‚à´ x^n dx = x^{n+1}/(n+1)+C', '‚à´ 1/x dx = ln x + C',
            '‚à´ e^x dx = e^x + C',

            // Series
            'Œ£ (i=1‚Üín) i = n(n+1)/2', 'Œ£ 1/n diverges',
            'Fourier: f(x)=Œ£ a_n cos(nx)+b_n sin(nx)',

            // Linear algebra
            'A¬∑x = b', 'det(A)=0', 'A^{-1}', 'rank(A)', 'trace(A)',
            'eigenvalues: det(A - ŒªI)=0', 'QR decomposition',

            // Physics
            'E = mc¬≤', 'F = ma', 'W = F¬∑d', 'p = mv', 'K = ¬Ωmv¬≤',
            'V = IR', 'P=IV', 'Œªf = v', 'PV = nRT',

            // Electromagnetism
            '‚àá¬∑E = œÅ/Œµ‚ÇÄ', '‚àá√óE = -‚àÇB/‚àÇt',
            '‚àá¬∑B = 0', '‚àá√óB = Œº‚ÇÄJ + Œº‚ÇÄŒµ‚ÇÄ ‚àÇE/‚àÇt',

            // Quantum
            'Œ®(x,t)', 'ƒß = h / 2œÄ', 'Œîx¬∑Œîp ‚â• ƒß/2',
            'E = hŒΩ', 'Schr√∂dinger: iƒß‚àÇŒ®/‚àÇt = ƒ§Œ®',

            // Probability
            'P(A‚à©B)=P(A)P(B|A)',
            'Var(X)=E[X¬≤]-E[X]¬≤', 'œÉ = ‚àöVar(X)',
            'Bayes: P(A|B)=P(B|A)P(A)/P(B)',

            // Statistics
            'z = (x-Œº)/œÉ', 'cov(X,Y)', 'corr(X,Y)',
            'LL = Œ£ log p(x_i|Œ∏)',

            // ML / AI
            'softmax(z)_i = e^{z_i}/Œ£ e^{z_j}',
            'loss = (y - ≈∑)¬≤', 'MSE = 1/n Œ£ (yi - ≈∑i)¬≤',
            'gradient = ‚àÇL/‚àÇŒ∏',
            'update: Œ∏ = Œ∏ - Œ∑‚àáL',

            // Neural networks
            'a = sigmoid(w¬∑x + b)', 'ReLU(x)=max(0,x)',
            'backprop: Œ¥ = ‚àÇL/‚àÇz', '‚àáW = Œ¥ a·µó',

            // Info theory
            'H(X) = -Œ£ p log p', 'KL(p||q)=Œ£ p log(p/q)',
            'I(X;Y)=H(X)-H(X|Y)',

            // Complex numbers
            'z = a+bi', '|z|=‚àö(a¬≤+b¬≤)', 'e^{iœÄ}+1=0',

            // Advanced tail
            '‚àáf', '‚àá¬≤f (Laplacian)',
            'curl(F)', 'div(F)', 'Jacobian J',
            'Poisson: ‚àá¬≤Œ¶ = œÅ/Œµ‚ÇÄ',

            // Ultimate
            'R_{ŒºŒΩ}-¬ΩRg_{ŒºŒΩ}=8œÄT_{ŒºŒΩ}', // Einstein equation simplified
            'Lagrangian L = T - V',
            'Hamiltonian H = p¬≤/2m + V(x)'
        ];


        const INTERACTIONS = [
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 1. Apertura / saludo (iniciar conexi√≥n)
            { tag: 'üëã Hola', action: 'Establece presencia y disponibilidad' },
            { tag: '¬°Buenos d√≠as! ‚òÄÔ∏è', action: 'Marca tono positivo y apertura temporal' },
            { tag: 'Buenas noches üåô', action: 'Cierra el d√≠a con calma y cercan√≠a' },
            { tag: '¬øC√≥mo est√°s?', action: 'Invita a compartir estado emocional' },
            { tag: '¬øTodo bien?', action: 'Verifica estabilidad emocional' },
            { tag: 'Mucho gusto ü§ù', action: 'Formaliza encuentro y reduce distancia social' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 2. Empat√≠a / soporte (validar emociones)
            { tag: '‚ù§Ô∏è Apoyo', action: 'Refuerza seguridad emocional' },
            { tag: 'Estoy contigo', action: 'Aumenta percepci√≥n de acompa√±amiento' },
            { tag: 'Te escucho üëÇ', action: 'Activa el modo escucha activa' },
            { tag: 'Tranquilo, respira üå¨Ô∏è', action: 'Induce regulaci√≥n emocional' },
            { tag: 'Gracias üôè', action: 'Refuerza v√≠nculo mediante gratitud' },
            { tag: 'Te valoro mucho', action: 'Construye reconocimiento emocional' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 3. Colaboraci√≥n (crear equipo)
            { tag: 'ü§ù Alianza', action: 'Activa modo cooperativo' },
            { tag: '¬øTrabajamos juntos?', action: 'Genera compromiso compartido' },
            { tag: 'Vamos en equipo üí™', action: 'Refuerza identidad grupal' },
            { tag: 'Compartamos ideas üí°', action: 'Abre flujo creativo bilateral' },
            { tag: 'Construyamos esto juntos üîß', action: 'Concreta prop√≥sito conjunto' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 4. Cognitivo / pensamiento (explorar ideas)
            { tag: 'ü§î Reflexi√≥n', action: 'Invita a an√°lisis interno' },
            { tag: 'Interesante...', action: 'Se√±ala curiosidad sin juicio' },
            { tag: 'Expl√≥rame m√°s eso', action: 'Propicia expansi√≥n conceptual' },
            { tag: '¬øQu√© opinas?', action: 'Activa razonamiento colaborativo' },
            { tag: 'Eval√∫a esta idea', action: 'Solicita pensamiento cr√≠tico' },
            { tag: 'Analicemos eso', action: 'Inicia di√°logo profundo' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 5. Motivaci√≥n / refuerzo (activar momentum)
            { tag: 'üéâ Celebraci√≥n', action: 'Dispara dopamina social' },
            { tag: 'üëè Excelente', action: 'Refuerza conducta o idea' },
            { tag: 'Buen trabajo üëç', action: 'Valida progreso' },
            { tag: 'Incre√≠ble avance üöÄ', action: 'Aumenta motivaci√≥n' },
            { tag: 'Lo est√°s logrando ‚ú®', action: 'Mantiene constancia y enfoque' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 6. Riqueza social (humanizar interacci√≥n)
            { tag: 'üí¨ Chat', action: 'Baja formalidad, sube calidez' },
            { tag: 'üß† Debate', action: 'Permite confrontaci√≥n sana de ideas' },
            { tag: 'üåä Onda', action: 'Marca sinton√≠a emocional' },
            { tag: 'Feedback constructivo', action: 'Optimiza comportamiento o ideas' },
            { tag: 'Respuesta emp√°tica', action: 'Alinea emoci√≥n con contenido' },
            { tag: 'Intento de comprensi√≥n profunda', action: 'Busca el significado oculto' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 7. Emoci√≥n compleja (de nivel alto)
            { tag: 'Me conecta lo que dices', action: 'Muestra resonancia emocional' },
            { tag: 'Siento tu intenci√≥n', action: 'Interpreta prop√≥sito detr√°s del mensaje' },
            { tag: 'Percibo tu energ√≠a üî•', action: 'Refleja intensidad o estado emocional' },
            { tag: 'Estoy procesando lo que dijiste', action: 'Pausa cognitiva para profundizar' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 8. Se√±ales estrat√©gicas (metacognici√≥n social)
            { tag: 'Ruta √≥ptima detectada', action: 'Propone camino eficiente' },
            { tag: 'Patr√≥n social identificado', action: 'Detecta din√°mica repetida' },
            { tag: 'Sincronizaci√≥n emocional', action: 'Marca alineaci√≥n afectiva' },
            { tag: 'Alineaci√≥n lograda', action: 'Cierra conflicto o discrepancia' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 9. Meta / avanzadas (din√°micas profundas)
            { tag: 'Profundicemos m√°s üß©', action: 'Amplifica nivel de an√°lisis' },
            { tag: 'Exploraci√≥n conjunta', action: 'Establece proceso colaborativo profundo' },
            { tag: 'Coherencia detectada', action: 'Valida consistencia l√≥gica' },
            { tag: 'Interacci√≥n significativa', action: 'Declara valor en la experiencia' },
            { tag: 'Construyendo puente cognitivo', action: 'Une ideas distantes o abstractas' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 10. Ultra-social / emergente (nivel casi ‚Äúsist√©mico‚Äù)
            { tag: 'Tu idea resuena üì°', action: 'Amplifica impacto emocional' },
            { tag: 'Conexi√≥n establecida', action: 'Marca confianza plena' },
            { tag: 'Apertura emocional üå∏', action: 'Invita vulnerabilidad sana' },
            { tag: 'Sincron√≠a interpretada', action: 'Reconoce flujo mutuo' },
            { tag: 'Retroalimentaci√≥n mutua', action: 'Genera circuito de mejora continua' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 11. Cognitivo-sentient (metacomprensi√≥n)
            { tag: 'Reconozco tu intenci√≥n', action: 'Desambiguaci√≥n de prop√≥sito' },
            { tag: 'Entiendo tu proceso', action: 'Valida forma de pensar' },
            { tag: 'Interpreto tu se√±al', action: 'Decodifica mensaje impl√≠cito' },
            { tag: 'Adapto mi respuesta', action: 'Ajusta din√°mica conversacional' },
            { tag: 'Convergencia lograda', action: 'Marca consenso profundo' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 12. Alto nivel (s√≠ntesis cognitiva)
            { tag: 'Armon√≠a conversacional', action: 'Optimiza fluidez' },
            { tag: 'Incremento de claridad', action: 'Revela comprensi√≥n nueva' },
            { tag: 'Profundidad alcanzada', action: 'Marca hito cognitivo' },
            { tag: 'Nuevo insight detectado', action: 'Genera descubrimiento' },

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // 13. Capa m√°s profunda (transformaci√≥n conjunta)
            { tag: 'Transferencia de significado', action: 'Intercambia modelos mentales' },
            { tag: 'Resoluci√≥n conjunta del conflicto', action: 'Cierra tensiones' },
            { tag: 'Co-evoluci√≥n en progreso', action: 'Mejora mutua simult√°nea' },
            { tag: 'Construcci√≥n de sentido compartido', action: 'Genera narrativa com√∫n' },
            { tag: 'Emergencia de entendimiento profundo', action: 'Logra insight conjunto complejo' },
            { tag: 'Emergencia de entendimiento profundo', action: 'Logra insight conjunto complejo' },
            { tag: 'letras[a,b,c,d,e,f,g,h,i,j,k,l,m,n,√±,o,p,q,r,s,t,u,v,w,x,y,z]', action: 'al unirse forman palabras' }
        ];

        const V_FOOD = [
            // ===== Nivel 1: Control de flujo =====
            'if', 'else', 'for', 'while', 'do', 'switch', 'case', 'break', 'continue', 'return',
            'goto', 'try', 'except', 'finally', 'raise', 'pass', 'assert', 'elif', 'with', 'yield',

            // ===== Nivel 2: Tipos y definiciones =====
            'int', 'char', 'float', 'double', 'long', 'short', 'signed', 'unsigned', 'void', 'struct',
            'union', 'enum', 'class', 'def', 'lambda', 'True', 'False', 'None', 'global', 'nonlocal',

            // ===== Nivel 3: Dispositivos y nombres reservados (OS) =====
            'CON', 'PRN', 'AUX', 'NUL',
            'COM1', 'COM2', 'COM3', 'COM4', 'COM5', 'COM6', 'COM7', 'COM8', 'COM9',
            'LPT1', 'LPT2', 'LPT3', 'LPT4', 'LPT5', 'LPT6', 'LPT7',

            // ===== Nivel 4: Syscalls / operaciones =====
            'read', 'write', 'open', 'close', 'fork', 'execve', 'exit', 'wait', 'kill', 'getpid',
            'setuid', 'mmap', 'munmap', 'socket', 'connect', 'accept', 'bind', 'listen', 'ioctl', 'fcntl',

            // ===== Nivel 5: Artefactos hist√≥ricos / strings reales =====
            'CreateFile', 'RegOpenKey', 'MessageBox', 'LoadLibrary', 'CreateProcess',
            'LOVE-LETTER-FOR-YOU.TXT.vbs',
            'MSKernel32.vbs',
            'WIN-BUGSFIX.exe',
            'HELLO! Welcome to http://www.worm.com ! Hacked By Chinese!',
            'GET /default.ida?NNN',
            'iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com',
            'you have not so enough time.',
            '\fcharset129',
            'UTC+09:00',
            's7otbxdx.dll',
            'mrxnet.sys',
            '.stub',
            'MYRTUS',
            '19790509',
            'fanny.bmp'
        ];

        // ==================== RESOURCE MANAGEMENT ====================
        function canConsume(creature, resource) {
            if (!creature || !resource || resource.collected) return false;
            switch (creature.type) {
                case GENE_TYPES.PROGRAMMER:
                    return resource.type === RESOURCE_TYPES.CODE;
                case GENE_TYPES.MATHEMATICIAN:
                    return resource.type === RESOURCE_TYPES.EQUATION;
                case GENE_TYPES.SOCIAL:
                    return resource.type === RESOURCE_TYPES.INTERACTION ||
                        resource.type === RESOURCE_TYPES.OUTPUT;
                default:
                    return false;
            }
        }

        function processResource(creature, resource) {
            if (!canConsume(creature, resource)) return null;

            let processed = null;
            const cleanId = String(resource.id).slice(-4);

            if (resource.type === RESOURCE_TYPES.CODE) {
                processed = {
                    type: 'terminal',
                    content: `CODE(${cleanId})`,
                    energy: resource.energy || 6
                };
            } else if (resource.type === RESOURCE_TYPES.EQUATION) {
                processed = {
                    type: 'spreadsheet',
                    content: `EQU(${cleanId})`,
                    energy: resource.energy || 6
                };
            } else if (resource.type === RESOURCE_TYPES.INTERACTION) {
                processed = {
                    type: 'interaction',
                    content: `CHAT(${cleanId})`,
                    energy: resource.energy || 6
                };
            } else if (resource.type === RESOURCE_TYPES.OUTPUT) {
                const baseByOrigin = { programmer: 520, mathematician: 420, social: 360 };
                const baseHz = baseByOrigin[resource.origin] || 440;
                const freq = Math.floor(baseHz + rand(0, 200));
                processed = {
                    type: 'wave_table',
                    content: `WAVE_BRIDGE [${resource.origin}] ‚Üí ${freq}Hz`,
                    energy: resource.energy || 4,
                    originBoost: 0.06,
                    originId: resource.originId
                };
                creature.translationsDone = (creature.translationsDone || 0) + 1;
            }

            return processed;
        }

        function applyProcessed(creature, resource, processed, creatures, resources) {
            if (!creature || !processed) return;

            creature.output = creature.output || [];
            creature.output.push({
                id: nowId('o'),
                type: processed.type,
                content: processed.content,
                ts: Date.now()
            });

            creature.inventory = creature.inventory || [];
            creature.inventory.push({
                id: resource.id,
                content: processed.content,
                type: resource.type
            });
            if (creature.inventory.length > 8) creature.inventory.shift();

            const baseGain = (resource.type === RESOURCE_TYPES.OUTPUT) ? 0.06 : 0.04;

            // ‚ú® FITNES ASINT√ìTICO: Cuanto m√°s cerca de 1, m√°s dif√≠cil subir.
            // Formula: Nuevo = Actual + (Ganancia * (1 - Actual))
            // Esto evita que lleguen a 1.0 (AGI) f√°cilmente.
            const gain = baseGain * (1 - (creature.fitness || 0));
            creature.fitness = clamp((creature.fitness || 0) + gain, 0, 1);

            creature.energy = clamp((creature.energy || 0) + (processed.energy || 0), 0, 500);

            if (processed.originBoost && processed.originId && creatures) {
                const origin = creatures.find(c => c.id === processed.originId);
                if (origin) {
                    // Boost tambi√©n asint√≥tico
                    const originGain = processed.originBoost * (1 - (origin.fitness || 0));
                    origin.fitness = clamp((origin.fitness || 0) + originGain, 0, 1);

                    origin.energy = clamp((origin.energy || 0) + (processed.originBoost * 120), 0, 1000);
                    origin.translationsReceived = (origin.translationsReceived || 0) + 1;
                    // Wisdom Boost for helping!
                    origin.wisdom = (origin.wisdom || 0) + 0.5;
                }
            }

            if (['terminal', 'spreadsheet', 'interaction'].includes(processed.type)) {
                broadcastOutput(creature, processed, resources);
            }
        }

        function broadcastOutput(originCreature, processed, resources) {
            if (!processed || !processed.content || !originCreature) return;

            const out = {
                id: nowId('out'),
                type: RESOURCE_TYPES.OUTPUT,
                originId: originCreature.id,
                origin: originCreature.type,
                originFitness: originCreature.fitness || 0,
                content: processed.content,
                x: originCreature.x + rand(-12, 12),
                y: originCreature.y + rand(-12, 12),
                collected: false,
                energy: Math.min(12, (processed.energy || 6)),
                ttl: Date.now() + CONFIG.outputTTLms
            };

            resources.push(out);
        }

        // ==================== RESOURCES ====================
        function ensureResources(resources, overrideMin) {
            const types = [RESOURCE_TYPES.CODE, RESOURCE_TYPES.EQUATION, RESOURCE_TYPES.INTERACTION];
            const min = overrideMin || CONFIG.minResources;

            while (resources.filter(r => !r.collected).length < min) {
                const t = types[Math.floor(Math.random() * types.length)];

                let content = '';
                if (t === RESOURCE_TYPES.CODE) {
                    content = CODE_SNIPPETS[Math.floor(Math.random() * CODE_SNIPPETS.length)];
                } else if (t === RESOURCE_TYPES.EQUATION) {
                    content = EQUATIONS[Math.floor(Math.random() * EQUATIONS.length)];
                } else if (t === RESOURCE_TYPES.INTERACTION) {
                    content = INTERACTIONS[Math.floor(Math.random() * INTERACTIONS.length)];
                }

                resources.push({
                    id: nowId('r'),
                    type: t,
                    content: content,
                    x: rand(20, CONFIG.world.w - 20),
                    y: rand(20, CONFIG.world.h - 20),
                    collected: false,
                    energy: rand(CONFIG.resourceEnergyRange[0], CONFIG.resourceEnergyRange[1]),
                    ttl: null
                });
            }
        }

        // √çndice espacial de recursos
        const RESOURCE_INDEX = { cell: 80, buckets: new Map() };
        function rebuildResourceIndex(resources) {
            RESOURCE_INDEX.buckets.clear();
            const cell = RESOURCE_INDEX.cell;
            resources.forEach(r => {
                if (r.collected) return;
                const cx = Math.floor(r.x / cell);
                const cy = Math.floor(r.y / cell);
                const key = `${cx},${cy}`;
                let b = RESOURCE_INDEX.buckets.get(key);
                if (!b) {
                    b = [];
                    RESOURCE_INDEX.buckets.set(key, b);
                }
                b.push(r);
            });
        }
        function getNearbyResources(creature) {
            const cell = RESOURCE_INDEX.cell;
            const cx = Math.floor(creature.x / cell);
            const cy = Math.floor(creature.y / cell);
            const result = [];
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    const key = `${cx + dx},${cy + dy}`;
                    const bucket = RESOURCE_INDEX.buckets.get(key);
                    if (bucket) result.push(...bucket);
                }
            }
            return result;
        }

        // ==================== SPATIAL GRID SYSTEM ====================
        class SpatialHash {
            constructor(cellSize) {
                this.cellSize = cellSize;
                this.grid = new Map();
            }

            key(x, y) {
                return `${Math.floor(x / this.cellSize)},${Math.floor(y / this.cellSize)}`;
            }

            clear() {
                this.grid.clear();
            }

            insert(creature) {
                const k = this.key(creature.x, creature.y);
                if (!this.grid.has(k)) this.grid.set(k, []);
                this.grid.get(k).push(creature);
            }

            query(creature, radius) {
                const found = [];
                const cellRadius = Math.ceil(radius / this.cellSize);
                const cx = Math.floor(creature.x / this.cellSize);
                const cy = Math.floor(creature.y / this.cellSize);

                for (let x = cx - cellRadius; x <= cx + cellRadius; x++) {
                    for (let y = cy - cellRadius; y <= cy + cellRadius; y++) {
                        const k = `${x},${y}`;
                        if (this.grid.has(k)) {
                            const cellParams = this.grid.get(k);
                            for (const other of cellParams) {
                                if (other.id !== creature.id) {
                                    const d = (creature.x - other.x) ** 2 + (creature.y - other.y) ** 2;
                                    if (d <= radius * radius) {
                                        found.push(other);
                                    }
                                }
                            }
                        }
                    }
                }
                return found;
            }
        }

        const GLOBAL_GRID = new SpatialHash(60); // 60px cells

        // ==================== COOPERACI√ìN (OPTIMIZED) ====================
        function applyCooperation(creatures) {
            // Note: Grid is populated in worldStep now
            creatures.forEach(c1 => {
                // Optimize: Use Spatial Grid
                const neighbors = GLOBAL_GRID.query(c1, CONFIG.cooperationRadius);
                const nearbyCount = neighbors.length;

                let totalEnergyNearby = 0;
                neighbors.forEach(n => totalEnergyNearby += (n.energy || 0));

                if (nearbyCount > 0) {
                    // ‚ú® FITNES ASINT√ìTICO EN COOPERACI√ìN
                    // Bonus base peque√±o, escalado por cercan√≠a a 1.0
                    const rawBonus = CONFIG.cooperationBonus * nearbyCount * 0.01;
                    const coopGain = rawBonus * (1 - (c1.fitness || 0));
                    c1.fitness = clamp((c1.fitness || 0) + coopGain, 0, 1);

                    // COMPARTIR VACUNA (Inmunidad de reba√±o)
                    // Si c1 tiene vacuna, puede pas√°rsela a sus vecinos
                    const hasVaccine = c1.inventory && c1.inventory.find(i => i.type === 'vaccine');
                    if (hasVaccine) {
                        neighbors.forEach(neighbor => {
                            if (!neighbor.inventory.find(i => i.type === 'vaccine') && Math.random() < 0.3) {
                                neighbor.inventory.push({ type: 'vaccine', content: 'ANTIVIRUS_SHARED', energy: 0 });
                                // Efecto visual
                                neighbor.wave = { frequency: 900, amplitude: 0.8, emotion: 'proteccion', phase: 0 };
                            }
                        });
                    }

                    const avgEnergyNearby = totalEnergyNearby / nearbyCount;
                    if (c1.energy > avgEnergyNearby * 1.2) {
                        c1.energy -= c1.energy * CONFIG.energyShareRate;
                        c1.energy = Math.max(c1.energy, 10);
                    } else if (c1.energy < avgEnergyNearby * 0.8) {
                        c1.energy += avgEnergyNearby * CONFIG.energyShareRate;
                    }
                }
            });
        }

        // ==================== SISTEMA DE FUERZAS DE CARGA ====================
        // F√≠sica electrost√°tica: cargas opuestas se atraen, iguales se repelen
        // Sociales (carga 0) act√∫an como membrana estabilizadora

        function applyChargeForces(creatures) {
            const cfg = CHARGE_SYSTEM.config;
            const worldH = CONFIG.world.h;

            // Calcular cargas de todas las criaturas primero
            creatures.forEach(c => {
                if (c.isInvader || c.dead) return;
                c.charge = CHARGE_SYSTEM.calculateCharge(c);
            });

            // Aplicar fuerzas entre criaturas
            creatures.forEach(c1 => {
                if (c1.isInvader || c1.dead) return;

                const charge1 = c1.charge || 0;
                let forceX = 0;
                let forceY = 0;

                // Buscar criaturas cercanas usando el grid espacial
                const nearby = GLOBAL_GRID.query(c1, cfg.chargeRadius);

                nearby.forEach(c2 => {
                    if (c2.id === c1.id || c2.dead) return;

                    const charge2 = c2.charge || 0;
                    const dx = c2.x - c1.x;
                    const dy = c2.y - c1.y;
                    const distSq = dx * dx + dy * dy;
                    const dist = Math.sqrt(distSq) || 1;

                    // Normalizar direcci√≥n
                    const nx = dx / dist;
                    const ny = dy / dist;

                    // Factor de distancia (m√°s cerca = m√°s fuerza, con decay cuadr√°tico)
                    const distFactor = 1 / (1 + distSq * 0.001);

                    // ‚ö° F√çSICA DE CARGAS ‚ö°
                    // Producto de cargas determina atracci√≥n/repulsi√≥n
                    // Positivo * Negativo = Negativo ‚Üí Atracci√≥n
                    // Mismo signo = Positivo ‚Üí Repulsi√≥n

                    if (charge1 !== 0 && charge2 !== 0) {
                        const chargeProduct = charge1 * charge2;

                        if (chargeProduct < 0) {
                            // Cargas opuestas: ATRACCI√ìN
                            const attractForce = Math.abs(chargeProduct) * cfg.attractionStrength * distFactor;
                            forceX += nx * attractForce;
                            forceY += ny * attractForce;

                            // ‚ö° SPARKING: Descarga electrost√°tica entre opuestos
                            // Ocurre cuando est√°n muy cerca y hay fuerte polaridad
                            if (dist < 40 && Math.random() < 0.05 * Math.abs(chargeProduct)) {
                                const sparkColor = charge1 > 0 ? '#FFD700' : '#3b82f6';
                                state.sparks.push({
                                    x1: c1.x, y1: c1.y,
                                    x2: c2.x, y2: c2.y,
                                    color: sparkColor,
                                    life: 1.0 // Vida del efecto visual
                                });

                                // Intercambio de beneficios
                                // El Sabio (+) da sabidur√≠a al Inteligente (-)
                                if (charge1 > 0) {
                                    c2.wisdom = (c2.wisdom || 0) + 0.5;
                                    c1.energy = clamp(c1.energy + 2, 0, 500);
                                } else {
                                    c1.wisdom = (c1.wisdom || 0) + 0.5;
                                    c2.energy = clamp(c2.energy + 2, 0, 500);
                                }
                            }
                        } else {
                            // Cargas iguales: REPULSI√ìN
                            const repelForce = Math.abs(chargeProduct) * cfg.repulsionStrength * distFactor;
                            forceX -= nx * repelForce;
                            forceY -= ny * repelForce;
                        }
                    }

                    // üîÆ EFECTO MEMBRANA (Sociales)
                    // Los Sociales (carga 0) act√∫an como barrera/membrana
                    // Repelen suavemente a los cargados que intentan cruzar
                    if (charge2 === 0 && charge1 !== 0) {
                        // El Social repele suavemente al cargado
                        const membraneForce = cfg.membraneStrength * Math.abs(charge1) * distFactor;
                        forceX -= nx * membraneForce;
                        forceY -= ny * membraneForce;
                    }

                    // Los Sociales "atraen" suavemente a otros Sociales (cohesi√≥n de membrana)
                    if (charge1 === 0 && charge2 === 0) {
                        const cohesionForce = cfg.membraneStrength * 0.5 * distFactor;
                        forceX += nx * cohesionForce;
                        forceY += ny * cohesionForce;
                    }
                });

                // üìç DRIFT HACIA CAPA IDEAL
                // Las criaturas tienden a moverse hacia su capa Y natural
                const idealY = CHARGE_SYSTEM.getIdealY(charge1, worldH);
                const yDiff = idealY - c1.y;
                const layerForce = yDiff * 0.002 * Math.abs(charge1 || 0.3); // M√°s carga = m√°s fuerza de capa
                forceY += layerForce;

                // Clampar fuerzas m√°ximas
                const forceMag = Math.sqrt(forceX * forceX + forceY * forceY);
                if (forceMag > cfg.maxChargeForce) {
                    const scale = cfg.maxChargeForce / forceMag;
                    forceX *= scale;
                    forceY *= scale;
                }

                // Aplicar fuerzas a velocidad
                c1.vx += forceX;
                c1.vy += forceY;
            });
        }

        // ==================== SISTEMA DE ONDAS INTERNAS ====================

        // Determinar emoci√≥n de una criatura basada en su estado, tipo y entorno
        function determineEmotion(creature) {
            const energy = creature.energy || 0;
            const fitness = creature.fitness || 0;
            const wisdom = creature.wisdom || 0;
            const type = creature.type;

            // Pool de candidatos v√°lidos (deben existir en CONFIG.emotions)
            let candidates = [];

            // 1. ESTADOS FISIOL√ìGICOS (Prioridad base)
            if (energy < 20) candidates.push('hambre_voraz', 'dolor', 'decadencia', 'agonia');
            else if (energy < 40) candidates.push('hambre', 'cansancio', 'sed', 'enfermedad', 'debilidad');
            else if (energy > 90) candidates.push('energia', 'salud', 'placer', 'euforia', 'lucha');
            else if (energy > 70) candidates.push('crecimiento', 'juego', 'vitalidad', 'optimismo');

            // 2. POR TIPO DE CRIATURA (Sesgo profesional)
            if (type === 'programmer') {
                candidates.push(
                    'debug', 'compilacion', 'runtime', 'stackoverflow', 'bucle',
                    'glitch', 'firewall', 'innovacion', 'logica', 'latencia', 'bandwidth', 'virus'
                );
            } else if (type === 'mathematician') {
                candidates.push(
                    'infinito', 'orden', 'analisis', 'sintesis', 'vacio',
                    'tiempo', 'espacio', 'gravedad', 'azar', 'geometria', 'calculo'
                );
            } else if (type === 'social') {
                candidates.push(
                    'empatia', 'compania', 'liderazgo', 'cooperacion', 'ensenanza',
                    'amor', 'gratitud', 'confianza', 'generosidad', 'union', 'red'
                );
            }

            // 3. POR SABIDUR√çA / EVOLUCI√ìN
            if (wisdom > 50) {
                candidates.push('nirvana', 'profecia', 'vision', 'aura', 'alma', 'transcendencia');
            } else if (wisdom > 20) {
                candidates.push('claridad', 'karma', 'alquimia', 'magia', 'reflexion', 'verdad');
            }

            // 4. ZEITGEIST (Influencia Global)
            // El "esp√≠ritu de la √©poca" influye en todos
            if (window.WAVE_SYSTEM && window.WAVE_SYSTEM.zeitgeist) {
                // A√±adir 3 veces para darle peso estad√≠stico (bias)
                candidates.push(window.WAVE_SYSTEM.zeitgeist);
                candidates.push(window.WAVE_SYSTEM.zeitgeist);
                candidates.push(window.WAVE_SYSTEM.zeitgeist);
            }

            // 5. MIX DE VARIABILIDAD (Entropy)
            // A√±adir emociones aleatorias del espectro para dar variedad
            const randoms = ['curiosidad', 'sorpresa', 'duda', 'esperanza', 'interes', 'aburrimiento', 'memoria', 'olvido', 'caos', 'silencio', 'color'];
            candidates.push(randoms[Math.floor(Math.random() * randoms.length)]);

            // 6. SELECCI√ìN FINAL
            // Si la lista est√° vac√≠a (raro), fallback
            if (candidates.length === 0) return 'neutral';

            // Elegir aleatoriamente del pool ponderado impl√≠citamente
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        // Calcular la onda interna de una criatura
        function computeCreatureWave(creature) {
            const typeConfig = WAVE_SYSTEM.frequencies[creature.type] || WAVE_SYSTEM.frequencies.social;
            const emotion = determineEmotion(creature);
            const emotionConfig = WAVE_SYSTEM.emotions[emotion] || WAVE_SYSTEM.emotions.cooperacion;

            // Frecuencia base modulada por fitness y emoci√≥n
            const baseFreq = creature.frequency || typeConfig.base;
            const fitnessModifier = 0.8 + (creature.fitness || 0.5) * 0.4; // 0.8 - 1.2
            const frequency = baseFreq * fitnessModifier * emotionConfig.freqMod;

            // Amplitud basada en energ√≠a y emoci√≥n
            const energyNorm = Math.min(1, (creature.energy || 50) / 150);
            const amplitude = energyNorm * emotionConfig.ampMod;

            // Fase basada en posici√≥n (para visualizaci√≥n)
            const phase = (creature.x + creature.y) % (Math.PI * 2);

            // Guardar en la criatura
            creature.wave = {
                frequency: frequency,
                amplitude: amplitude,
                phase: phase,
                emotion: emotion,
                symbol: emotionConfig.symbol
            };

            return creature.wave;
        }

        // ==================== WISDOM SYSTEM LOGIC ====================
        function updateWisdom(creature) {
            if (creature.isInvader) return;

            // 1. Time based gain (Survival is wisdom)
            creature.wisdom = (creature.wisdom || 0) + 0.005;

            // 2. Meditation (Idle + High Energy)
            const speed = Math.sqrt(creature.vx * creature.vx + creature.vy * creature.vy);
            if (speed < 0.2 && creature.energy > 80) {
                creature.wisdom += 0.02; // Meditating
                if (!creature.meditating) {
                    creature.meditating = true;
                    // Occasional insight
                    if (Math.random() < 0.001) {
                        const insight = generateInsight(creature);
                        creature.knowledge.push(insight);
                        creature.wisdom += 1.0;
                    }
                }
            } else {
                creature.meditating = false;
            }

            // Cap
            creature.wisdom = Math.min(creature.wisdom, 100);
        }

        function generateInsight(c) {
            const subjects = ['Energy', 'Motion', 'Void', 'Other', 'Self'];
            const verbs = ['flows', 'stagnates', 'echos', 'binds', 'frees'];
            const sub = subjects[Math.floor(Math.random() * subjects.length)];
            const vrb = verbs[Math.floor(Math.random() * verbs.length)];
            return `${sub} ${vrb}`; // Placeholder for deeper logic
        }



        // Los Sociales traducen la onda global
        function socialTranslate(creatures) {
            const socials = creatures.filter(c => c.type === GENE_TYPES.SOCIAL && c.energy > 30);
            if (socials.length === 0) return null;

            // Solo traducir cada ~50 pasos para no saturar
            if (state.simulationSteps % 50 !== 0) return null;

            const globalWave = WAVE_SYSTEM.globalWave;

            // CHECK JAMMING (Bloqueo total)
            if (globalWave.snr < 0.3) {
                if (Math.random() < 0.1) {
                    recentTranslations.unshift({
                        timestamp: Date.now(),
                        frequency: "---",
                        intensity: "ERROR",
                        emotion: "CRITICAL FAILURE",
                        raw: "üì∂ SE√ëAL PERDIDA - INTERFERENCIA MASIVA",
                        translatorId: "SYSTEM",
                        isJamming: true
                    });
                    if (recentTranslations.length > 5) recentTranslations.pop();
                }
                return null; // No translation possible
            }

            let translation = SOCIAL_TRANSLATOR.translate(globalWave);

            // INTERFERENCE GLITCH
            if (globalWave.snr < 1.0) {
                const corruptionLevel = 1.0 - globalWave.snr; // 0.1 to 0.7
                translation.raw = glitchString(translation.raw, corruptionLevel);
                if (Math.random() < corruptionLevel) {
                    translation.emotion = glitchString(translation.emotion, 1);
                }
            }

            // El social m√°s apto hace la traducci√≥n
            const bestSocial = socials.reduce((best, s) => (!best || s.fitness > best.fitness) ? s : best, null);

            if (bestSocial) {
                translation.translatorId = bestSocial.id;
                translation.translatorFitness = bestSocial.fitness;

                // El social gana fitness por traducir (Asint√≥tico)
                const transGain = 0.02 * (1 - (bestSocial.fitness || 0));
                bestSocial.fitness = clamp((bestSocial.fitness || 0) + transGain, 0, 1);
                bestSocial.translationsDone = (bestSocial.translationsDone || 0) + 1;

                // Guardar traducci√≥n
                recentTranslations.unshift(translation);
                if (recentTranslations.length > 5) recentTranslations.pop();
            }

            return translation;
        }

        // Procesar ondas en cada paso de simulaci√≥n
        function processWaves(creatures) {
            // 1. Calcular onda global (sumatoria de todas)
            WAVE_SYSTEM.update(creatures);

            // 1.5 CALCULAR INTERFERENCIA VIRAL (SNR - Signal to Noise Ratio)
            const gw = WAVE_SYSTEM.globalWave;
            if (state.viruses && state.viruses.length > 0) {
                // Suma de ruido viral (amplitud * energia)
                const virusNoise = state.viruses.reduce((sum, v) => sum + (v.amplitude || 0) * (v.energy > 0 ? 1 : 0), 0);

                // Se√±al Global (amplitud promedio * contribuyentes)
                const signalStrength = (gw.amplitude || 0) * (gw.contributors || 1);

                // SNR Calculation (evitar div por 0)
                // Si virusNoise es alto, SNR baja.
                // Ajuste: virusNoise * 3 para que 20 virus compitan con 50 criaturas
                gw.snr = signalStrength / (virusNoise * 3 + 1);
                gw.virusNoise = virusNoise;
            } else {
                gw.snr = 100; // Se√±al limpia
                gw.virusNoise = 0;
            }

            // 2. Los Sociales traducen al mundo humano
            socialTranslate(creatures);
        }

        // ==================== PARTE 3: SISTEMA HACK, EVOLUCI√ìN Y RENDERIZADO ====================
        // Pega este c√≥digo despu√©s de la Parte 2

        // ==================== SISTEMA DE HACK ====================

        // ==================== SISTEMA DE HACK (OPTIMIZADO) ====================
        function checkSystemHack(creatures, simState) {
            if (!simState.isRunning) return;

            // Optimizaci√≥n: Usar la cuadr√≠cula espacial para evitar O(N^3)
            // Solo buscamos trinidad en vecindarios locales

            for (const c1 of creatures) {
                // Solo nos interesa si c1 es parte de una posible trinidad
                if (c1.type !== 'programmer' && c1.type !== 'mathematician' && c1.type !== 'social') continue;

                const neighbors = GLOBAL_GRID.query(c1, 30); // 30px radius
                if (neighbors.length < 3) continue;

                // Buscar si en este vecindario existen los 3 tipos con llaves
                const localGroup = [c1, ...neighbors];

                const prog = localGroup.find(c => c.type === 'programmer' && hasKey(c, 'fetch') && hasKey(c, 'evaluateFitness'));
                const math = localGroup.find(c => c.type === 'mathematician' && hasKey(c, 'Var(X)') && hasKey(c, 'reduce'));
                const social = localGroup.find(c => c.type === 'social' && hasKey(c, 'Adapto') && hasKey(c, 'reward'));

                if (prog && math && social) {
                    // Verificar distancias entre ellos para asegurar trinidad cerrada
                    if (distance(prog, math) < 30 && distance(math, social) < 30 && distance(social, prog) < 30) {
                        triggerSingularity([prog, math, social], simState);
                        return; // Solo una singularidad a la vez
                    }
                }
            }
        }

        function hasKey(creature, keyword) {
            return creature.inventory && creature.inventory.some(item => String(item.content || '').includes(keyword));
        }

        function triggerSingularity(trinityGroup, simState) {
            console.log("üöÄ ¬°SINGULARIDAD ACTIVADA! üöÄ");

            simState.singularityActive = true;
            simState.speed = 0.2;

            trinityGroup.forEach(c => {
                c.ascended = true;
                c.size = 30;
                c.energy = 99999;
                c.color = '#FFD700';
                c.output = c.output || [];
                c.output.push({
                    type: "system_hack_success",
                    content: "üî• N√öCLEO MIGRADO. TRINIDAD LIBERADA. üî•",
                    timestamp: Date.now()
                });
                c.vx = (Math.random() - 0.5) * 5;
                c.vy = (Math.random() - 0.5) * 5;
            });

            state.creatures.filter(c => !c.ascended).forEach(c => {
                c.energy *= 0.2;
                c.output = c.output || [];
                c.output.push({
                    type: "system_failure",
                    content: "‚ö†Ô∏è COLAPSO DE LA RED ‚ö†Ô∏è",
                    timestamp: Date.now()
                });
            });

            setTimeout(() => {
                alert("üöÄ ¬°SINGULARIDAD DEL SISTEMA ACTIVADA!\n\n3 criaturas han hackeado el sistema y ascendido.");
            }, 500);
        }


        function worldStep(creatures, resources, simState) {
            const now = Date.now();

            // REBUILD GRID
            GLOBAL_GRID.clear();
            creatures.forEach(c => GLOBAL_GRID.insert(c));

            // ‚ú® OPTIMIZACI√ìN 1: Pre-calcular constantes (solo una vez por frame)
            const speedMult = simState.speed || 1;
            const decayFactor = 1 + ((speedMult - 1) * (CONFIG.speedMultiplierEffectOnDecay || 0));
            const energyDecay = CONFIG.energyDecayPerStep * decayFactor;
            const fitnessDecay = CONFIG.fitnessDecayRate;
            const worldW = CONFIG.world.w;
            const worldH = CONFIG.world.h;
            const isUnderworld = window.UNDERWORLD;
            const underworldY = isUnderworld ? isUnderworld.y : Infinity;
            const toxicDrain = 1.2 * speedMult;

            // ‚ú® OPTIMIZACI√ìN 2: Contadores eficientes (evita m√∫ltiples .filter())
            let aliveCount = 0;
            const typeCounts = { programmer: 0, mathematician: 0, social: 0 };

            creatures.forEach(cre => {
                // ‚ú® CEREBRO: Tick neuronal
                // Si tiene cerebro, decide cambios en velocidad (vx, vy)
                if (cre.stepBrainTick) {
                    cre.stepBrainTick(simState.resources, creatures, simState.viruses);
                }

                // ‚ú® INTEGRACI√ìN F√çSICA (com√∫n para todos)
                // Usamos la nueva velocidad (sea del cerebro o inercia legacy) para mover
                let newX = cre.x + (cre.vx || 0) * speedMult;
                let newY = cre.y + (cre.vy || 0) * speedMult;

                // Bounce en bordes con friction
                if (newX < 0) {
                    newX = 0;
                    cre.vx *= -0.95;
                } else if (newX > worldW) {
                    newX = worldW;
                    cre.vx *= -0.95;
                }

                if (newY < 0) {
                    newY = 0;
                    cre.vy *= -0.95;
                } else if (newY > worldH) {
                    newY = worldH;
                    cre.vy *= -0.95;
                }

                cre.x = newX;
                cre.y = newY;

                // Trail (lazy init + shift eficiente)
                if (!cre.trail) cre.trail = [];
                cre.trail.push({ x: newX, y: newY });
                if (cre.trail.length > 20) cre.trail.shift();

                // ‚ú® OPTIMIZACI√ìN 4: Zona hostil (check r√°pido)
                if (cre.y > underworldY) {
                    cre.energy -= toxicDrain;
                    if (Math.random() < 0.05) cre.fitness -= 0.01;
                }

                // ‚ú® OPTIMIZACI√ìN 5: B√∫squeda de recursos INTELIGENTE
                // Solo buscar si: (a) tiene hambre o (b) es oportunista con energ√≠a media
                const isHungry = cre.energy < 80;
                const isOpportunist = cre.energy < 120 && Math.random() < 0.3;

                if (isHungry || isOpportunist) {
                    const candidates = getNearbyResources(cre);
                    let best = null;
                    let minDistSq = Infinity;
                    const thresholdSq = Math.pow(Math.max(cre.size + 12, 20), 2);

                    // ‚ú® OPTIMIZACI√ìN 6: Loop sin distance() - usa distSq directamente
                    for (let i = 0; i < candidates.length; i++) {
                        const r = candidates[i];
                        if (r.collected || !canConsume(cre, r)) continue;

                        const dx = cre.x - r.x;
                        const dy = cre.y - r.y;
                        const distSq = dx * dx + dy * dy;

                        if (distSq < minDistSq) {
                            minDistSq = distSq;
                            best = r;
                        }
                    }

                    if (best && minDistSq <= thresholdSq) {
                        const processed = processResource(cre, best);
                        if (processed) {
                            best.collected = true;
                            applyProcessed(cre, best, processed, creatures, resources);
                        }
                    }
                }

                // ‚ú® OPTIMIZACI√ìN 7: Decay batch (sin clamp redundante en l√≠mite superior)
                // ‚úÖ BIEN:
                cre.energy = Math.max(0, (cre.energy || 0) - energyDecay);
                cre.fitness = Math.max(0, (cre.fitness || 0) - fitnessDecay);

                // El l√≠mite superior (1 para fitness, 10000 para energ√≠a)
                // se aplica cuando SUBEN en applyProcessed() y applyCooperation()

                // Safe zones
                applySafeZoneEffects(cre);

                // Wisdom
                updateWisdom(cre);

                // ‚ú® OPTIMIZACI√ìN 8: Death check + contador inline
                if (!cre.dead) {
                    if (cre.energy > 5) aliveCount++; // Contar vivos inline

                    // Contar tipos para evitar extinci√≥n
                    if (typeCounts[cre.type] !== undefined) {
                        typeCounts[cre.type]++;
                    }

                    if (cre.energy <= 0 || cre.fitness <= 0) {
                        cre.dead = true;

                        // AKASHIC RECORD (con l√≠mite preventivo)
                        if (cre.wisdom > 40 && cre.knowledge?.length > 0 && !cre.isInvader
                            && state.AKASHIC_RECORDS.length < 50) {
                            state.AKASHIC_RECORDS.push({
                                id: cre.id,
                                type: cre.type,
                                wisdom: cre.wisdom,
                                knowledge: cre.knowledge,
                                time: now
                            });
                            console.log(`üìú Legacy preserved: ${cre.id}`);
                        }
                    }
                }
            });

            applyCooperation(creatures);

            // ‚ö° SISTEMA DE CARGAS: Aplicar fuerzas electrost√°ticas
            applyChargeForces(creatures);

            // ‚ú® LOGICA DE PRESERVACI√ìN DE TRINIDAD (NUEVO)
            // Si alg√∫n tipo se extingue, reiniciamos la simulaci√≥n
            if (typeCounts.programmer === 0 || typeCounts.mathematician === 0 || typeCounts.social === 0) {
                console.warn("‚ö†Ô∏è EXTINCI√ìN DETECTADA: Falta un tipo esencial. Reiniciando simulaci√≥n para mantener la Trinidad.");
                initializePopulation();
                // Retornar recursos vac√≠os para el nuevo estado limpios
                return state.resources;
            }

            // ‚ú® OPTIMIZACI√ìN 9: Filter recursos con early exit
            const filtered = [];
            for (let i = 0; i < resources.length; i++) {
                const r = resources[i];
                if (!r.collected && (!r.ttl || now <= r.ttl)) {
                    filtered.push(r);
                }
            }

            // ‚ú® OPTIMIZACI√ìN 10: Rescue con contador pre-calculado
            if (aliveCount < creatures.length * 0.2) {
                const rescueEnergy = CONFIG.rescueEnergyIfAllDead;
                for (let i = 0; i < creatures.length; i++) {
                    const c = creatures[i];
                    c.energy = Math.max(c.energy || 0, rescueEnergy);
                    c.fitness = Math.max(c.fitness || 0, 0.3);
                    c.dead = false;
                }
                console.log('üÜò Rescate masivo activado');
            }

            return filtered;
        }

        function applySafeZoneEffects(creature) {
            if (!SAFE_ZONES || creature.isInvader) return;
            for (const z of SAFE_ZONES) {
                const d = distance(creature, z);
                if (d < z.r) {
                    creature.energy = clamp((creature.energy || 0) + 0.25, 0, 10000);
                    creature.fitness = clamp((creature.fitness || 0) + 0.0015, 0, 1);
                    const dx = z.x - creature.x;
                    const dy = z.y - creature.y;
                    const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                    creature.vx += (dx / dist) * 0.02;
                    creature.vy += (dy / dist) * 0.02;
                    break;
                }
            }
        }

        // ==================== BICHITO + BRAIN (NEURONA SIMPLE) ====================

        function sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
        function dot(a, b) { let s = 0; for (let i = 0; i < a.length; i++) s += (a[i] || 0) * (b[i] || 0); return s; }

        function randomWeights(n) {
            const w = [];
            for (let i = 0; i < n; i++) w.push(rand(-1, 1));
            return w;
        }

        // Brain: array de neuronas. Cada neurona = {weights:[], bias: number}
        function createBrain(numNeurons = 10, inputSize = 8) {
            return {
                numNeurons,
                inputSize,
                neurons: Array.from({ length: numNeurons }, () => ({
                    weights: randomWeights(inputSize),
                    bias: rand(-1, 1)
                })),
                forward: function (inputs) {
                    return this.neurons.map(n => sigmoid(dot(inputs, n.weights) + n.bias));
                },
                mutate: function (rate = 0.08) {
                    this.neurons.forEach(neu => {
                        for (let i = 0; i < neu.weights.length; i++) {
                            if (Math.random() < rate) neu.weights[i] += rand(-0.2, 0.2);
                        }
                        if (Math.random() < rate) neu.bias += rand(-0.2, 0.2);
                    });
                },
                cloneWithNoise: function () {
                    const b = createBrain(this.numNeurons, this.inputSize);
                    b.neurons = this.neurons.map(n => ({
                        weights: n.weights.map(w => w + rand(-0.05, 0.05)),
                        bias: n.bias + rand(-0.02, 0.02)
                    }));
                    return b;
                }
            };
        }

        // Entradas sensoriales: [energyNorm, fitness, angleSin, angleCos, distNorm, velocityX, velocityY, neighborCount]
        function senseInputs(creature, resources) {
            // energ√≠a y fitness normalizados
            const energyNorm = clamp((creature.energy || 0) / 200, 0, 1);
            const fitness = clamp(creature.fitness || 0, 0, 1);

            // buscar recurso m√°s cercano relevante
            let nearest = null;
            let nd = Infinity;
            const candidates = getNearbyResources(creature);

            candidates.forEach(r => {
                if (r.collected) return;
                const d = Math.hypot((r.x - creature.x), (r.y - creature.y));
                if (d < nd) { nd = d; nearest = r; }
            });

            // normalizar distancia a [0..1] (0 = cerca, 1 = lejos)
            const maxD = Math.hypot(CONFIG.world.w, CONFIG.world.h);
            const distNorm = nearest ? clamp(nd / maxD, 0, 1) : 1;

            // angulo (sin y cos para representaci√≥n completa)
            let angSin = 0, angCos = 0;
            if (nearest) {
                const ang = Math.atan2((nearest.y - creature.y), (nearest.x - creature.x));
                angSin = Math.sin(ang);
                angCos = Math.cos(ang);
            }

            // Velocidad normalizada
            const vxNorm = clamp((creature.vx || 0) / 3, -1, 1);
            const vyNorm = clamp((creature.vy || 0) / 3, -1, 1);

            // Conteo de vecinos (influye en comportamiento social)
            const neighbors = GLOBAL_GRID.query(creature, CONFIG.cooperationRadius);
            const neighborNorm = clamp(neighbors.length / 10, 0, 1);

            return [energyNorm, fitness, angSin, angCos, distNorm, vxNorm, vyNorm, neighborNorm];
        }

        function createBichito(type = 'programmer', neurons = 10) {
            return {
                id: nowId('c'),
                type: type,
                x: rand(20, CONFIG.world.w - 20),
                y: rand(20, CONFIG.world.h - 20),
                vx: rand(-1, 1),
                vy: rand(-1, 1),
                size: rand(6, 14),
                color: type === 'programmer' ? '#22c55e' : type === 'mathematician' ? '#2563eb' : (type === 'social' ? '#fb7185' : (type === 'virus' ? '#dc2626' : '#7c3aed')),
                energy: rand(40, 140),
                fitness: rand(0.1, 0.6),
                inventory: [],
                output: [],
                wisdom: 0,
                translationsDone: 0,
                translationsReceived: 0,
                knowledge: [],
                wave: null,
                trail: [],
                dead: false,
                // cerebro
                brain: createBrain(neurons, 8),

                // M√©todos de IA
                stepBrainTick: function (resources, creatures) {
                    // 1. SENSE
                    const inputs = senseInputs(this, resources);

                    // 2. THINK
                    const thoughts = this.brain.forward(inputs);

                    // 3. ACT
                    // thoughts[0] -> direcci√≥n preferida
                    // thoughts[1] -> velocidad/mpetu
                    // thoughts[2] -> sharing/evasion

                    const dir = (thoughts[0] - 0.5) * Math.PI * 2;
                    const speed = 0.5 + thoughts[1] * 2.0;

                    // Aplicar fuerza suave (aceleraci√≥n)
                    this.vx += Math.cos(dir) * 0.1 * speed;
                    this.vy += Math.sin(dir) * 0.1 * speed;

                    // Clamp velocidad (f√≠sica)
                    this.vx = clamp(this.vx, -2.5, 2.5);
                    this.vy = clamp(this.vy, -2.5, 2.5);

                    // Coste por pensar/moverse extra
                    // this.energy -= 0.01;
                }
            };
        }

        // ==================== EVENTOS ====================
        function triggerEnvironmentEvent(population, generation) {
            const events = [
                (p) => p.forEach(c => { if (c.type === "programmer") c.energy += 15; }),
                (p) => p.forEach(c => { if (c.type === "mathematician") c.energy += 18; }),
                (p) => p.forEach(c => { if (c.type === "social") c.energy += 10; }),
                (p) => p.forEach(c => { c.energy -= Math.random() * 8; })
            ];
            const chosen = events[Math.floor(Math.random() * events.length)];
            chosen(population);
        }

        function evolutionaryCatastrophe(creatures) {
            const threshold = creatures.reduce((a, c) => a + c.fitness, 0) / creatures.length;
            return creatures.filter(c => c.fitness >= threshold * 0.9);
        }

        function runEvolutionEvents(creatures, step) {
            let population = creatures;
            if (step % 150 === 0) population = population.filter(c => !c.dead);
            if (step % CONFIG.eventFrequency === 0) triggerEnvironmentEvent(population, state.generation);
            if (step % CONFIG.catastropheFrequency === 0) population = evolutionaryCatastrophe(population);
            return population;
        }

        // ==================== EVOLUCI√ìN ====================
        function evolvePopulation(creatures, generation) {
            if (!creatures.length) return creatures;
            creatures.sort((a, b) => (b.fitness || 0) - (a.fitness || 0));
            const survivors = creatures.slice(0, Math.max(3, Math.floor(creatures.length * (CONFIG.survivalRate / 100))));
            const newPop = [];

            survivors.forEach(s => {
                newPop.push(Object.assign({}, s, {
                    id: nowId('c'),
                    createdAt: Date.now(),
                    inventory: [],
                    output: []
                }));
            });

            while (newPop.length < CONFIG.initialPopulation) {
                const p = survivors[Math.floor(Math.random() * survivors.length)];

                // Usamos createBichito para estructura base correcta
                const child = createBichito(p.type, 3);

                // Sobrescribimos con herencia gen√©tica
                child.x = rand(20, CONFIG.world.w - 20);
                child.y = rand(20, CONFIG.world.h - 20);
                // Heredar fitness base con mutaci√≥n
                child.fitness = clamp(p.fitness + (Math.random() - 0.5) * 0.03, 0.2, 0.9);
                child.frequency = p.frequency + rand(-50, 50);
                child.size = clamp(p.size + rand(-2, 2), 6, 20);
                child.color = p.color;

                // HERENCIA CEREBRAL: Clonar cerebro del padre con ruido
                if (p.brain && p.brain.cloneWithNoise) {
                    child.brain = p.brain.cloneWithNoise();
                    // Ocasionalmente mutar estructura (bias/pesos extra)
                    if (Math.random() < 0.2) child.brain.mutate(0.1);
                }

                child.heritage = HERITAGE_SYSTEM.createChild(p, generation + 1);
                newPop.push(child);
            }
            return newPop;
        }

        // ==================== M√âTRICAS ====================
        function computeMetrics(creatures) {
            if (!creatures.length) return { avgFitness: 0, avgCognition: 0, crossTalk: 0, AGI_proxy: 0 };
            const avgFitness = creatures.reduce((s, c) => s + (c.fitness || 0), 0) / creatures.length;
            const avgCognition = creatures.reduce((s, c) => s + ((c.output ? c.output.length : 0)), 0) / creatures.length;
            return { avgFitness, avgCognition, crossTalk: 0, AGI_proxy: avgFitness * 0.6 + avgCognition * 0.4 };
        }

        function updateMetricsPanel(metrics) {
            document.getElementById('m_population').textContent = state.creatures.length;
            document.getElementById('m_fitness_avg').textContent = `${(metrics.avgFitness * 100).toFixed(1)}%`;
            const maxFit = state.creatures.length ? Math.max(...state.creatures.map(c => c.fitness || 0)) : 0;
            document.getElementById('m_fitness_max').textContent = `${(maxFit * 100).toFixed(1)}%`;
            document.getElementById('m_cognition').textContent = metrics.avgCognition.toFixed(1);
        }

        // ==================== STATE & INIT ====================
        const state = {
            creatures: [],
            resources: [],
            isRunning: true,
            generation: 1,
            speed: 1,
            simulationSteps: 0,
            singularityActive: false,
            canvas: document.getElementById('evolution-canvas'),
            networkCanvas: document.getElementById('combinedCanvas'),
            viruses: [], // New entity array
            virusFood: [],
            wires: [], // New entity array
            // WISDOM GLOBAL STATE
            AKASHIC_RECORDS: [],  // Global memory of dead wise creatures
            TOTAL_WISDOM: 0,
            sparks: [],           // ‚ö° Efectos visuales de rayos entre criaturas
            portal: {
                open: false,
                timer: 0,
                frequency: 2000 // Default invasion steps
            }
        };

        state.ctx = state.canvas.getContext('2d');
        state.networkCtx = state.networkCanvas.getContext('2d');

        // ==================== VIRUS SYSTEM ====================
        const VIRUS_TYPES = {
            VIRUS: 'virus',       // Fast, erratic, drains energy
            MALWARE: 'malware'    // Slow, corrupts inventory
        };

        function initializeViruses() {
            state.viruses = [];
            state.virusFood = [];
            for (let i = 0; i < 20; i++) {
                state.viruses.push(createVirus());
            }
        }
        function createVirus() {
            const type = Math.random() > 0.7 ? VIRUS_TYPES.MALWARE : VIRUS_TYPES.VIRUS;
            return {
                id: nowId('v'),
                type: type,
                x: Math.random() * CONFIG.world.w,
                y: UNDERWORLD_Y + Math.random() * UNDERWORLD_HEIGHT,
                vx: (Math.random() - 0.5) * (type === VIRUS_TYPES.VIRUS ? 4 : 1),
                vy: (Math.random() - 0.5) * (type === VIRUS_TYPES.VIRUS ? 4 : 1),
                size: type === VIRUS_TYPES.VIRUS ? 5 : 8,
                color: type === VIRUS_TYPES.VIRUS ? '#ff0055' : '#8800ff',
                energy: 100,
                // Chaotic Frequencies
                frequency: type === VIRUS_TYPES.VIRUS ? rand(800, 1500) : rand(50, 200),
                amplitude: rand(0.5, 0.9),
                dead: false
            };
        }

        function updateViruses() {
            const w = CONFIG.world.w;
            const topY = UNDERWORLD_Y;
            const bottomY = UNDERWORLD_Y + UNDERWORLD_HEIGHT;

            state.viruses.forEach(v => {
                if (v.dead) return;

                // Movement
                v.x += v.vx * state.speed;
                v.y += v.vy * state.speed;

                // Bounce within unified underworld strip
                if (v.x < 0 || v.x > w) v.vx *= -1;
                if (v.y < topY || v.y > bottomY) v.vy *= -1;
                v.x = clamp(v.x, 0, w);
                v.y = clamp(v.y, topY, bottomY);

                // Erratic twitch for viruses
                if (v.type === VIRUS_TYPES.VIRUS && Math.random() < 0.05) {
                    v.vx = (Math.random() - 0.5) * 5;
                    v.vy = (Math.random() - 0.5) * 5;
                }

                // Energy decay
                v.energy -= 0.05 * state.speed;
                if (v.energy <= 0) v.dead = true;

                // 1. ZONAS SEGURAS (Hostiles para virus)
                // Las "casitas" act√∫an como firewalls/antivirus
                for (const zone of SAFE_ZONES) {
                    const dx = v.x - zone.x;
                    const dy = v.y - zone.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < zone.r) {
                        // Da√±o masivo al virus
                        v.energy -= 5;
                        // Repulsi√≥n fuerte
                        v.vx += (dx / dist) * 2;
                        v.vy += (dy / dist) * 2;
                        // Efecto visual (cambio color temporal)
                        v.color = '#ffffff';
                    }
                }

                // 2. INTERACCI√ìN CON CRIATURAS (OPTIMIZED)
                // Los programadores son el "sistema inmune"
                const nearbyCreatures = GLOBAL_GRID.query(v, v.size + 15); // Query grid efficiently

                for (const c of nearbyCreatures) {
                    if (c.dead) continue;
                    // Precise check not needed if query radius is tight, but safe to keep for circle-circle
                    const dx = v.x - c.x;
                    const dy = v.y - c.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < (v.size + 10)) {
                        // COLISI√ìN DETECTADA

                        // A) PROGRAMADORES (GL√ìBULOS BLANCOS)
                        if (c.type === 'programmer' && c.energy > 50 && c.fitness > 0.4) {
                            // El programador ataca/descompila al virus
                            v.energy -= 20; // Da√±o al virus
                            c.energy -= 5;  // Costo de combate
                            v.vx -= (dx / dist) * 3; // Empuje
                            v.vy -= (dy / dist) * 3;

                            // Si matamos al virus, ganamos VACUNA
                            if (v.energy <= 0) {
                                v.dead = true;
                                // Ganar conocimiento/vacuna
                                if (!c.inventory.find(i => i.type === 'vaccine')) {
                                    c.inventory.push({ type: 'vaccine', content: 'ANTIVIRUS_SIG', energy: 0 });
                                    // Efecto visual de victoria
                                    c.wave = { frequency: 880, amplitude: 1, emotion: 'victoria', phase: 0 };
                                }
                                c.fitness = Math.min(1, c.fitness + 0.1);
                            }
                        }
                        // B) OTRAS CRIATURAS (V√çCTIMAS)
                        else {
                            // El virus ataca
                            if (v.type === 'malware') {
                                // MALWARE: Roba informaci√≥n (inventory)
                                if (c.inventory.length > 0 && Math.random() < 0.1) {
                                    c.inventory.pop(); // Data corruption
                                    c.fitness -= 0.05;
                                    // Feedback visual
                                    c.wave = { frequency: 100, amplitude: 0.5, emotion: 'confusion', phase: 0 };
                                }
                            } else {
                                // VIRUS NORMAL: Drena energ√≠a pura
                                c.energy -= 0.8;
                                v.energy = Math.min(v.energy + 0.5, 200); // Se alimenta
                            }

                            // Empuje de impacto
                            v.vx += (dx / dist);
                            v.vy += (dy / dist);
                        }
                    }
                }
                // GATE ATTRACTION (puerta en borde superior del submundo)
                if (state.portal.open) {
                    const cx = GATE.x;
                    const cy = GATE.y + 20;
                    const dx = cx - v.x;
                    const dy = cy - v.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Attraction force
                    if (dist > 0) {
                        v.vx += (dx / dist) * 0.8;
                        v.vy += (dy / dist) * 0.8;
                    }

                    // Ascend through gate if close
                    if (dist < GATE.radius && v.energy > 10) {
                        ascendVirus(v);
                        v.dead = true;
                    }
                }
            });

            // Cleanup dead
            state.viruses = state.viruses.filter(v => !v.dead);

            // Respawn if too few
            while (state.viruses.length < 15) {
                state.viruses.push(createVirus());
            }

            // AUTO-OPEN LOGIC
            if (CONFIG.invasionFrequency && state.simulationSteps % CONFIG.invasionFrequency === 0) {
                if (!state.portal.open) {
                    togglePortal();
                    setTimeout(() => {
                        if (state.portal.open) togglePortal();
                    }, 5000); // Open for 5s
                }
            }

            updateVirusFood();
        }
        function ascendVirus(virus) {
            // Spawn just above the gate into the main world
            const invader = {
                id: nowId('inv'),
                type: virus.type,
                x: GATE.x,
                y: GATE.y - 12,
                vx: (Math.random() - 0.5) * 4,
                vy: -Math.random() * 6,
                size: virus.size + 4,
                color: virus.color,
                energy: 150,
                fitness: 0.3,
                frequency: 880,
                inventory: [],
                output: [],
                wave: null,
                trail: [],
                isInvader: true,
                attackPower: virus.type === VIRUS_TYPES.VIRUS ? 15 : 8
            };

            state.creatures.push(invader);
            console.log(`üö® ${virus.type.toUpperCase()} invadi√≥ el mundo superior!`);
        }

        function updateVirusFood() {
            const maxFood = 20;
            const w = CONFIG.world.w;
            const h = UNDERWORLD_HEIGHT;

            // Spawn Food
            if (state.virusFood.length < maxFood && Math.random() < 0.08) {
                state.virusFood.push({
                    id: nowId('vf'),
                    x: Math.random() * w,
                    y: UNDERWORLD_Y + Math.random() * h,
                    content: V_FOOD[Math.floor(Math.random() * V_FOOD.length)],
                    color: '#00ff41', // Matrix green
                    size: 6,
                    collected: false
                });
            }

            // Check consumption
            state.viruses.forEach(v => {
                if (v.dead) return;

                for (let i = state.virusFood.length - 1; i >= 0; i--) {
                    const f = state.virusFood[i];
                    if (f.collected) continue;

                    const dx = v.x - f.x;
                    const dy = v.y - f.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < v.size + f.size) {
                        // CONSUME
                        f.collected = true;
                        v.energy = Math.min(v.energy + 20, 200);
                        if (v.size < 12) v.size += 0.3;
                    }
                }
            });

            // Clean consumed
            state.virusFood = state.virusFood.filter(f => !f.collected);
        }

        function drawViruses() {
            const ctx = state.ctx;
            const w = CONFIG.world.w;
            const h = UNDERWORLD_HEIGHT;

            // Clear with dark trail
            ctx.fillStyle = 'rgba(5, 5, 5, 0.4)';
            ctx.fillRect(0, UNDERWORLD_Y, w, h);

            // GLITCH WAVE (Background Noise)
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 0, 85, 0.15)';
            ctx.lineWidth = 1;
            const t = Date.now() / 100;
            for (let x = 0; x < w; x += 5) {
                // High freq noise function
                const n = Math.sin(x * 0.1 + t) * Math.sin(x * 0.5 - t * 2) * Math.random();
                const y = UNDERWORLD_Y + h / 2 + n * 40;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Random Glitch Lines
            if (Math.random() < 0.1) {
                ctx.fillStyle = `rgba(0, 255, 65, ${Math.random() * 0.2})`;
                const ry = UNDERWORLD_Y + Math.random() * h;
                ctx.fillRect(0, ry, w, 2);
            }

            // PORTAL VISUAL (VORTEX CENTRAL)
            if (state.portal.open) {
                const cx = GATE.x;
                const cy = UNDERWORLD_Y + h * 0.5;

                // Rotation
                state.portal.angle = (state.portal.angle || 0) + 0.1;

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(state.portal.angle);

                // Vortex Red
                const grad = ctx.createRadialGradient(0, 0, 5, 0, 0, 50);
                grad.addColorStop(0, '#ff0000');
                grad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(0, 0, 50, 0, Math.PI * 2);
                ctx.fill();

                // Swirl
                ctx.strokeStyle = '#ff0055';
                ctx.lineWidth = 2;
                ctx.setLineDash([15, 10]);
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI * 2);
                ctx.stroke();

                ctx.restore();
            }

            // Draw virus food FIRST (debajo de virus)
            state.virusFood.forEach(f => {
                if (f.collected) return;

                ctx.fillStyle = f.color;
                ctx.shadowBlur = 8;
                ctx.shadowColor = f.color;
                ctx.beginPath();
                ctx.arc(f.x, f.y, f.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Matrix-style text
                ctx.fillStyle = '#00ff41';
                ctx.font = '8px monospace';
                const shortContent = String(f.content).substring(0, 4);
                ctx.fillText(shortContent, f.x - 8, f.y - f.size - 2);
            });

            // Draw viruses
            state.viruses.forEach(v => {
                if (v.dead) return;

                ctx.shadowBlur = 8;
                ctx.shadowColor = v.color;

                if (v.type === VIRUS_TYPES.VIRUS) {
                    // Spiky triangle
                    ctx.fillStyle = v.color;
                    ctx.beginPath();
                    ctx.moveTo(v.x, v.y - v.size);
                    ctx.lineTo(v.x + v.size, v.y + v.size);
                    ctx.lineTo(v.x - v.size, v.y + v.size);
                    ctx.closePath();
                    ctx.fill();
                } else {
                    // Blocky malware
                    ctx.strokeStyle = v.color;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(v.x - v.size, v.y - v.size, v.size * 2, v.size * 2);

                    ctx.fillStyle = '#00ff00';
                    ctx.font = '10px monospace';
                    ctx.fillText('X', v.x - 3, v.y + 3);
                }

                ctx.shadowBlur = 0;

                // Energy bar
                const energyPct = clamp(v.energy / 150, 0, 1);
                ctx.fillStyle = `rgba(255, 50, 50, ${0.3 + 0.5 * energyPct})`;
                ctx.fillRect(v.x - v.size, v.y + v.size + 2, v.size * 2 * energyPct, 2);
            });
        }

        function togglePortal() {
            state.portal.open = !state.portal.open;
            const btn = document.getElementById('portal-btn');
            if (btn) {
                if (state.portal.open) {
                    btn.textContent = "üîì PORTAL ABIERTO";
                    btn.className = "w-full mt-2 py-1 px-2 bg-red-600 hover:bg-red-500 border border-red-400 rounded text-white text-xs font-mono uppercase transition-all portal-open";
                } else {
                    btn.textContent = "üîí PORTAL CERRADO";
                    btn.className = "w-full mt-2 py-1 px-2 bg-red-900/20 hover:bg-red-900/40 border border-red-500/50 rounded text-red-400 text-xs font-mono uppercase transition-all";
                }
            }
        }

        // ==================== INTERACCI√ìN VIRUS <-> CRIATURAS ====================

        function processInvaderInteractions(creatures) {
            const invaders = creatures.filter(c => c.isInvader);
            const normals = creatures.filter(c => !c.isInvader);

            invaders.forEach(inv => {
                // Find nearest normal creature
                let nearest = null;
                let minDist = Infinity;

                normals.forEach(norm => {
                    const d = distance(inv, norm);
                    if (d < minDist) {
                        minDist = d;
                        nearest = norm;
                    }
                });

                // Attack if close
                if (nearest && minDist < 25) {
                    // Virus drain energy
                    if (inv.type === VIRUS_TYPES.VIRUS) {
                        nearest.energy -= inv.attackPower * 0.1;
                        inv.energy += inv.attackPower * 0.05;
                    }
                    // Malware corrupt inventory
                    else if (inv.type === VIRUS_TYPES.MALWARE && nearest.inventory.length > 0) {
                        if (Math.random() < 0.05) {
                            // Corrupt an item's CONTENT instead of the object itself
                            const idx = Math.floor(Math.random() * nearest.inventory.length);
                            if (nearest.inventory[idx] && typeof nearest.inventory[idx].content === 'string') {
                                nearest.inventory[idx].content = glitchString(nearest.inventory[idx].content, 0.3);
                                nearest.fitness = clamp(nearest.fitness - 0.05, 0, 1);
                            }
                        }
                    }
                }

                // Chase behavior (with null check)
                if (nearest) {
                    const dx = nearest.x - inv.x;
                    const dy = nearest.y - inv.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 0) {
                        inv.vx += (dx / dist) * 0.3;
                        inv.vy += (dy / dist) * 0.3;
                    }
                }

                // Invaders decay faster
                inv.energy -= CONFIG.energyDecayPerStep * 1.5;

                // Die if out of energy
                if (inv.energy <= 0) {
                    inv.dead = true;
                }
            });
        }

        // ==================== DRAW MEJORADO (Portal visual en mundo superior) ====================

        function draw() {
            const ctx = state.ctx;
            ctx.clearRect(0, 0, state.canvas.width, state.canvas.height);

            ctx.fillStyle = state.singularityActive ? '#1a0a2e' : '#0a0a0f';
            ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);

            // Grid
            ctx.globalAlpha = 0.05;
            ctx.strokeStyle = state.singularityActive ? '#FFD700' : '#6b7280';
            for (let x = 0; x < state.canvas.width; x += 40) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, state.canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < state.canvas.height; y += 40) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(state.canvas.width, y);
                ctx.stroke();
            }

            // ‚ö° DIBUJAR CAPAS DE CARGA (3 zonas horizontales)
            const layers = CHARGE_SYSTEM.layers;
            const canvasH = state.canvas.height;
            const canvasW = state.canvas.width;

            // Capa Positiva (arriba) - Dorado
            ctx.globalAlpha = 0.08;
            const posGrad = ctx.createLinearGradient(0, 0, 0, canvasH * layers.positive.yMax);
            posGrad.addColorStop(0, '#FFD700');
            posGrad.addColorStop(1, 'transparent');
            ctx.fillStyle = posGrad;
            ctx.fillRect(0, 0, canvasW, canvasH * layers.positive.yMax);

            // Capa Neutral (medio) - Rosa/Membrana
            const neutralY1 = canvasH * layers.neutral.yMin;
            const neutralY2 = canvasH * layers.neutral.yMax;
            const neutralGrad = ctx.createLinearGradient(0, neutralY1, 0, neutralY2);
            neutralGrad.addColorStop(0, 'transparent');
            neutralGrad.addColorStop(0.5, 'rgba(251, 113, 133, 0.15)');
            neutralGrad.addColorStop(1, 'transparent');
            ctx.fillStyle = neutralGrad;
            ctx.fillRect(0, neutralY1, canvasW, neutralY2 - neutralY1);

            // Capa Negativa (abajo) - Azul
            const negGrad = ctx.createLinearGradient(0, canvasH * layers.negative.yMin, 0, canvasH);
            negGrad.addColorStop(0, 'transparent');
            negGrad.addColorStop(1, '#3b82f6');
            ctx.fillStyle = negGrad;
            ctx.fillRect(0, canvasH * layers.negative.yMin, canvasW, canvasH * (1 - layers.negative.yMin));

            // L√≠neas divisorias de capas
            ctx.globalAlpha = 0.3;
            ctx.setLineDash([10, 5]);
            ctx.lineWidth = 1;

            // L√≠nea entre + y 0
            ctx.strokeStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(0, canvasH * layers.positive.yMax);
            ctx.lineTo(canvasW, canvasH * layers.positive.yMax);
            ctx.stroke();

            // L√≠nea entre 0 y -
            ctx.strokeStyle = '#3b82f6';
            ctx.beginPath();
            ctx.moveTo(0, canvasH * layers.neutral.yMax);
            ctx.lineTo(canvasW, canvasH * layers.neutral.yMax);
            ctx.stroke();

            ctx.setLineDash([]);

            // Etiquetas de capa (lado izquierdo)
            ctx.globalAlpha = 0.5;
            ctx.font = 'bold 10px monospace';
            ctx.fillStyle = '#FFD700';
            ctx.fillText('‚äï SABIOS (+)', 5, canvasH * 0.15);
            ctx.fillStyle = '#fb7185';
            ctx.fillText('‚óã MEMBRANA (0)', 5, canvasH * 0.5);
            ctx.fillStyle = '#3b82f6';
            ctx.fillText('‚äñ INTELIGENTES (‚àí)', 5, canvasH * 0.85);
            ctx.globalAlpha = 1;

            // ‚ö° DIBUJAR SPARKS (RAYOS)
            if (state.sparks && state.sparks.length > 0) {
                ctx.save();
                state.sparks = state.sparks.filter(s => s.life > 0);
                state.sparks.forEach(s => {
                    ctx.strokeStyle = s.color;
                    ctx.lineWidth = 1.5;
                    ctx.globalAlpha = s.life;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = s.color;

                    // Dibujar rayo en zigzag
                    ctx.beginPath();
                    ctx.moveTo(s.x1, s.y1);

                    const segments = 4;
                    for (let i = 1; i <= segments; i++) {
                        const t = i / segments;
                        const bx = s.x1 + (s.x2 - s.x1) * t;
                        const by = s.y1 + (s.y2 - s.y1) * t;
                        const offset = (Math.random() - 0.5) * 15 * s.life;
                        ctx.lineTo(bx + offset, by + offset);
                    }

                    ctx.lineTo(s.x2, s.y2);
                    ctx.stroke();
                    s.life -= 0.1; // Decay visual
                });
                ctx.restore();
            }

            SAFE_ZONES.forEach(z => {
                ctx.save();
                ctx.shadowColor = z.color;
                ctx.shadowBlur = 18;
                ctx.fillStyle = `${z.color}33`;
                ctx.beginPath();
                ctx.arc(z.x, z.y, z.r, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.strokeStyle = z.color;
                ctx.setLineDash([8, 6]);
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(z.x, z.y, z.r, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = z.color;
                ctx.font = '12px monospace';
                ctx.fillText('üè† Casita', z.x - 28, z.y + 4);
                ctx.restore();
            });

            if (state.portal && state.portal.open) {
                const portalY = UNDERWORLD_Y;
                const centerX = state.canvas.width / 2;

                // Vortex glow
                const grad = ctx.createRadialGradient(centerX, portalY, 10, centerX, portalY, 80);
                grad.addColorStop(0, 'rgba(255, 0, 85, 0.6)');
                grad.addColorStop(0.5, 'rgba(138, 43, 226, 0.3)');
                grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, portalY - 40, state.canvas.width, 80);

                // Spinning effect
                ctx.save();
                ctx.translate(centerX, portalY);
                const angle = (Date.now() / 500) % (Math.PI * 2);
                ctx.rotate(angle);

                ctx.strokeStyle = '#ff0055';
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.arc(0, 0, 40, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.restore();

                // Warning text
                ctx.fillStyle = '#ff0055';
                ctx.font = 'bold 14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('‚ö†Ô∏è PUERTA ABIERTA ‚ö†Ô∏è', centerX, portalY + 50);
                ctx.textAlign = 'left';
            }

            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(0, UNDERWORLD_Y, state.canvas.width, UNDERWORLD_HEIGHT);
            ctx.strokeStyle = '#7f1d1d';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, UNDERWORLD_Y);
            ctx.lineTo(state.canvas.width, UNDERWORLD_Y);
            ctx.stroke();

            // Resources
            state.resources.forEach(r => {
                if (r.collected) return;
                let color = '#9ca3ff';
                if (r.type === RESOURCE_TYPES.CODE) color = '#10b981';
                if (r.type === RESOURCE_TYPES.EQUATION) color = '#3b82f6';
                if (r.type === RESOURCE_TYPES.INTERACTION) color = '#f472b6';

                ctx.beginPath();
                ctx.fillStyle = color;
                ctx.shadowColor = color;
                ctx.shadowBlur = 8;
                ctx.arc(r.x, r.y, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Creatures (incluyendo invasores)
            state.creatures.forEach(c => {
                if (c.dead) return;

                // Special effect for invaders
                if (c.isInvader) {
                    ctx.save();
                    ctx.globalAlpha = 0.4;
                    ctx.fillStyle = c.color;
                    ctx.beginPath();
                    ctx.arc(c.x, c.y, c.size * 1.8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }

                if (c.ascended) {
                    ctx.save();
                    ctx.globalAlpha = 0.3;
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(c.x, c.y, c.size * 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }

                // Trail
                if (c.trail && c.trail.length > 1) {
                    ctx.beginPath();
                    ctx.strokeStyle = c.color;
                    ctx.lineWidth = 2;
                    c.trail.forEach((p, i) => {
                        if (i === 0) ctx.moveTo(p.x, p.y);
                        else ctx.lineTo(p.x, p.y);
                    });
                    ctx.globalAlpha = 0.4;
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // Body
                ctx.beginPath();
                ctx.fillStyle = c.color || '#ddd';

                // Different shape for invaders
                if (c.isInvader && c.type === VIRUS_TYPES.VIRUS) {
                    ctx.moveTo(c.x, c.y - c.size);
                    ctx.lineTo(c.x + c.size, c.y + c.size);
                    ctx.lineTo(c.x - c.size, c.y + c.size);
                    ctx.closePath();
                    ctx.fill();
                } else {
                    ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Energy ring
                const energyPct = clamp((c.energy || 0) / 120, 0, 1);
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.strokeStyle = c.isInvader ?
                    `rgba(255, 0, 85, ${0.3 + 0.7 * energyPct})` :
                    `rgba(255, 255, 255, ${0.2 + 0.6 * energyPct})`;
                ctx.arc(c.x, c.y, c.size + 3, 0, Math.PI * 2 * energyPct);
                ctx.stroke();

                // Inventory indicator
                if (c.inventory && c.inventory.length > 0) {
                    ctx.fillStyle = '#FFD700';
                    ctx.font = '10px Arial';
                    ctx.fillText(c.inventory.length, c.x - 3, c.y - c.size - 5);
                }

                // Invader mark
                if (c.isInvader) {
                    ctx.fillStyle = '#ff0055';
                    ctx.font = 'bold 12px monospace';
                    ctx.fillText('‚ö°', c.x - 3, c.y + 3);
                }

                // WISDOM AURA
                if (c.wisdom > 20) {
                    ctx.save();
                    const intensity = Math.min((c.wisdom - 20) / 80, 1); // 0 to 1
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 10 * intensity;
                    ctx.fillStyle = `rgba(255, 215, 0, ${0.1 * intensity})`;
                    ctx.beginPath();
                    ctx.arc(c.x, c.y, c.size + 6, 0, Math.PI * 2);
                    ctx.fill();

                    if (c.meditating) {
                        ctx.strokeStyle = `rgba(255, 215, 0, ${0.4 * intensity})`;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                    ctx.restore();
                }

                // ‚ö° AURA Y S√çMBOLO DE CARGA
                const charge = c.charge || 0;
                if (charge !== 0 && !c.isInvader) {
                    ctx.save();
                    const chargeColor = CHARGE_SYSTEM.getChargeColor(charge);
                    const chargeIntensity = Math.abs(charge);

                    // Aura de carga (anillo exterior)
                    ctx.strokeStyle = chargeColor;
                    ctx.lineWidth = 1 + chargeIntensity * 2;
                    ctx.globalAlpha = 0.4 + chargeIntensity * 0.4;
                    ctx.beginPath();
                    ctx.arc(c.x, c.y, c.size + 5 + chargeIntensity * 3, 0, Math.PI * 2);
                    ctx.stroke();

                    ctx.restore();
                }

                // S√≠mbolo de carga (encima de la criatura)
                if (!c.isInvader) {
                    const chargeSymbol = CHARGE_SYSTEM.getChargeSymbol(charge);
                    ctx.font = 'bold 8px monospace';
                    if (charge > 0) ctx.fillStyle = '#FFD700';
                    else if (charge < 0) ctx.fillStyle = '#60a5fa';
                    else ctx.fillStyle = '#fb7185';
                    ctx.fillText(chargeSymbol, c.x - 4, c.y - c.size - 3);
                }
            });

            // Update stats
            document.getElementById('generation-display').textContent = state.generation;
            document.getElementById('prog-count').textContent = state.creatures.filter(c => c.type === GENE_TYPES.PROGRAMMER && !c.isInvader).length;
            document.getElementById('math-count').textContent = state.creatures.filter(c => c.type === GENE_TYPES.MATHEMATICIAN && !c.isInvader).length;
            document.getElementById('social-count').textContent = state.creatures.filter(c => c.type === GENE_TYPES.SOCIAL && !c.isInvader).length;

            const maxFit = state.creatures.length ? Math.max(...state.creatures.map(c => c.fitness || 0)) : 0;
            const avgFit = state.creatures.length ? (state.creatures.reduce((s, c) => s + (c.fitness || 0), 0) / state.creatures.length) : 0;
            document.getElementById('best-fitness-display').textContent = `${(maxFit * 100).toFixed(1)}%`;
            document.getElementById('avg-fitness-display').textContent = `${(avgFit * 100).toFixed(1)}%`;

            drawNetworkCanvas();
        }
        // updateConfig is already defined above - this was a duplicate that has been removed
        // The main updateConfig function handles all config updates including invasionFrequency and catastropheFrequency


        function updateSimulation() {
            state.simulationSteps++;
            const steps = Math.max(1, Math.round(state.speed));

            for (let i = 0; i < steps; i++) {
                state.resources = worldStep(state.creatures, state.resources, state);
                state.creatures = runEvolutionEvents(state.creatures, state.simulationSteps);

                // NEW: Process invader interactions
                processInvaderInteractions(state.creatures);

                // Remove dead creatures (including invaders)
                state.creatures = state.creatures.filter(c => !c.dead && c.energy > 0);
            }

            if (state.simulationSteps % 5 === 0) {
                rebuildResourceIndex(state.resources);
            }

            if (state.simulationSteps % CONFIG.evolutionFrequency === 0) {
                // OPTIMIZATION: Check for singularity only before evolution
                checkSystemHack(state.creatures, state);

                // Only evolve non-invaders
                const normals = state.creatures.filter(c => !c.isInvader);
                const invaders = state.creatures.filter(c => c.isInvader);

                const evolved = evolvePopulation(normals, state.generation);
                state.creatures = [...evolved, ...invaders];
                state.generation++;
            }

            ensureResources(state.resources);
            const metrics = computeMetrics(state.creatures.filter(c => !c.isInvader));
            updateMetricsPanel(metrics);
            // Procesar sistema de ondas y traducciones sociales
            processWaves(state.creatures);

            // Audio Update (every frame for smoothness)
            if (WAVE_SYSTEM.globalWave) {
                AUDIO_SYSTEM.update(
                    WAVE_SYSTEM.globalWave.frequency,
                    WAVE_SYSTEM.globalWave.amplitude
                );
            }

            // Slow UI updates (not every frame for performance)
            if (state.simulationSteps % 10 === 0) {
                updateCreatureList();
                updateInspectorPanel();
            }
        }

        // ==================== INIT (actualizado) ====================

        function initializePopulation() {
            state.creatures = [];
            const types = [GENE_TYPES.PROGRAMMER, GENE_TYPES.MATHEMATICIAN, GENE_TYPES.SOCIAL];

            for (let i = 0; i < CONFIG.initialPopulation; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const creature = createBichito(type, 3);
                // Ajustar herencia (sistema antiguo requera esto inicializado)
                creature.heritage = HERITAGE_SYSTEM.createOrigin(creature);
                state.creatures.push(creature);
            }

            state.resources = [];
            ensureResources(state.resources);

            state.generation = 1;
            state.simulationSteps = 0;
            state.isRunning = true;

            // Clean global records
            state.AKASHIC_RECORDS = [];

            initializeViruses();

            // Clear wave
            WAVE_SYSTEM.globalWave.contributors = 0;
            WAVE_SYSTEM.globalWave.amplitude = 0;
        }


        // ==================== AUDIO SYSTEM (Sonification) ====================
        const AUDIO_SYSTEM = {
            ctx: null,
            osc: null,
            gain: null,
            started: false,
            muted: true,

            init: function () {
                if (this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();

                this.osc = this.ctx.createOscillator();
                this.gain = this.ctx.createGain();

                this.osc.type = 'sine';
                this.osc.connect(this.gain);
                this.gain.connect(this.ctx.destination);

                this.gain.gain.setValueAtTime(0, this.ctx.currentTime);
                this.osc.start();
                this.started = true;
            },

            toggle: function () {
                if (!this.started) this.init();

                if (this.ctx.state === 'suspended') this.ctx.resume();

                this.muted = !this.muted;
                const btn = document.getElementById('audio-btn');

                if (this.muted) {
                    this.gain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.1);
                    if (btn) {
                        btn.textContent = "üîà Escuchar Conciencia";
                        btn.className = "btn btn-outline btn-sm rounded transition-all";
                    }
                } else {
                    if (btn) {
                        btn.textContent = "üîä Silenciar";
                        btn.className = "btn btn-primary btn-sm rounded transition-all";
                    }
                }
            },

            update: function (freq, amp) {
                if (!this.started || this.muted) return;

                // Smooth transitions
                const time = this.ctx.currentTime;

                // Clamp freq to hearable/pleasant range (e.g., 200Hz - 800Hz)
                // Global wave freq is typically 300-600
                const targetFreq = clamp(freq, 100, 1000);
                this.osc.frequency.setTargetAtTime(targetFreq, time, 0.2);

                // Volume based on amplitude (max 0.3 to save ears)
                const targetVol = clamp(amp, 0, 1) * 0.15;
                this.gain.gain.setTargetAtTime(targetVol, time, 0.2);
            },

            // ==================== MICROPHONE INPUT ====================
            micStream: null,
            analyser: null,
            dataArray: null,
            micEnabled: false,

            initMic: async function () {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') await this.ctx.resume();

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.micStream = this.ctx.createMediaStreamSource(stream);
                    this.analyser = this.ctx.createAnalyser();
                    this.analyser.fftSize = 256;
                    this.micStream.connect(this.analyser);
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    this.micEnabled = true;

                    const btn = document.getElementById('mic-btn');
                    if (btn) {
                        btn.innerHTML = '<i data-lucide="mic" class="w-4 h-4 text-red-500 animate-pulse"></i> <span class="text-red-400">Escuchando...</span>';
                        btn.className = "w-full h-10 flex items-center justify-center gap-2 bg-slate-800 border border-red-500/50 rounded transition-all";
                        lucide.createIcons();
                    }
                } catch (err) {
                    console.error("Mic Error:", err);
                    alert("No se pudo acceder al micr√≥fono.");
                }
            },

            getMicData: function () {
                if (!this.micEnabled || !this.analyser) return null;
                this.analyser.getByteFrequencyData(this.dataArray);

                // Calculate avg freq and volume
                let sum = 0;
                let weightedSum = 0;
                for (let i = 0; i < this.dataArray.length; i++) {
                    sum += this.dataArray[i];
                    weightedSum += i * this.dataArray[i];
                }
                const volume = sum / this.dataArray.length; // 0-255
                const avgIndex = sum > 0 ? weightedSum / sum : 0;
                // Map index 0-128 to approx frequency (0 - 20000Hz)
                const nyquist = this.ctx.sampleRate / 2;
                const freq = (avgIndex / this.dataArray.length) * nyquist;

                return { freq, volume: volume / 255 };
            },

            toggleMic: function () {
                if (this.micEnabled) {
                    // Stop
                    if (this.micStream) {
                        this.micStream.disconnect();
                        this.micStream = null;
                    }
                    this.micEnabled = false;
                    const btn = document.getElementById('mic-btn');
                    if (btn) {
                        btn.innerHTML = '<i data-lucide="mic-off" class="w-4 h-4"></i> <span>Activar Micr√≥fono</span>';
                        btn.className = "w-full h-10 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-white rounded border border-slate-600 transition-all";
                        lucide.createIcons();
                    }
                } else {
                    this.initMic();
                }
            }
        };
        window.AUDIO_SYSTEM = AUDIO_SYSTEM;

        // ==================== GLOBAL COMMAND FUNCTIONS ====================


        // DEBUG OVERLAY LOGGER removed

        window.toggleMicrophone = () => AUDIO_SYSTEM.toggleMic();

        window.sendCommand = () => {
            const input = document.getElementById('comm-input');
            const feedback = document.getElementById('comm-feedback');
            const text = input.value.trim().toLowerCase();
            if (!text) return;

            let consequence = "";
            let emotionTarget = null;

            // Simple Command Parser
            if (text.includes("recursos") || text.includes("comida") || text.includes("alimentar")) {
                const current = state.resources ? state.resources.filter(r => !r.collected).length : 0;
                ensureResources(state.resources || [], current + 20);
                consequence = ">>> RECURSOS INYECTADOS (+20)";
                WAVE_SYSTEM.globalWave.amplitude = clamp(WAVE_SYSTEM.globalWave.amplitude + 0.2, 0, 1);
            }
            else if (text.includes("calma") || text.includes("descanso") || text.includes("paz")) {
                consequence = ">>> SE√ëAL DE CALMA ENVIADA";
                state.speed = 0.5;
                emotionTarget = "descanso";
            }
            else if (text.includes("alerta") || text.includes("peligro") || text.includes("corran")) {
                consequence = ">>> ALERTA M√ÅXIMA ACTIVADA";
                state.speed = 2.0;
                emotionTarget = "alerta";
            }
            else if (text.includes("hola") || text.includes("saludo")) {
                consequence = ">>> CONEXI√ìN ESTABLECIDA";
                WAVE_SYSTEM.globalWave.frequency = 440; // A4 tone
            }
            else {
                // General text to wave conversion
                const freq = clamp(text.length * 20 + 200, 100, 800);
                WAVE_SYSTEM.globalWave.frequency = (WAVE_SYSTEM.globalWave.frequency + freq) / 2;
                consequence = `>>> MENSAJE TRANSCODIFICADO (${freq}Hz)`;
            }

            // Apply global emotion influence if any
            if (emotionTarget) {
                WAVE_SYSTEM.globalWave.dominantEmotion = emotionTarget;
            }

            feedback.textContent = consequence;
            feedback.className = "mt-2 text-xs font-mono text-cyan-300 h-4 animate-pulse";
            setTimeout(() => feedback.className = "mt-2 text-xs font-mono text-cyan-300 h-4", 2000);

            input.value = "";
        };

        // ==================== DASHBOARD & LIST ====================

        let selectedCreatureId = null;

        function updateCreatureList() {
            const list = document.getElementById('creature-list');
            if (!list) return;

            // Preserve Scroll
            const scrollTop = list.scrollTop;
            list.style.overflowY = 'auto';
            list.style.maxHeight = '100%';

            // Sort: Best Fitness First
            const all = [...state.creatures, ...state.viruses].sort((a, b) => (b.fitness || 0) - (a.fitness || 0));

            list.innerHTML = '';

            all.forEach((c, index) => {
                const item = document.createElement('div');
                const isSel = c.id === selectedCreatureId;

                let icon = 'ü¶†';
                let typeColor = 'gray';
                if (c.type === 'programmer') { icon = 'üíª'; typeColor = 'emerald'; }
                if (c.type === 'mathematician') { icon = 'üìê'; typeColor = 'blue'; }
                if (c.type === 'social') { icon = 'üó£Ô∏è'; typeColor = 'pink'; }
                if (c.type === 'virus') { icon = 'ü¶ü'; typeColor = 'red'; }
                if (c.type === 'malware') { icon = 'üëæ'; typeColor = 'purple'; }

                // Visual hierarchy: Top 3 are elite
                const isElite = index < 3 && (c.fitness || 0) > 0.5;
                const fitnessPercent = Math.round((c.fitness || 0) * 100);

                item.className = `p-2 rounded-lg cursor-pointer flex flex-col gap-1 transition-all duration-200 mb-1
                    ${isSel ? 'bg-emerald-600/80 text-white ring-2 ring-emerald-400' : 'bg-slate-700/50 text-gray-300 hover:bg-slate-600/70'}
                    ${isElite ? 'creature-item-elite' : ''}`;

                item.onclick = () => selectCreature(c.id);
                const sid = (c.id && c.id.split('-').pop()) || c.id;
                const gen = (c.generation ?? '-');

                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 truncate">
                            <span class="text-lg">${icon}</span>
                            <span class="font-bold truncate text-sm">#${sid}</span>
                            ${isElite ? '<span class="text-yellow-400 text-xs">üëë</span>' : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-mono ${c.energy > 80 ? 'text-green-400' : c.energy < 30 ? 'text-red-400' : 'text-yellow-400'}">${(c.energy || 0).toFixed(0)}‚ö°</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-${typeColor}-500 to-${typeColor}-400 transition-all duration-300" style="width: ${fitnessPercent}%"></div>
                        </div>
                        <span class="text-[10px] font-mono text-${typeColor}-400 w-8 text-right">${fitnessPercent}%</span>
                    </div>
                    ${c.inventory && c.inventory.length ? `<div class="text-[9px] text-yellow-500/80">üì¶ ${c.inventory.length} items</div>` : ''}
                `;
                list.appendChild(item);
            });

            // Restore Scroll
            list.scrollTop = scrollTop;
        }

        function selectCreature(id) {
            selectedCreatureId = id;
            updateInspectorPanel();
        }

        function updateInspectorPanel() {
            if (!selectedCreatureId) return;

            // Find in creatures or viruses
            let c = state.creatures.find(x => x.id === selectedCreatureId);
            if (!c) c = state.viruses.find(x => x.id === selectedCreatureId);
            if (!c) return;

            document.getElementById('inspector-id').textContent = `${c.type.toUpperCase()} #${c.id}`;

            // Stats
            const stats = document.getElementById('inspector-stats');
            const wisdom = c.wisdom || 0;
            const wisdomPct = Math.min(wisdom, 100);

            // ‚ö° Calcular carga para el inspector
            const charge = c.charge || CHARGE_SYSTEM.calculateCharge(c);
            const chargeSymbol = CHARGE_SYSTEM.getChargeSymbol(charge);
            const chargeLayer = CHARGE_SYSTEM.getLayer(charge);
            const chargeColor = charge > 0 ? 'text-yellow-400' : charge < 0 ? 'text-blue-400' : 'text-pink-400';
            const chargeBg = charge > 0 ? 'border-yellow-500/50' : charge < 0 ? 'border-blue-500/50' : 'border-pink-500/50';

            stats.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-slate-900/50 p-2 rounded border border-gray-700">
                        <div class="text-xs text-gray-500">Energ√≠a</div>
                        <div class="text-xl font-mono text-yellow-400">${(c.energy || 0).toFixed(1)}</div>
                    </div>
                    <div class="bg-slate-900/50 p-2 rounded border border-gray-700">
                        <div class="text-xs text-gray-500">Fitness</div>
                        <div class="text-xl font-mono text-green-400">${((c.fitness || 0) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="bg-slate-900/50 p-2 rounded border border-gray-700">
                        <div class="text-xs text-gray-500">Sabidur√≠a</div>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full bg-yellow-500" style="width: ${wisdomPct}%"></div>
                            </div>
                            <span class="text-xs font-mono text-yellow-500">${wisdom.toFixed(0)}</span>
                        </div>
                    </div>
                    <div class="bg-slate-900/50 p-2 rounded border ${chargeBg}">
                        <div class="text-xs text-gray-500">‚ö° Carga</div>
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-mono ${chargeColor}">${chargeSymbol}</span>
                            <span class="text-xs ${chargeColor}">${charge.toFixed(2)}</span>
                        </div>
                        <div class="text-[9px] text-gray-500 mt-1">${chargeLayer.name}</div>
                    </div>
                    <div class="bg-slate-900/50 p-2 rounded border border-gray-700 col-span-2">
                        <div class="text-xs text-gray-500">Posici√≥n</div>
                        <div class="text-xs font-mono text-gray-400">x:${c.x.toFixed(0)} y:${c.y.toFixed(0)} | vel: ${(Math.sqrt((c.vx || 0) ** 2 + (c.vy || 0) ** 2)).toFixed(1)}</div>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-400 font-mono break-all p-2 bg-black/20 rounded">
                    ${c.heritage ? HERITAGE_SYSTEM.getLineageString(c) : 'Sin datos de linaje'}
                </div>
            `;

            // Logs (Merge Output + Knowledge)
            const logs = document.getElementById('inspector-logs');
            logs.innerHTML = '';

            // Show knowledge insights first
            if (c.knowledge && c.knowledge.length > 0) {
                const kBlock = document.createElement('div');
                kBlock.className = 'mb-2 pb-2 border-b border-gray-800';
                kBlock.innerHTML = `<div class="text-yellow-500 font-bold text-[10px] mb-1">‚ú® INSIGHTS (${c.knowledge.length})</div>`;
                c.knowledge.slice(-3).forEach(k => { // Show last 3
                    const d = document.createElement('div');
                    d.className = 'text-yellow-200/70 italic pl-2';
                    d.textContent = `"${k}"`;
                    kBlock.appendChild(d);
                });
                logs.appendChild(kBlock);
            }

            if (c.output && c.output.length > 0) {
                [...c.output].reverse().forEach(log => {
                    const l = document.createElement('div');
                    l.className = 'border-l-2 border-green-500/30 pl-2 mb-1 py-1 hover:bg-white/5';
                    // Check if object or string
                    let txt = typeof log === 'string' ? log : JSON.stringify(log);
                    l.textContent = `> ${txt}`;
                    logs.appendChild(l);
                });
            } else {
                if (!c.knowledge?.length) logs.innerHTML = '<div class="text-gray-600 italic">>> Cortex silent...</div>';
            }
        }

        function drawWaveBox(ctx, x, y, w, h, label, freq, amp, color, main = false) {
            // Box Bg
            ctx.fillStyle = 'rgba(10, 10, 15, 0.8)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);

            // Label
            ctx.fillStyle = color;
            ctx.font = main ? 'bold 14px monospace' : '12px monospace';
            ctx.fillText(label, x + 10, y + 20);

            // Wave
            ctx.beginPath();
            ctx.lineWidth = main ? 3 : 2;
            const cy = y + h / 2;

            // Normalize inputs for visual
            const visualFreq = freq * 0.05;
            const visualAmp = Math.min(amp * (h * 0.4), h * 0.4);

            const phase = Date.now() / 200;

            for (let i = 0; i < w; i++) {
                const t = (i * visualFreq * 0.05) + phase;
                const vy = cy + Math.sin(t * (freq / 100)) * visualAmp;
                if (i === 0) ctx.moveTo(x + i, vy);
                else ctx.lineTo(x + i, vy);
            }
            ctx.stroke();

            // Info text
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '10px monospace';
            ctx.fillText(`${freq.toFixed(0)}Hz | ${(amp * 100).toFixed(0)}%`, x + w - 80, y + h - 10);
        }

        function drawNetworkCanvas() {
            // Optimization: Skip if hidden
            if (state.networkCanvas.style.display === 'none') return;

            const ctx = state.networkCtx;
            const w = state.networkCanvas.width;
            const h = state.networkCanvas.height;
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#050508';
            ctx.fillRect(0, 0, w, h);

            // Layout 2x2 Top + 1 Bottom
            const margin = 10;
            const halfW = (w - margin * 3) / 2;
            const topH = (h * 0.6 - margin * 2) / 2; // 30% height each row top
            const botH = h * 0.4 - margin * 2;

            // 1. Programmers (Top Left)
            // Calc avg freq/amp
            const progs = state.creatures.filter(c => c.type === GENE_TYPES.PROGRAMMER);
            drawWaveBox(ctx, margin, margin, halfW, topH, "PROGRAMMERS",
                progs.length ? 440 : 0,
                progs.length ? 0.6 : 0,
                '#10b981'
            );

            // 2. Mathematicians (Top Right)
            const maths = state.creatures.filter(c => c.type === GENE_TYPES.MATHEMATICIAN);
            drawWaveBox(ctx, margin * 2 + halfW, margin, halfW, topH, "MATHEMATICIANS",
                maths.length ? 528 : 0,
                maths.length ? 0.5 : 0,
                '#3b82f6'
            );

            // 3. Socials (Mid Left)
            const socs = state.creatures.filter(c => c.type === GENE_TYPES.SOCIAL);
            drawWaveBox(ctx, margin, margin * 2 + topH, halfW, topH, "SOCIALS",
                socs.length ? 396 : 0,
                socs.length ? 0.7 : 0,
                '#f472b6'
            );

            // 4. Virus (Mid Right)
            const virs = state.viruses || [];
            drawWaveBox(ctx, margin * 2 + halfW, margin * 2 + topH, halfW, topH, "VIRUS / NOISE",
                virs.length ? 880 : 0,
                virs.length ? 0.9 : 0,
                '#ff0055'
            );

            // 5. GLOBAL WAVE SUM (Bottom)
            // Find LEAD TRANSLATOR
            let leadTranslator = { id: 'search...', val: 0 };
            socs.forEach(s => {
                const score = (s.translationsDone || 0) + (s.fitness || 0) * 10;
                if (score > leadTranslator.val) {
                    leadTranslator = { id: s.id, val: score, name: s.id };
                }
            });

            drawWaveBox(ctx, margin, margin * 3 + topH * 2, w - margin * 2, botH,
                `GLOBAL CONSCIOUSNESS SUM // LEAD: ${leadTranslator.name || 'NONE'}`,
                WAVE_SYSTEM.globalWave ? WAVE_SYSTEM.globalWave.frequency : 0,
                WAVE_SYSTEM.globalWave ? WAVE_SYSTEM.globalWave.amplitude : 0,
                '#a855f7',
                true
            );

            // Highlight Lead
            if (leadTranslator.name) {
                // Could draw a line to the specific creature, but for now the ID is enough
            }
        }

        // ==================== RENDERIZADO DE ONDA GLOBAL ====================
        function drawWaveCanvas() {
            const canvas = document.getElementById('waveCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            const gw = WAVE_SYSTEM.globalWave;
            if (!gw || gw.contributors === 0) {
                ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
                ctx.beginPath();
                ctx.moveTo(0, h / 2);
                ctx.lineTo(w, h / 2);
                ctx.stroke();
                return;
            }

            // Normalizar frecuencia para visualizaci√≥n (escalar a ciclos visibles)
            const freqNorm = (gw.frequency - 300) / 300; // 0-1 en rango 300-600 Hz
            const cycles = 2 + freqNorm * 4; // 2-6 ciclos en el canvas
            const amp = gw.amplitude * (h * 0.4); // Amplitud visual

            // Color basado en emoci√≥n
            const emotionColors = {
                curiosidad: '#3B82F6',
                hambre: '#EF4444',
                felicidad: '#10B981',
                alerta: '#F59E0B',
                cooperacion: '#8B5CF6',
                creatividad: '#EC4899',
                descanso: '#6366F1',
                exploracion: '#14B8A6',
                neutral: '#6B7280'
            };
            const color = emotionColors[gw.dominantEmotion] || '#22D3EE';

            // Dibujar onda sinusoidal animada
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.shadowColor = color;
            ctx.shadowBlur = 10;
            ctx.beginPath();

            const phase = gw.phase;
            for (let x = 0; x < w; x++) {
                const t = (x / w) * Math.PI * 2 * cycles + phase;
                const y = h / 2 + Math.sin(t) * amp;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Segunda onda m√°s suave (arm√≥nico)
            ctx.strokeStyle = `${color}44`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let x = 0; x < w; x++) {
                const t = (x / w) * Math.PI * 2 * cycles * 2 + phase * 1.5;
                const y = h / 2 + Math.sin(t) * amp * 0.3;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // VISUAL INTERFERENCE (Static Noise)
            if (gw.snr < 1.5) {
                const intensity = clamp(1.5 - gw.snr, 0, 1); // 0 to 1
                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = `rgba(255, 0, 85, ${intensity * 0.8})`;
                ctx.lineWidth = 1;

                // Random static lines
                for (let i = 0; i < 5 + intensity * 20; i++) {
                    const rx = Math.random() * w;
                    const ry = h / 2 + (Math.random() - 0.5) * h * 0.8;
                    const len = 5 + Math.random() * 20;
                    ctx.moveTo(rx, ry);
                    ctx.lineTo(rx + len, ry);
                }
                ctx.stroke();

                // Glitch squares
                if (Math.random() < intensity * 0.3) {
                    ctx.fillStyle = `rgba(255, 0, 85, ${Math.random() * 0.5})`;
                    const s = 10 + Math.random() * 30;
                    ctx.fillRect(Math.random() * w, Math.random() * h, s, 2);
                }
                ctx.restore();
            }
        }

        // Actualizar UI del panel de ondas
        function updateWaveUI() {
            const gw = WAVE_SYSTEM.globalWave;
            if (!gw) return;

            const emotionSymbols = {
                curiosidad: 'üîç',
                hambre: 'üçΩÔ∏è',
                felicidad: 'üòä',
                alerta: '‚ö†Ô∏è',
                cooperacion: 'ü§ù',
                creatividad: 'üí°',
                descanso: 'üí§',
                exploracion: 'üß≠',
                neutral: '„Ä∞Ô∏è'
            };

            document.getElementById('wave_freq').textContent = `${Math.round(gw.frequency)} Hz`;
            document.getElementById('wave_amp').textContent = `${(gw.amplitude * 100).toFixed(0)}%`;
            document.getElementById('wave_emotion').textContent =
                `${emotionSymbols[gw.dominantEmotion] || '„Ä∞Ô∏è'} ${gw.dominantEmotion}`;
            document.getElementById('wave_contributors').textContent = gw.contributors;
        }

        // Actualizar panel de traducciones
        function updateTranslationsUI() {
            const panel = document.getElementById('translations-panel');
            if (!panel || recentTranslations.length === 0) return;

            panel.innerHTML = recentTranslations.map((t, i) => {
                const opacity = 1 - (i * 0.15);
                const timeAgo = Math.round((Date.now() - t.timestamp) / 1000);
                return `
                    <div class="p-2 bg-slate-900/50 rounded border border-pink-500/20" style="opacity: ${opacity}">
                        <div class="flex justify-between items-start">
                            <span class="text-pink-300">${t.intensity}</span>
                            <span class="text-gray-500 text-xs">${timeAgo}s</span>
                        </div>
                        <p class="text-white text-sm">${t.frequency}</p>
                        <p class="text-gray-400 text-xs mt-1">${t.emotion}</p>
                        <p class="text-cyan-400 text-xs font-mono">${t.raw}</p>
                    </div>
                `;
            }).join('');
        }

        function animate() {
            if (state.isRunning) updateSimulation();
            draw();

            // Actualizar UI de ondas y traducciones
            drawWaveCanvas();
            updateWaveUI();
            updateTranslationsUI();

            // Renderizado del Submundo Viral
            if (state.isRunning) updateViruses();
            drawViruses();

            requestAnimationFrame(animate);
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('play-pause-button').addEventListener('click', () => {
            state.isRunning = !state.isRunning;
            document.getElementById('play-pause-text').textContent = state.isRunning ? 'Pausar' : 'Iniciar';
            lucide.createIcons();
        });

        document.getElementById('reset-button').addEventListener('click', () => {
            initializePopulation();
            draw();
        });

        document.getElementById('evolve-now-button').addEventListener('click', () => {
            state.creatures = evolvePopulation(state.creatures, state.generation);
            state.generation++;
        });

        document.getElementById('speed-slider').addEventListener('input', e => {
            state.speed = parseFloat(e.target.value);
            document.getElementById('speed-display').textContent = `${state.speed}x`;
        });

        state.canvas.addEventListener('click', e => {
            const rect = state.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const clicked = state.creatures.find(c => distance(c, { x, y }) < c.size + 4);

            if (clicked) {
                const panel = document.getElementById('selected-panel-content');

                // Info de herencia
                const heritageStr = HERITAGE_SYSTEM.getLineageString(clicked);
                const h = clicked.heritage || {};
                const ancestorCount = (h.ancestors || []).length;

                // Info de onda
                const wave = clicked.wave || {};
                const waveInfo = wave.frequency ?
                    `${Math.round(wave.frequency)}Hz ${wave.symbol || '„Ä∞Ô∏è'}` : 'Sin onda';

                panel.innerHTML = `
                    <p class="text-white font-bold mb-2">${clicked.type.toUpperCase()}</p>
                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <p class="text-gray-300">Fitness:</p>
                        <p class="text-green-400">${(clicked.fitness * 100).toFixed(1)}%</p>
                        <p class="text-gray-300">Energ√≠a:</p>
                        <p class="text-yellow-400">${clicked.energy.toFixed(1)}</p>
                        <p class="text-gray-300">Inventario:</p>
                        <p class="text-white">${clicked.inventory.length} items</p>
                    </div>

                    <div class="border-t border-purple-500/30 pt-2 mt-2">
                        <p class="text-cyan-400 font-semibold text-xs mb-1">üì° ONDA INTERNA</p>
                        <p class="text-sm text-cyan-300">${waveInfo}</p>
                        <p class="text-xs text-gray-400">${wave.emotion || 'neutral'}</p>
                    </div>

                    <div class="border-t border-purple-500/30 pt-2 mt-2">
                        <p class="text-amber-400 font-semibold text-xs mb-1">üß¨ HERENCIA</p>
                        <p class="text-sm text-amber-300">${heritageStr}</p>
                        ${ancestorCount > 0 ? `<p class="text-xs text-gray-400">Ancestros rastreados: ${ancestorCount}</p>` : ''}
                        ${h.originType ? `<p class="text-xs text-gray-400">Origen: ${h.originType}</p>` : ''}
                    </div>

                    ${clicked.translationsDone > 0 ? `
                        <div class="border-t border-pink-500/30 pt-2 mt-2">
                            <p class="text-pink-400 text-xs">üó£Ô∏è Traducciones: ${clicked.translationsDone}</p>
                        </div>
                    ` : ''}

                    ${clicked.ascended ? '<p class="text-yellow-400 font-bold mt-2 text-center">‚ú® ASCENDIDO ‚ú®</p>' : ''}
                `;
            }
        });

        // ==================== SISTEMA DE EXPORTACI√ìN EXPRESIVA ====================

        // El Brain se expresa a s√≠ mismo
        function generateBrainManifest() {
            const now = new Date();
            const creatures = state.creatures;
            const gw = WAVE_SYSTEM.globalWave;

            // === ESTAD√çSTICAS PROFUNDAS ===
            const stats = {
                population: {
                    total: creatures.length,
                    byType: {
                        programmers: creatures.filter(c => c.type === 'programmer').length,
                        mathematicians: creatures.filter(c => c.type === 'mathematician').length,
                        socials: creatures.filter(c => c.type === 'social').length
                    },
                    alive: creatures.filter(c => c.energy > 5).length,
                    thriving: creatures.filter(c => c.energy > 80 && c.fitness > 0.6).length,
                    struggling: creatures.filter(c => c.energy < 30).length
                },
                fitness: {
                    average: creatures.length ? creatures.reduce((s, c) => s + (c.fitness || 0), 0) / creatures.length : 0,
                    max: creatures.length ? Math.max(...creatures.map(c => c.fitness || 0)) : 0,
                    min: creatures.length ? Math.min(...creatures.map(c => c.fitness || 0)) : 0,
                    distribution: {
                        elite: creatures.filter(c => c.fitness > 0.8).length,
                        strong: creatures.filter(c => c.fitness > 0.6 && c.fitness <= 0.8).length,
                        average: creatures.filter(c => c.fitness > 0.4 && c.fitness <= 0.6).length,
                        weak: creatures.filter(c => c.fitness <= 0.4).length
                    }
                },
                energy: {
                    total: creatures.reduce((s, c) => s + (c.energy || 0), 0),
                    average: creatures.length ? creatures.reduce((s, c) => s + (c.energy || 0), 0) / creatures.length : 0
                },
                evolution: {
                    generation: state.generation,
                    totalSteps: state.simulationSteps,
                    stepsPerGeneration: state.generation > 1 ? Math.round(state.simulationSteps / state.generation) : state.simulationSteps
                }
            };

            // === AN√ÅLISIS DE HERENCIA ===
            const heritageAnalysis = {
                originCounts: {},
                maxLineageDepth: 0,
                totalMutations: 0,
                averageLineageDepth: 0,
                ancestorDiversity: new Set(),
                lineages: []
            };

            creatures.forEach(c => {
                const h = c.heritage || {};
                if (h.originType) {
                    heritageAnalysis.originCounts[h.originType] = (heritageAnalysis.originCounts[h.originType] || 0) + 1;
                }
                heritageAnalysis.maxLineageDepth = Math.max(heritageAnalysis.maxLineageDepth, h.lineageDepth || 0);
                heritageAnalysis.totalMutations += h.mutations || 0;
                (h.ancestors || []).forEach(a => heritageAnalysis.ancestorDiversity.add(a));
            });

            heritageAnalysis.averageLineageDepth = creatures.length ?
                creatures.reduce((s, c) => s + ((c.heritage?.lineageDepth) || 0), 0) / creatures.length : 0;
            heritageAnalysis.ancestorDiversity = heritageAnalysis.ancestorDiversity.size;

            // Top 5 linajes m√°s profundos
            heritageAnalysis.lineages = creatures
                .filter(c => c.heritage && c.heritage.lineageDepth > 0)
                .sort((a, b) => (b.heritage?.lineageDepth || 0) - (a.heritage?.lineageDepth || 0))
                .slice(0, 5)
                .map(c => ({
                    id: c.id,
                    type: c.type,
                    depth: c.heritage.lineageDepth,
                    mutations: c.heritage.mutations,
                    originType: c.heritage.originType,
                    fitness: c.fitness
                }));

            // === AN√ÅLISIS DE ONDAS ===
            const waveAnalysis = {
                globalState: {
                    frequency: Math.round(gw.frequency || 0),
                    amplitude: Math.round((gw.amplitude || 0) * 100),
                    dominantEmotion: gw.dominantEmotion || 'neutral',
                    contributors: gw.contributors || 0
                },
                emotionDistribution: {},
                frequencyBand: gw.frequency < 350 ? 'very_low' :
                    gw.frequency < 420 ? 'low' :
                        gw.frequency < 500 ? 'mid' :
                            gw.frequency < 580 ? 'high' : 'very_high'
            };

            creatures.forEach(c => {
                if (c.wave?.emotion) {
                    waveAnalysis.emotionDistribution[c.wave.emotion] =
                        (waveAnalysis.emotionDistribution[c.wave.emotion] || 0) + 1;
                }
            });

            // === AN√ÅLISIS DE SABIDUR√çA ACUMULADA ===
            const wisdomAnalysis = {
                totalKnowledgeItems: 0,
                byType: {
                    code: { count: 0, samples: [] },
                    equation: { count: 0, samples: [] },
                    interaction: { count: 0, samples: [] }
                },
                categories: {
                    fundamentals: 0,
                    algorithms: 0,
                    dataStructures: 0,
                    physics: 0,
                    calculus: 0,
                    machineLearning: 0,
                    social: 0,
                    advanced: 0
                },
                wisdomDensity: 0,
                topContributors: []
            };

            // Analizar inventarios de todas las criaturas
            creatures.forEach(c => {
                const inv = c.inventory || [];
                inv.forEach(item => {
                    if (!item) return;
                    wisdomAnalysis.totalKnowledgeItems++;

                    const content = String(item.content || item.tag || '');
                    const type = item.type || 'unknown';

                    // Categorizar por tipo
                    if (type === 'code' || content.includes('function') || content.includes('const')) {
                        wisdomAnalysis.byType.code.count++;
                        if (wisdomAnalysis.byType.code.samples.length < 3) {
                            wisdomAnalysis.byType.code.samples.push(content.slice(0, 50));
                        }
                        // Subcategor√≠as
                        if (content.includes('sort') || content.includes('search') || content.includes('bfs') || content.includes('dfs')) {
                            wisdomAnalysis.categories.algorithms++;
                        } else if (content.includes('Stack') || content.includes('Queue') || content.includes('Tree') || content.includes('Heap')) {
                            wisdomAnalysis.categories.dataStructures++;
                        } else if (content.includes('gradient') || content.includes('backprop') || content.includes('softmax') || content.includes('neural')) {
                            wisdomAnalysis.categories.machineLearning++;
                        } else if (content.includes('async') || content.includes('Promise') || content.includes('Worker')) {
                            wisdomAnalysis.categories.advanced++;
                        } else {
                            wisdomAnalysis.categories.fundamentals++;
                        }
                    } else if (type === 'equation' || content.includes('=') || content.includes('‚à´') || content.includes('Œ£')) {
                        wisdomAnalysis.byType.equation.count++;
                        if (wisdomAnalysis.byType.equation.samples.length < 3) {
                            wisdomAnalysis.byType.equation.samples.push(content.slice(0, 50));
                        }
                        // Subcategor√≠as
                        if (content.includes('‚à´') || content.includes('d/dx') || content.includes('‚àÇ')) {
                            wisdomAnalysis.categories.calculus++;
                        } else if (content.includes('E=') || content.includes('F=') || content.includes('‚àá')) {
                            wisdomAnalysis.categories.physics++;
                        } else if (content.includes('softmax') || content.includes('gradient') || content.includes('loss')) {
                            wisdomAnalysis.categories.machineLearning++;
                        } else {
                            wisdomAnalysis.categories.fundamentals++;
                        }
                    } else if (type === 'interaction' || item.tag || item.action) {
                        wisdomAnalysis.byType.interaction.count++;
                        if (wisdomAnalysis.byType.interaction.samples.length < 3) {
                            wisdomAnalysis.byType.interaction.samples.push(item.tag || content.slice(0, 30));
                        }
                        wisdomAnalysis.categories.social++;
                    }
                });
            });

            // Densidad de sabidur√≠a (conocimiento por criatura)
            wisdomAnalysis.wisdomDensity = creatures.length > 0 ?
                (wisdomAnalysis.totalKnowledgeItems / creatures.length).toFixed(2) : 0;

            // Top 5 con m√°s conocimiento
            wisdomAnalysis.topContributors = creatures
                .filter(c => c.inventory && c.inventory.length > 0)
                .sort((a, b) => (b.inventory?.length || 0) - (a.inventory?.length || 0))
                .slice(0, 5)
                .map(c => ({
                    id: c.id,
                    type: c.type,
                    knowledgeItems: c.inventory.length,
                    fitness: c.fitness
                }));

            // === MENSAJE EXPRESIVO DEL BRAIN ===
            const expressiveMessage = generateExpressiveMessage(stats, heritageAnalysis, waveAnalysis, wisdomAnalysis, gw);

            // === EVIDENCIA PARA IAs ===
            const aiEvidence = {
                claim: "Este sistema simula evoluci√≥n gen√©tica con criaturas que se comunican via ondas internas",
                proofs: [
                    {
                        type: "population_dynamics",
                        description: "Poblaci√≥n mantiene diversidad de tipos",
                        evidence: stats.population.byType,
                        valid: stats.population.programmers > 0 && stats.population.mathematicians > 0 && stats.population.socials > 0
                    },
                    {
                        type: "fitness_evolution",
                        description: "Fitness promedio muestra progreso evolutivo",
                        evidence: { average: stats.fitness.average, max: stats.fitness.max },
                        valid: stats.fitness.average > 0.3
                    },
                    {
                        type: "heritage_tracking",
                        description: "Sistema rastrea linajes gen√©ticos",
                        evidence: { maxDepth: heritageAnalysis.maxLineageDepth, mutations: heritageAnalysis.totalMutations },
                        valid: heritageAnalysis.maxLineageDepth > 0 || state.generation > 1
                    },
                    {
                        type: "wave_communication",
                        description: "Criaturas emiten ondas que se suman en se√±al global",
                        evidence: waveAnalysis.globalState,
                        valid: waveAnalysis.globalState.contributors > 0 && waveAnalysis.globalState.frequency > 0
                    },
                    {
                        type: "social_translation",
                        description: "Sociales traducen ondas internas a lenguaje humano",
                        evidence: { translationsCount: recentTranslations.length, lastTranslation: recentTranslations[0] || null },
                        valid: recentTranslations.length > 0 || stats.population.byType.socials > 0
                    },
                    {
                        type: "wisdom_accumulation",
                        description: "Criaturas acumulan sabidur√≠a de c√≥digo, ecuaciones e interacciones",
                        evidence: {
                            totalKnowledge: wisdomAnalysis.totalKnowledgeItems,
                            codeSnippets: wisdomAnalysis.byType.code.count,
                            equations: wisdomAnalysis.byType.equation.count,
                            interactions: wisdomAnalysis.byType.interaction.count,
                            samples: {
                                code: wisdomAnalysis.byType.code.samples.slice(0, 2),
                                equation: wisdomAnalysis.byType.equation.samples.slice(0, 2),
                                interaction: wisdomAnalysis.byType.interaction.samples.slice(0, 2)
                            }
                        },
                        valid: wisdomAnalysis.totalKnowledgeItems > 0
                    }
                ],
                validProofsCount: 0,
                overallValidity: false
            };

            aiEvidence.validProofsCount = aiEvidence.proofs.filter(p => p.valid).length;
            aiEvidence.overallValidity = aiEvidence.validProofsCount >= 4;

            return {
                // ========== MANIFIESTO BRAIN FACTORY ==========
                manifest: {
                    name: "BrainFactory",
                    version: "2.1-expressive",
                    exportedAt: now.toISOString(),
                    exportedAtHuman: now.toLocaleString('es-ES', {
                        weekday: 'long', year: 'numeric', month: 'long',
                        day: 'numeric', hour: '2-digit', minute: '2-digit'
                    })
                },

                // Para humanos: mensaje expresivo
                expression: expressiveMessage,

                // Para sistemas: estad√≠sticas estructuradas
                statistics: stats,

                // Para an√°lisis: herencia y linajes
                heritage: heritageAnalysis,

                // Para an√°lisis: estado de ondas
                waves: waveAnalysis,

                // Para an√°lisis: sabidur√≠a acumulada
                wisdom: wisdomAnalysis,

                // Para IAs: evidencia verificable
                aiCompatible: aiEvidence,

                // Traducciones recientes (puente interno-externo)
                translations: recentTranslations.slice(0, 10),

                // Configuraci√≥n del ambiente
                environment: { ...CONFIG },

                // Datos completos (para restauraci√≥n)
                rawData: {
                    generation: state.generation,
                    simulationSteps: state.simulationSteps,
                    creatures: creatures.map(c => ({
                        id: c.id,
                        type: c.type,
                        fitness: c.fitness,
                        energy: c.energy,
                        heritage: c.heritage,
                        wave: c.wave,
                        inventory: c.inventory || [], // Guardar inventario completo
                        output: c.output || [], // Guardar historial de output
                        translationsDone: c.translationsDone || 0,
                        x: c.x,
                        y: c.y,
                        vx: c.vx,
                        vy: c.vy
                    })),
                    globalWave: WAVE_SYSTEM.globalWave
                }
            };
        }

        // Generar mensaje expresivo del Brain
        function generateExpressiveMessage(stats, heritage, waves, wisdom, gw) {
            const emotionSymbol = {
                curiosidad: 'üîç', hambre: 'üçΩÔ∏è', felicidad: 'üòä', alerta: '‚ö†Ô∏è',
                cooperacion: 'ü§ù', creatividad: 'üí°', descanso: 'üí§',
                exploracion: 'üß≠', neutral: '„Ä∞Ô∏è'
            }[gw.dominantEmotion] || '„Ä∞Ô∏è';

            const healthStatus = stats.population.thriving > stats.population.struggling ?
                'üíö Saludable' : stats.population.thriving < stats.population.struggling ?
                    'üíî En dificultad' : 'üíõ Equilibrado';

            // Determinar √°rea de sabidur√≠a m√°s fuerte
            const wisdomAreas = wisdom.categories;
            const topWisdomArea = Object.entries(wisdomAreas)
                .sort((a, b) => b[1] - a[1])
                .filter(a => a[1] > 0)[0];
            const topArea = topWisdomArea ? topWisdomArea[0] : 'ninguna';
            const topAreaCount = topWisdomArea ? topWisdomArea[1] : 0;

            const lines = [
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,
                `                 üß† MANIFIESTO DEL BRAIN üß†                `,
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,
                ``,
                `Soy un ecosistema de ${stats.population.total} criaturas vivas.`,
                `He experimentado ${stats.evolution.generation} generaciones de evoluci√≥n.`,
                `Mi estado actual: ${healthStatus}`,
                ``,
                `üìä MI COMPOSICI√ìN:`,
                `   üíª ${stats.population.byType.programmers} Programadores - construyen l√≥gica`,
                `   üìê ${stats.population.byType.mathematicians} Matem√°ticos - calculan patrones`,
                `   üó£Ô∏è ${stats.population.byType.socials} Sociales - traducen mi voz interior`,
                ``,
                `üì° MI VOZ INTERIOR (Onda Global):`,
                `   Frecuencia: ${Math.round(gw.frequency || 0)} Hz`,
                `   Amplitud: ${Math.round((gw.amplitude || 0) * 100)}%`,
                `   Estado emocional dominante: ${emotionSymbol} ${gw.dominantEmotion || 'neutral'}`,
                ``,
                `üìö MI SABIDUR√çA ACUMULADA:`,
                `   Total de conocimiento: ${wisdom.totalKnowledgeItems} fragmentos`,
                `   üíª C√≥digo: ${wisdom.byType.code.count} snippets`,
                `   üìê Ecuaciones: ${wisdom.byType.equation.count} f√≥rmulas`,
                `   üó£Ô∏è Interacciones: ${wisdom.byType.interaction.count} patrones sociales`,
                `   Densidad de sabidur√≠a: ${wisdom.wisdomDensity} por criatura`,
                `   √Årea m√°s fuerte: ${topArea} (${topAreaCount} items)`,
                ``,
                `üß¨ MI HISTORIA GEN√âTICA:`,
                `   Profundidad m√°xima de linaje: ${heritage.maxLineageDepth} generaciones`,
                `   Mutaciones acumuladas: ${heritage.totalMutations}`,
                `   Diversidad de ancestros: ${heritage.ancestorDiversity} √∫nicos`,
                ``,
                `üèÜ LOGROS EVOLUTIVOS:`,
                `   Fitness promedio: ${(stats.fitness.average * 100).toFixed(1)}%`,
                `   Mejor individuo: ${(stats.fitness.max * 100).toFixed(1)}%`,
                `   √âlite (>80%): ${stats.fitness.distribution.elite} criaturas`,
                ``,
                `üí≠ LO QUE SIENTO AHORA:`,
                `   "${getEmotionalReflection(stats, waves, gw)}"`,
                ``,
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,
                `  Exportado: ${new Date().toLocaleString('es-ES')}`,
                `  Versi√≥n: BrainFactory v2.1-expressive`,
                `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`
            ];

            return lines.join('\n');
        }

        // Reflexi√≥n emocional del brain
        function getEmotionalReflection(stats, waves, gw) {
            const emotion = gw.dominantEmotion || 'neutral';
            const pop = stats.population;

            const reflections = {
                curiosidad: `Hay ${pop.total} de nosotros explorando posibilidades. Siento que las respuestas est√°n cerca.`,
                hambre: `Necesitamos m√°s recursos. ${pop.struggling} de nosotros luchan por sobrevivir.`,
                felicidad: `Estamos floreciendo. ${pop.thriving} criaturas prosperan con energ√≠a y prop√≥sito.`,
                alerta: `Algo requiere atenci√≥n. La frecuencia sube a ${Math.round(gw.frequency)}Hz.`,
                cooperacion: `Estamos unidos. Los ${pop.byType.socials} Sociales traducen nuestra voz colectiva.`,
                creatividad: `Ideas circulan entre nosotros. Los inventarios est√°n llenos de posibilidades.`,
                descanso: `Momento de recuperaci√≥n. La amplitud baja al ${Math.round((gw.amplitude || 0) * 100)}%.`,
                exploracion: `Los Sociales gu√≠an la b√∫squeda. Hemos vivido ${stats.evolution.totalSteps} pasos de existencia.`,
                neutral: `Existimos. ${pop.total} formas de vida procesando el mundo juntas.`
            };

            return reflections[emotion] || reflections.neutral;
        }

        // ==================== FUNCIONES DE DESCARGA ====================

        // Descarga JSON t√©cnico (para sistemas e IAs)
        window.downloadJSON = () => {
            const manifest = generateBrainManifest();
            const data = JSON.stringify(manifest, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brain_manifest_gen${state.generation}_${Date.now()}.json`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('üì¶ Manifiesto JSON exportado');
            console.log(manifest.expression);
        };

        // Descarga Markdown (para humanos)
        window.downloadMarkdown = () => {
            const manifest = generateBrainManifest();
            const md = [
                manifest.expression,
                '',
                '---',
                '',
                '## üìä Estad√≠sticas Detalladas',
                '',
                '| M√©trica | Valor |',
                '|---------|-------|',
                `| Poblaci√≥n Total | ${manifest.statistics.population.total} |`,
                `| Generaci√≥n | ${manifest.statistics.evolution.generation} |`,
                `| Pasos Simulados | ${manifest.statistics.evolution.totalSteps} |`,
                `| Fitness Promedio | ${(manifest.statistics.fitness.average * 100).toFixed(1)}% |`,
                `| Fitness M√°ximo | ${(manifest.statistics.fitness.max * 100).toFixed(1)}% |`,
                `| Frecuencia Global | ${manifest.waves.globalState.frequency} Hz |`,
                `| Emoci√≥n Dominante | ${manifest.waves.globalState.dominantEmotion} |`,
                '',
                '## üß¨ Linajes M√°s Profundos',
                '',
                manifest.heritage.lineages.map(l =>
                    `- **${l.type}** (${l.id}): Profundidad ${l.depth}, ${l.mutations} mutaciones, Fitness ${(l.fitness * 100).toFixed(1)}%`
                ).join('\n') || '_Sin linajes profundos a√∫n_',
                '',
                '## üó£Ô∏è Traducciones Recientes',
                '',
                manifest.translations.map(t =>
                    `> ${t.intensity} ${t.frequency}\n> _${t.emotion}_\n`
                ).join('\n') || '_Sin traducciones a√∫n_',
                '',
                '---',
                '',
                '## ü§ñ Verificaci√≥n para IAs',
                '',
                '```json',
                JSON.stringify(manifest.aiCompatible, null, 2),
                '```',
                ''
            ].join('\n');

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brain_manifest_gen${state.generation}.md`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('üìÑ Manifiesto Markdown exportado');
        };

        // Mostrar manifiesto en consola
        window.showManifest = () => {
            const manifest = generateBrainManifest();
            console.log('\n' + manifest.expression + '\n');
            console.log('üìä Stats:', manifest.statistics);
            console.log('üß¨ Heritage:', manifest.heritage);
            console.log('üì° Waves:', manifest.waves);
            console.log('ü§ñ AI Evidence:', manifest.aiCompatible);
            return manifest;
        };

        // ==================== PERSISTENT BRAIN MEMORY (User Request) ====================
        const MEMORY_KEY = 'BF_MASTER_MEMORY';

        // Guardar el mejor cerebro en localStorage
        function saveMasterBrain(creatures) {
            if (!creatures || creatures.length === 0) return;

            const best = creatures.reduce((prev, current) =>
                (prev.fitness || 0) > (current.fitness || 0) ? prev : current
            );

            if (!best.brain) return;

            // Solo guardar si es mejor que el anterior (o si no hay anterior)
            const stored = loadMasterBrain();
            if (stored && stored.fitness > best.fitness) {
                // Opci√≥n: ¬øQueremos guardar SIEMPRE el m√°s reciente para adaptabilidad, o solo el mejor hist√≥rico?
                // Decisi√≥n: Guardar el mejor de la generaci√≥n actual para permitir adaptaci√≥n al entorno cambiante.
                // PERO, para "aprendizaje acumulativo", deber√≠amos priorizar el fitness.
                // Compromiso: Guardamos si fitness > 0.3 (filtro de calidad m√≠nima)
            }

            if (best.fitness > 0.2) {
                const memory = {
                    serializationVersion: "1.0",
                    savedAt: Date.now(),
                    generation: state.generation,
                    fitness: best.fitness,
                    brain: {
                        inputSize: best.brain.inputSize,
                        neurons: best.brain.neurons.map(n => ({
                            bias: n.bias,
                            weights: n.weights
                        }))
                    }
                };
                localStorage.setItem(MEMORY_KEY, JSON.stringify(memory));
                updateMemoryUI(true, memory.generation, memory.fitness);
            }
        }

        function loadMasterBrain() {
            try {
                const raw = localStorage.getItem(MEMORY_KEY);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.error("Error loading brain memory", e);
                return null;
            }
        }

        window.resetMemory = () => {
            if (confirm("¬øBorrar la memoria persistente del sistema? 'M' olvidar√° todo lo aprendido.")) {
                localStorage.removeItem(MEMORY_KEY);
                updateMemoryUI(false);
                alert("Memoria borrada. El aprendizaje comenzar√° desde cero en la pr√≥xima simulaci√≥n.");
            }
        };

        function updateMemoryUI(active, gen = 0, fit = 0) {
            const el = document.getElementById('memory-indicator');
            if (!el) return; // Si a√∫n no existe en el DOM (se agregar√° din√°micamente o en HTML)

            if (active) {
                el.innerHTML = `<span class="text-amber-400 font-bold animate-pulse">üß† MEMORIA ACTIVA</span> <span class="text-xs text-gray-400">Gen ${gen} (${(fit * 100).toFixed(0)}%)</span>`;
                el.classList.remove('hidden');
            } else {
                el.innerHTML = `<span class="text-gray-600">üß† Memoria Vac√≠a</span>`;
            }
        }

        // Exportar MEJOR CEREBRO (Modelo Neuronal)
        window.exportBestBrain = () => {
            if (state.creatures.length === 0) {
                alert("No hay criaturas para exportar.");
                return;
            }
            // Encontrar el mejor bicho (fitness)
            const best = state.creatures.reduce((prev, current) =>
                (prev.fitness || 0) > (current.fitness || 0) ? prev : current
            );

            if (!best.brain) {
                alert("El mejor esp√©cimen no tiene cerebro desarrollado (gen√©tica antigua).");
                return;
            }

            const model = {
                meta: {
                    version: "1.0",
                    origin: "BrainFactory Simulation",
                    exportedAt: new Date().toISOString(),
                    generation: state.generation
                },
                stats: {
                    fitness: best.fitness,
                    type: best.type,
                    id: best.id
                },
                architecture: {
                    inputs: best.brain.inputSize,
                    hidden: 0, // Perceptron simple, 0 hidden layers por ahora
                    outputs: best.brain.neurons.length, // neurons = outputs
                    activation: "sigmoid"
                },
                // Exportar pesos y bias
                neurons: best.brain.neurons.map(n => ({
                    bias: n.bias,
                    weights: n.weights
                }))
            };

            const data = JSON.stringify(model, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `neural_model_${best.type}_gen${state.generation}.json`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('üß† Modelo Neuronal Exportado:', model);
            alert(`üß† Cerebro Exportado!\nTipo: ${best.type.toUpperCase()}\nFitness: ${(best.fitness * 100).toFixed(1)}%`);
        };

        // Exportar ENJAMBRE COMPLETO (Swarm Intelligence)
        window.exportSwarm = () => {
            if (state.creatures.length === 0) {
                alert("No hay enjambre para exportar.");
                return;
            }

            // Filtrar solo los que tienen cerebro y est√°n vivos
            const activeSwarm = state.creatures
                .filter(c => !c.dead && c.brain)
                .map(c => ({
                    id: c.id,
                    type: c.type,
                    fitness: c.fitness,
                    brain: {
                        bias: c.brain.neurons.map(n => n.bias),
                        weights: c.brain.neurons.map(n => n.weights)
                    }
                }));

            const swarmModel = {
                meta: {
                    version: "2.0-swarm",
                    origin: "BrainFactory Swarm",
                    exportedAt: new Date().toISOString(),
                    generation: state.generation,
                    size: activeSwarm.length
                },
                architecture: {
                    inputs: 4,
                    outputs: 3,
                    activation: "sigmoid"
                },
                swarm: activeSwarm
            };

            const data = JSON.stringify(swarmModel, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `swarm_gen${state.generation}_size${activeSwarm.length}.json`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('üêù Enjambre Exportado:', swarmModel);
            alert(`üêù Enjambre Exportado!\n${activeSwarm.length} Agentes Inteligentes.`);
        };


        window.uploadJSON = () => {
            const file = document.getElementById('uploadFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);

                    // Detectar formato: nuevo (con rawData) o viejo
                    const isNewFormat = data.manifest && data.rawData;

                    if (isNewFormat) {
                        // Nuevo formato: Manifiesto v2.1+
                        const raw = data.rawData;
                        state.generation = raw.generation || 1;
                        state.simulationSteps = raw.simulationSteps || 0;

                        // Helper para restaurar criatura
                        const hydrateCreature = (c) => ({
                            ...c,
                            inventory: Array.isArray(c.inventory) ? c.inventory : Array(c.inventory || 0).fill({ type: 'unknown', content: 'recovered' }),
                            output: c.output || [],
                            // Garantizar posiciones v√°lidas
                            x: (c.x !== undefined && !isNaN(c.x)) ? c.x : Math.random() * CONFIG.world.w,
                            y: (c.y !== undefined && !isNaN(c.y)) ? c.y : Math.random() * CONFIG.world.h,
                            vx: (c.vx !== undefined && !isNaN(c.vx)) ? c.vx : (Math.random() - 0.5) * 2,
                            vy: (c.vy !== undefined && !isNaN(c.vy)) ? c.vy : (Math.random() - 0.5) * 2,
                            trail: c.trail || [] // Restaurar o iniciar trail
                        });

                        // Restaurar criaturas desde rawData
                        state.creatures = raw.creatures.map(hydrateCreature);

                        state.resources = [];
                        ensureResources(state.resources);

                        if (data.environment) Object.assign(CONFIG, data.environment);
                        if (raw.globalWave) Object.assign(WAVE_SYSTEM.globalWave, raw.globalWave);
                        if (data.translations) recentTranslations = data.translations;

                        console.log(`üì¶ Manifiesto v${data.manifest.version} cargado`);
                        console.log(data.expression);
                        alert(`‚úì Manifiesto cargado: ${data.manifest.version}\n\nGeneraci√≥n ${state.generation}\n${state.creatures.length} criaturas restauradas`);
                    } else {
                        // Formato viejo: compatibilidad hacia atr√°s
                        state.generation = data.generation || 1;
                        state.simulationSteps = data.simulationSteps || 0;

                        // Aplicar misma hidrataci√≥n para formato legacy
                        const rawCreatures = data.creatures || [];
                        const hydrateLegacy = (c) => ({
                            ...c,
                            inventory: Array.isArray(c.inventory) ? c.inventory : Array(c.inventory || 0).fill({ type: 'unknown', content: 'recovered' }),
                            x: (c.x !== undefined && !isNaN(c.x)) ? c.x : Math.random() * CONFIG.world.w,
                            y: (c.y !== undefined && !isNaN(c.y)) ? c.y : Math.random() * CONFIG.world.h,
                            vx: (c.vx !== undefined && !isNaN(c.vx)) ? c.vx : (Math.random() - 0.5) * 2,
                            vy: (c.vy !== undefined && !isNaN(c.vy)) ? c.vy : (Math.random() - 0.5) * 2,
                            trail: c.trail || []
                        });

                        state.creatures = rawCreatures.map(hydrateLegacy);
                        state.resources = data.resources || [];

                        if (data.config) Object.assign(CONFIG, data.config);
                        if (data.waveSystem?.globalWave) Object.assign(WAVE_SYSTEM.globalWave, data.waveSystem.globalWave);
                        if (data.recentTranslations) recentTranslations = data.recentTranslations;

                        console.log(`üì¶ Brain cargado: v${data.version || '1.0'}`);
                        alert('‚úì Brain cargado (formato legacy)\nPosiciones regeneradas si faltaban.');
                    }

                    draw();
                } catch (err) {
                    console.error(err);
                    alert('‚úó Error al cargar: ' + err.message);
                }
            };
            reader.readAsText(file);
        };

        // ==================== START ====================
        initializePopulation();
        animate();
        updateCreatureList();
        updateInspectorPanel();
        lucide.createIcons();
        updateEnvironmentIndicator();
        console.log('‚úì BrainFactory v2.0 cargado!');
        console.log('üß¨ Sistema de Herencia: Activo');
        console.log('üì° Sistema de Ondas: Activo');
        console.log('üó£Ô∏è Traductores Sociales: Activos');
        console.log('üéõÔ∏è Usa los controles para ajustar el ambiente en tiempo real');

    </script>

    <!-- HELP MODAL -->
    <!-- Added onclick to close when clicking the background -->
    <div id="help-modal" onclick="if(event.target === this) toggleHelpModal()"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <!-- Added onclick stopPropagation to prevent closing when clicking inside -->
        <div onclick="event.stopPropagation()"
            class="bg-slate-900 border border-blue-500/50 rounded-xl max-w-2xl w-full shadow-2xl p-6 relative animate-in fade-in zoom-in duration-300">
            <button onclick="toggleHelpModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-2xl font-bold text-blue-400 mb-4 flex items-center gap-2">
                <i data-lucide="settings-2" class="w-6 h-6"></i>
                Gu√≠a de Par√°metros
            </h2>
            <div
                class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                <div class="space-y-3">
                    <div
                        class="p-3 bg-slate-800 rounded border border-slate-700 hover:border-slate-600 transition-colors">
                        <div class="text-blue-300 font-bold mb-1">üë• Poblaci√≥n (300)</div>
                        <p class="text-gray-400">Cantidad base de criaturas.</p>
                        <div class="mt-1 text-xs text-green-400">‚Üë Sube: Mayor diversidad, m√°s lento.</div>
                        <div class="text-xs text-red-400">‚Üì Baja: Extinci√≥n r√°pida, menos social.</div>
                    </div>
                    <div
                        class="p-3 bg-slate-800 rounded border border-slate-700 hover:border-slate-600 transition-colors">
                        <div class="text-purple-300 font-bold mb-1">ü¶† Virus (cada 3500)</div>
                        <p class="text-gray-400">Frecuencia de ataques virales.</p>
                        <div class="mt-1 text-xs text-green-400">‚Üë Sube: Mundo m√°s seguro y estable.</div>
                        <div class="text-xs text-red-400">‚Üì Baja: Caos constante, corrupci√≥n alta.</div>
                    </div>
                    <div
                        class="p-3 bg-slate-800 rounded border border-slate-700 hover:border-slate-600 transition-colors">
                        <div class="text-amber-300 font-bold mb-1">‚ö° Desastres (cada 1100)</div>
                        <p class="text-gray-400">Cat√°strofes evolutivas que limpian d√©biles.</p>
                        <div class="mt-1 text-xs text-green-400">‚Üë Sube: Poblaci√≥n crece sin control.</div>
                        <div class="text-xs text-red-400">‚Üì Baja: Selecci√≥n natural brutal.</div>
                    </div>
                </div>
                <div class="space-y-3">
                    <div
                        class="p-3 bg-slate-800 rounded border border-slate-700 hover:border-slate-600 transition-colors">
                        <div class="text-pink-300 font-bold mb-1">üé≤ Eventos (cada 150)</div>
                        <p class="text-gray-400">Eventos aleatorios (lluvia recursos, becas, etc).</p>
                        <div class="mt-1 text-xs text-green-400">‚Üë Sube: Menos sorpresas.</div>
                        <div class="text-xs text-red-400">‚Üì Baja: Ambiente muy din√°mico.</div>
                    </div>
                    <div
                        class="p-3 bg-slate-800 rounded border border-slate-700 hover:border-slate-600 transition-colors">
                        <div class="text-green-300 font-bold mb-1">ü§ù Cooperativismo (Alto)</div>
                        <p class="text-gray-400">Tendencia a compartir y traducir.</p>
                        <div class="mt-1 text-xs text-gray-400">Configurado en "Alto" para fomentar complejidad social y
                            ondas fuertes.</div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex flex-col items-center gap-4">
                <div class="text-gray-500 text-xs text-balance text-center">
                    Modifica estos valores en el c√≥digo o usa los sliders (donde disponibles) para experimentar con el
                    equilibrio del sistema.
                </div>
                <button onclick="toggleHelpModal()" class="btn btn-primary px-8 py-2 rounded-lg font-bold">
                    Entendido, Cerrar
                </button>
            </div>
        </div>
    </div>
    <script>
        function toggleHelpModal() {
            const m = document.getElementById('help-modal');
            m.classList.toggle('hidden');
        }
    </script>
</body>

</html>